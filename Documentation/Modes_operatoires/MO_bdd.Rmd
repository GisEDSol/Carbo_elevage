---
title: "Prise en main pour exploiter la base de données"
author: "Jean-Baptiste Paroissien"
date: "20/02/2017"
output:
  github_document:
    dev: png
    fig_height: 10
    fig_width: 10
    md_extensions: +autolink_bare_uris+hard_line_breaks+header_attributes+line_blocks+table_captions
    toc: yes
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '2'
---

```{r, tidy=FALSE,eval=TRUE,echo=FALSE}
mo_url <- "https://forge.orleans.inra.fr/projects/infosol/repository/entry/Modes_operatoires/"
pro_url <- "https://forge.orleans.inra.fr/projects/infosol/repository/entry/Procedure/"
```

# Objectif et domaine d'application

L'objectif de ce document est de fournir les informations nécessaires pour pouvoir utiliser la base de données sur les sols et l'élevage. Le document présente l'organisation des données et les explications pour son exploitation.

# L'architecture et l'organisation de la base de données

## Architecture technique

L'ensemble des données est stocké dans une base de données type postgresql/postgis. Le serveur de la base est en local et des conversions seront réalisées régulièrement vers une base SQLite/Spatialite pour faciliter le partage des données. SQLite diffère de la plupart des systèmes de gestion de base de données par la gestion d'un fichier de base directement sur le disque dur. A la différence de postgresql/postgis, il ne nécessit pas la création d'un serveur, ce qui facilite les échanges. Plus d'infos, [ici](http://www.developpez.com/actu/94614/Un-developpeur-evoque-cinq-raisons-pour-vous-faire-utiliser-SQLite-en-2016-que-pensez-vous-de-ses-arguments/).

## Organisation de la base de données

Deux types de données sont intégrées dans la base : les données brutes et les données élaborées

### Les données brutes

Elles proviennent de différentes sources et représentent des données qui ne sont pas directement exploitables pour des traitements statistiques ou de la cartographie. Elles sont stockées dans des schémas portant le nom de leur thématique associées (voir tableau ci-dessous). Ces données sont traitées et stockées dans des data marts.

```{r,evaL=TRUE,echo=FALSE}
metatable <- read.csv(paste(repmetadonnees,"Catalogue_schema.csv",sep=""),sep=";")
pander(metatable[metatable$Type %in% "Brute",][,c("Schéma","Description")],caption = "Liste des schémas de la base de données")
```
### Les data marts

Les data marts (magasins de données) sont les données qui sont directement utilisables dans des traitements. Ces data marts se présentent sous la forme d'une ou plusieurs tables classées dans des schémas distincts. Le nom de ces schémas est préfixé par « dm_». Le tableau suivant dresse la liste des data marts disponibles :

```{r,evaL=TRUE,echo=FALSE}
metatable <- read.csv(paste(repmetadonnees,"Catalogue_schema.csv",sep=""),sep=";")
pander(metatable[metatable$Type %in% "Data_mart",][,c("Schéma","Description")],caption = "Liste des schémas de la base de données")
```

# Connexion à la base de données

Deux formats de bases de données sont proposés:

- SQLite/Spatialite
- PostgreSQL/PostGIS

## Format sqlLite/SpatiaLite

## Format PostgreSQL/PostGIS

Pour vous connecter à Dela, vous avez besoin :
 
- Installer un client PostgreSQL à jour ([PgAdminIII](https://www.pgadmin.org/) par exemple)
- Utiliser les paramètres de connexion suivants :
	- Hôte : 
	- Port TCP : 5432
	- Base : 
	- Nom d'utilisateur : 
	- Mot de passe : 

### Connexion ODBC

Dans la suite, le mode opératoire est proposé pour un système linux. Pour un système basé sous windows, le lecteur intéressé peut consulter la page [suivante](http://informatique-mia.inra.fr/r4ciam/ODBC.html).

Les connexions odbc sont configurées dans le fichier `odbc.ini` présent dans l'arborescence du système `\etc\odbc.ini`. Pour configurer une connexion, une modification de ce fichier est nécessaire. Tapez dans un terminal `sudo gedit \etc\odbc.ini` puis apporter les modifications nécessaires. 

Voici ci-dessous les différents paramètres de connexions relatifs aux différents alias présentés précédemment. Vous pouvez directement copier ces lignes vers le fichier `\etc\odbc.ini` en remplaçant nomutilisateur_ldap et mdp_ldap par votre nom d'utilisateur et votre mot de passe LDAP.

- Database : Nom de la base de données
- Servername : Nom du serveur
- Username : Nom d'utilisateur
- Password : Mot de passe
- Port : Port de la base de données

```{r, tidy=FALSE,eval=FALSE}
[ODBC]
InstallDir = /usr/lib

[solelevage]
Driver = /usr/lib/x86_64-linux-gnu/odbc/psqlodbcw.so
Database = sol_elevage
Servername = localhost
Username = jb	
Password = ******
Port=5432
Protocol = 8.1
ReadOnly = 0
```
Les connexions ODBC dans R sont possibles avec le paquet `RODBC`. Pour l'installer, tapez la commande suivante dans un terminal R : `install.packages("RODBC")`.
Ensuite, vous pouvez utiliser l'alias des paramètres de connexions du fichier `odbc.ini` dans la fonction décrivant les paramètres de connexion `odbcConnect`. Pour vérifier les modifications apportées au fichier de configuration `odbc.ini`, vous pouvez lancer les lignes de commandes suivantes dans le logiciel R.

```{r, tidy=FALSE,eval=FALSE}
library(RODBC)
loc <- odbcConnect("sol_elevage",case="postgresql", believeNRows=FALSE)
```

# Données disponibles

# Documentation de la base de données

La documentation de l'entrepôt de données s'articule autours de différents types de documents. Un document de cadrage général décrit le projet de développement de l'entrepôt dans sa globalité (architecture, modèles de données, métadonnées, documentation disponible, etc.). Pour chaque Data Mart il existe une fiche d'indicateur qui lui est propre. Cette fiche est utilisée pour l'analyse des besoins et sert aussi de document qualité décrivant le data mart une fois que celui-ci est mis en œuvre. La fiche d'indicateur décrit ainsi la raison d'être du data mart et la façon dont il a été construit. Enfin, trois documents d'orientation présentent les procédures adaptées aux différents types d'utilisateurs de l'entrepôt de données :
- les administrateurs de l'entrepôt,
- les développeurs des nouveaux jeux de données,
- les utilisateurs des données de l'entrepôt.

Ces documents sont présents sur la forge logicielle de l'unité InfoSol à l'adresse suivante : forge, projet "Entrepôt de données". Le document de cadrage et les fiches d'indicateur sont accessibles via l'onglet « Documents » tandis que les fichiers de procédure sont accessibles via l'onglet « Wiki ».

# Les métadonnées des tables




# Configuration des connexions
## Installation des paquets système
Voici les commandes à reproduire pour installer les paquets relatifs à la gestion du versionnement des fichiers (subversion), aux connexions ODBC et ssh.
```{r, tidy=FALSE,eval=FALSE}
sudo su -

# Mise à jour des paquets
apt-get update
apt-get upgrade -y

# Installation des paquets 
apt-get install -y subversion unixODBC odbc-postgresql unixODBC-dev dos2unix

```


