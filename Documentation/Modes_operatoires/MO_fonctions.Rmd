---
title: "Mode opératoire pour la création d'une fonction R"
author: "Jean-Baptiste Paroissien"
date: "15/09/2014"
output:
  html_document:
    fig_caption: yes
    highlight: zenburn
    number_sections: yes
    theme: spacelab
    toc: yes
categories: [Raster]
rerCat: Raster
tags: [Création d'une fonction R]
---
```{r, tidy=FALSE,eval=TRUE,echo=FALSE}
mo_url <- "https://forge.orleans.inra.fr/projects/infosol/repository/entry/Modes_operatoires/"
pro_url <- "https://forge.orleans.inra.fr/projects/infosol/repository/entry/Procedure/"
tmp_url <- "https://forge.orleans.inra.fr/projects/infosol/repository/entry/Template/"
```
# Objectif et domaine d'application

Ce document présente le modèle d'écriture d'une fonction R. Il s'adresse aux producteurs de webservices cartographiques ayant besoin d'écrire des fonctions R ou à tout autre personne souhaitant automatiser son code à travers des fonctions R. Voici les caractéristiques principales de ce mode opératoire :

| Type utilisateur | Systèmes d'exploitation | Langages                                                                                |
|------------------|-------------------------|-----------------------------------------------------------------------------------------|
| Producteurs      | Linux & Windows         | R et le paquet [roxygen2](http://cran.r-project.org/web/packages/roxygen2/roxygen2.pdf) |

# Démarche générale

L'utilisation d'un modèle pour l'écriture des fonctions R permet de mettre en place rapidement une documentation associée à la fonction. Le modèle est présenté ci-dessous et est disponible dans le dépôt de l'équipe traitement : 

  - [traitement-infosol/outils_traitement/trunk/scripts/R/templateR.R](https://forge.orleans.inra.fr/projects/traitement-infosol/repository/entry/outils_traitement/trunk/scripts/R).
  
**Important :** Il est vivement conseillé de l'utiliser pour assurer la diffusion et le partage des scripts.

## Modèle pour l'écriture d'une fonction
Le modèle de documentation est fondé sur la syntaxe du paquet R [roxygen2](http://cran.r-project.org/web/packages/roxygen2/roxygen2.pdf). En en-tête de chaque fonction, les balises suivies d'un "@" permettent de décrire le script de la manière suivante :

| Nom balise  | Description                                          |
|-------------|------------------------------------------------------|
| @titre      | Nom de la fonction                                   |
| @description| Description approfondie en une phrase de la fonction |
| @param      | Description des paramètres de la fonction            |
| @author     | Nom des auteurs et email (exemple nom.prenom@@orleans.inra.fr) |
| @references | Références bibliographiques                          |
| @details    | Détails sur l'utilisation de la fonction             |
| @keywords   | Mots clés pour caractériser la fonction              |
| @returns    | Type de retour de la fonction                        |
| @seealso    | Renvois vers une autre fonction                      |
| @note       | Notes et/ou recommandations                          |
| @examples   | Exemples de la fonction                              |

Aucune langue n'est imposée pour la création d'une documentation. Le choix de la langue est fait selon le bon vouloir de l'auteur du script.

```{r, tidy=FALSE,eval=FALSE}
#' @title Nom de la fonction
#'
#' @description  Description approfondie en une phrase de la fonctions
#'
#' @param nomduparamètre1 : type : Description du paramètre 1 de la fonction
#' @param nomduparamètre2 : type : Description du paramètre 2 de la fonction
#' @author Prénom(s) Nom(s) \email{prenom.nom@@orleans.inra.fr}
#' @references D'éventuelles références bibliographiques \url{http://www.inra.fr/}
#' @details Des détails sur l'utilisation de la fonction 
#' @keywords Des mots clés
#' @return Caractéristiques de la sortie de la fonction
#' @seealso D'éventuels renvois vers d’autres fonctions ou méthodes...
#' @note D'éventuelles notes et/ou recommandations
#' @examples
#' Un ou plusieurs exemples qui fonctionnent
#' print("hello world")

# Début de la fonction
templateR <- function(nomduparametre1,
  	     nomduparamètre2)
{
	print(paste(nomduparametre1,nomduparametre2,sep=" "))
}
#fin de la fonction
```

## Création d'un paquet et d'une documentation associée

### Création du paquet
La création d'un paquet R peut se révéler pratique lorsqu'un ensemble de fonction portant sur un même thème est utilisée. Le partage ainsi que la documentation associée aux différentes fonctions...


La création d'un paquet est réalisée avec la fonction `package.skeleton` présente par défaut dans R. Les principaux arguments de la fonction sont présentés dans le tableau ci-dessous. Pour plus de détails, vous pouvez également consulter l'[aide](http://stat.ethz.ch/R-manual/R-patched/library/utils/html/package.skeleton.html) d'utilisation de la fonction.

| Nom argument | Description                                   |
|--------------|-----------------------------------------------|
| name         | Nom du paquet créé                            |
| code_files   | List des fonctions R à inclure dans le paquet |
| path         | Répertoire où sera créé le paquet             |

Voici un exemple d'utilisation de la fonction `package.skeleton` pour empaqueter les fonctions présentes dans le fichier "rastertopostgis.R"
```{r, tidy=FALSE,eval=FALSE}
package.skeleton("rtopostgis",code_files=("/home/jb/Bureau/Scripts/svn/dev/equipe_traitement/webservices/trunk/Fonctions/R/rtopostgis/rtopostgis.R"),path=)
```

### Création de la documentation

La génération de la documentation associée aux fonctions empaqueter est réalisée avec le paquet R `roxygen2` et la fonction `roxygenize`. L'utilisation de la fonction est simple. Vous devez lancer la fonction dans le même répertoire où vient d'être créé le paquet et donner le nom du paquet précédemment créé. Dans notre exemple, celà donne :

```{r, tidy=FALSE,eval=FALSE}
roxygenize("rtopostgis")
```

**Important :** La fonction s'appuie sur les en-têtes avec les balises précédemment décrites.

Une fois la documentation générée, vous pouvez construire le paquet avec les fonctions de base R. Ces fonctions ne sont pas lancées dans une session R mais dans un terminal linux avec la commande `R CMD`. Un exemple est présente la procédure :

- R CMD check vérifie la cohérence des fichiers précédemment créés
- R CMD build construit le paquet

```{r, tidy=FALSE,eval=FALSE}
R CMD check rtopostgis
R CMD build rtopostgis
```

## Stockage des fonctions R dans le dépôt du projet webservice

Pour le moment, les fonctions sont stockées dans le répertoire "Fonctions" du dépôt du projet webservices : 

  - [/traitement-infosol/webservices/trunk/Fonctions/R/nomdelafonction](https://forge.orleans.inra.fr/projects/traitement-infosol/repository/show/webservices/trunk/Fonctions/R)
  
## Utilisation de la fonction ou du paquet

Ici, on décrit la manière d'utiliser soit la fonction, soit le paquet.
  
