---
title: "Analyse des teneurs en carbone organique de la BDAT entre 1995-2014. Etat des lieux et analyse des évolutions en lien avec l'élevage"
author: "Jean-Baptiste Paroissien"
date: "19/04/2017"
output:
  html_document:
    toc: yes
    toc_float: yes
    fig_caption: yes
    highlight: kate
    number_sections: yes
    theme: spacelab   
---

```{r setup, include=FALSE,warning=FALSE,echo=FALSE,message=FALSE,eval=TRUE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/Data/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
repsortie <- paste(repmaster,"Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers

set.seed(157) #Pour la reproductibilité
cl <- makeCluster(4);registerDoParallel(cl) #Configuration pour le calcul en parallèle
```
```{r date, include=FALSE,warning=FALSE,echo=FALSE,message=FALSE,eval=TRUE}
date <- Sys.Date()
sessionInfo()
```

```{r, tidy=FALSE,eval=TRUE,echo=FALSE}
mo_url <- "https://github.com/GisEDSol/Carbo_elevage/tree/master/Documentation/Modes_operatoires/"
fs_url <- "https://github.com/GisEDSol/Carbo_elevage/tree/master/Fichiers_suivis/"
raw_mo_url <- "https://rawgit.com/GisEDSol/Carbo_elevage/master/Documentation/Modes_operatoires/"
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE}
# Jeu de données sur 4 périodes de temps
bdat9514 <- sqlQuery(loc,paste("select * from dm_vecteurs.canton_9514",sep=""))
melted.9514 <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdat_9514"),stringsAsFactors=TRUE,as.is=TRUE)
melted.9514$value <- as.numeric(melted.9514$value)
melted.9514 <- melted.9514[complete.cases(melted.9514$value),]
melted.9514$annees <- factor(melted.9514$annees,levels=c("9599","0004","0509","1014"))

# Sélection des teneurs mesurées avec la méthode OX (médiane)
melted.9514 <- melted.9514[melted.9514$variable %in% c("corgox","corgox_ddec","corgox_dqua","corgox_pdec","corgox_pqua"),]#,eff_corgox 
# Changement du nom des tables pour l'exploitation rapide dans le fichier de suivi
dcast.bdat <- bdat9514
melted.bdat <- melted.9514 

# Sélection uniquement des médianes et du 90 centile
melted.bdat <- melted.bdat[melted.bdat$variable %in% c("corgox","corgox_dqua"),]
melted.bdat$variable <- ordered(melted.bdat$variable, levels = c("corgox","corgox_dqua"))
levels(melted.bdat$variable) <- c("Médiane","75% centile")
```

# Objectifs

Synthétiser les résultats et les présenter de la manière à construire un article

# Matériel et méthodes

## Cartographie des principaux facteurs explicatifs

Voir si c'est pertinent, plutôt rajouter un tableau synthétique

## Cartographie des principales régions d'élevage


Dans la présentation des régions d'élevage, on précisera que l'on travaille uniquement avec un nombre défini de régions. Il faudra définir correctement le critère de sélection de ces régions.

```{r,highlight=TRUE,eval=FALSE,echo=FALSE}
tablecarto <- "dm_vecteurs.canton" 
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" 
variablecarto <- "zonage_cplt" #variable à spatialiser
l_legend <- "Principales régions d'élevage"#label de la variable
nclasse <- 13 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
nomfichier <- "reg_elevage_cplt"
code_regelevage <- read.csv(paste(repmetadonnees,"Nomenclature_regionelevage.csv",sep=""))

couleur <- as.character(code_regelevage$Code_couleur)
carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_legend,repsortie,nomfichier,title="",caption="",dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=3,position="bottom",ggsaveheight=7,ggsavewidth=10)
```

```{r, echo = F, results = 'asis',warning=FALSE,error=FALSE,message=FALSE}
# Pour insérer l'image
fichiers <- paste(repsortie,"reg_elevage_cplt.png",sep="")
cat(paste("![](",fichiers,")",sep=""))
```

```{r ,highlight=TRUE,echo=FALSE,eval=TRUE,results = 'asis',warning=FALSE,message=FALSE}
p <- list()
for(i in levels(as.factor(melted.bdat$zonage_cplt))){
  melted.test <- melted.bdat[melted.bdat$zonage_cplt %in% i & melted.bdat$variable %in% "Médiane",]
  p[[i]] <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],length))[1,1]
}
regelevage_nbranalyses <- as.data.frame(melt(p))
colnames(regelevage_nbranalyses) <- c("Nbr","Region_elevage")

pander(regelevage_nbranalyses[,c("Region_elevage","Nbr")],caption="Nombre de canton possédant des analyses par type de région d'élevage")
```

Le tableau ci-dessus présente le nombre de canton ayant des analyses en teneurs en CO par type de région d'élevage. Les régions d'élevages où le nombre de canton est inférieur à 50 sont éliminées. Il reste donc les régions suivants :

- A : Zones de grandes cultures ou sans élevage
- B1 : Zone de polyculture-élevage du Bassin Aquitain & Rhône-Alpes & Alsace
- B2 : Zone de polyculture-élevage du Bassin Parisien
- C1 : Zone intensive du Grand Ouest (zone laitière avec alternatives à l’élevage)
- D : Zone herbagère du Nord-Ouest
- E1 : Zone herbagère du Nord-Est (de tradition laitière)
- E2 : Zone herbagère du Nord Massif-Central (de tradition allaitante)

Parmi les strates restantes, la variabilité dans le nombre d'analyse est importante, passant de 163 pour le type 1 à 722 pour le type 3. 


# Résultats

# Statistiques descriptives

## Echelle de la France

La figure XX présente les courbes de fréquences cumulées des teneurs en carbone organique distribuées pour les 4 périodes. Les courbes de fréquences présentent la même forme en "S" et s'individualisent juste avant le plateau, présentant une différence affectant les sols riches en teneurs organiques (entre 17 et 45 g/kg). Sur cette zone (figure à droite), la figure montre un décalage des courbes des périodes 2000-2004, 2005-2009 et 2010-2014 vers des valeurs plus faibles. Parmi ces 3 périodes, la période 2005-2009 est celle qui se décale le plus vers des teneurs plus faible tandis que la période 2010-2014 se rapproche des valeurs de 1995-1999, présentant ainsi une inversion de la tendance observée. Ces observations mettent en évidence une diminution des teneurs en carbone entre les périodes 1990-1999 et 2000-2009 et une légère augmentation pour la période 2010-2014. 

```{r cdf_fr,highlight=TRUE,echo=FALSE,eval=FALSE,warning=FALSE,error=FALSE,fig.height=5, fig.width=7,fig.cap = fig$cap("cdf_fr","Courbe de fréquences cumulées"),fig.align="center"}
period <- c("9599","0004","0509","1014")
xlabel <- "Carbone organique (g/kg)"
ylabel <- "Fréquence"
nperiod <- length(period)
colors <- brewer.pal(nperiod,"Set1")

p <- list()
# Courbe de fréquence cumulée
p[[1]] <- ggplot(melted.bdat[melted.bdat$variable %in% "Médiane",], aes(x=value))+
       stat_ecdf(aes(colour=annees))+
       scale_color_manual(values=colors, 
                          name="Périodes")+
       scale_x_continuous(xlabel)+scale_y_continuous(ylabel)+
       theme_perso()

#ggsave(p[[1]],file = paste(repsortie,"cdf_fr1.png",sep=""), width = 9, height = 7)  
p[[2]] <- ggplot(melted.bdat[melted.bdat$variable %in% "Médiane" & (melted.bdat$value > 17) & (melted.bdat$value < 45) ,], aes(x=value))+
       stat_ecdf(aes(colour=annees))+
       scale_color_manual(values=colors, 
                          name="Périodes")+
       scale_x_continuous(xlabel)+scale_y_continuous(ylabel)+
       theme_perso()

tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=1,ncol=2,position="bottom")))
#ggsave(tt,file = paste(repsortie,"cdf_fr.pdf",sep=""), width = 10, height = 7)  
```

```{r summarybdatfrancetable,highlight=TRUE,echo=FALSE,eval=TRUE,results = 'asis',warning=FALSE,message=FALSE}

bdatsummarystats <- list()
for(i in levels(as.factor(melted.bdat$variable))){
  melted.test <- melted.bdat[melted.bdat$variable %in% i,]
  # Résumé des statistiques 
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  bdatsummarystats[[i]] <- bdatsummary
}

pander(bdatsummarystats["Médiane"][[1]],caption = "Statistiques descriptives des teneurs en carbone organique pour les différentes périodes")

pander(bdatsummarystats["75% centile"][[1]],caption = "Statistiques descriptives des teneurs en carbone organique pour les différentes périodes")
```

Le résumé des statistiques des teneurs en carbone organique (table XX) confirme ces observations. La période 2000-2004 montre la valeur médiane la plus faible avec une valeur de `r bdatsummarystats$Médiane$value["0004","Median"]` g/kg. Les valeurs les plus importantes sont observées pour les périodes 1995-1999 et 2010-2014 avec des médianes de teneurs en carbone organique équivalente, à `r bdatsummarystats$Médiane$value["9599","Median"]` g/kg. Ces évolutions sont très légèrement marquées sur la figure XX où l'évolution moyenne des teneurs en carbone organique baisse légèrement après la période 1995-1999.



## Analyse par région d'élevage

Les statistiques des teneurs en carbone organique par région d'élevage montrent que les évolutions observées à l'échelle de la France se retrouvent de manière similaires aux niveaux des différentes régions. Ces évolutions ne sont pas toujours significatives seules les régions A, B1, B2, C1 et E1 présentent des évolutions significatives. 
Dans ces régions, la tendance nationale observée de la baisse puis de l'augmentation des teneurs en carbone organique se retrouve. Seule la région C1 (Zone intensive du Grand Ouest (zone laitière avec alternatives à l'élevage)) présente une évolution différente, avec une augmentation puis une diminution des teneurs en CO. Cette diminution observée entre les périodes 2005-2009 et 2010-2014 est significative.

```{r boxplot_reg_elevagezoom,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.align="center"}
# Lecture de la table des couleurs
code_regelevage <- read.csv(paste(repmetadonnees,"Nomenclature_regionelevage.csv",sep=""))
period <- c("9599","0004","0509","1014")
reg_elevage <- c("A","B1","B2","C1","C2","D","E1","E2","F2")
couleur <- as.character(code_regelevage[code_regelevage$Zonage_cplt %in% reg_elevage,"Code_couleur"])

melted.bdat_regelevage <- melted.bdat[complete.cases(melted.bdat$zonage_cplt) & (melted.bdat$zonage_cplt %in% reg_elevage) & melted.bdat$variable %in% "Médiane",]

wilcotest <- generate_label_df(db=melted.bdat_regelevage,value="value",lev="zonage_cplt",letters,position=1)

p <- ggplot(melted.bdat_regelevage) +
            geom_boxplot(aes(x=zonage_cplt,y=value,fill=zonage_cplt))+
            scale_fill_manual(values=couleur,name="") + scale_x_discrete("Grandes régions d'élevage")+scale_y_continuous("Teneur en carbone organique (g/kg)")+ theme_perso("") + geom_text(data = wilcotest, vjust=-0.75,aes(x = plot.labels, y = V1, label = labels))
            
p 
ggsave(p,file = paste(repsortie,"boxplotbdat_zonage_cplt.png",sep=""), width = 12, height = 6)  
```

```{r,highlight=TRUE,eval=FALSE,message=FALSE,echo=FALSE}
# REVOIR,Ici, voir pour rajouter année+zonage_simple ou année+climato ou année+région
bdatsummary_regelevage <- apply(melted.bdat["value"],2, function(x) tapply(x, list(melted.bdat[,"zonage_simple"],melted.bdat[,"annees"]),summary))
bdatsummary_regelevage <- data.frame(bdatsummary_regelevage[[1]])
bdatsummary_regelevage <- lapply(bdatsummary_regelevage, do.call, what = rbind)
names(bdatsummary_regelevage) <- period
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=8, fig.width=12,fig.align="center",warning=FALSE,message=FALSE}

reg_elevage <- c("A","B1","B2","C1","C2","D","E1","E2","F2")
p <- list()
cpt <- 0
for(i in reg_elevage){
  cpt <- cpt + 1
  datatest <- melted.bdat[melted.bdat$zonage_cplt %in% i,]
  datatestobs <- datatest[datatest$variable %in% "Médiane",]
  nbrobservation <- apply(datatestobs["value"],2, function(x) tapply(x, datatestobs["annees"],length))[1,1]

  ylim1 <- c(min(datatest$value,na.rm=TRUE),quantile(datatest$value,0.99,na.rm=TRUE))

  test1 <- generate_label_df(db=datatest[datatest$variable %in% "Médiane",],value="value",lev="annees",letters,position=0.99)
  test2 <- generate_label_df(db=datatest[datatest$variable %in% "75% centile",],value="value",lev="annees",LETTERS,position=0.98)

if(cpt==4){
  labley <- "Teneur en carbone organique (g/kg)"
}else{labley <- ""}

  if(cpt==8){
  lablex <- "Périodes"
}else{lablex <- ""}

  p[[i]] <- ggplot(datatest,aes(x=annees,y=value)) + 
            geom_boxplot(aes(fill=variable),outlier.shape = NA,outlier.size=NA)+
            stat_summary(fun.y=median, geom="line",size = 1, aes(group=variable)) +
            scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso()+geom_text(data = test1,aes(x = plot.labels, y = V1, label = labels),hjust = 2,inherit.aes = FALSE)+ geom_text(data = test2, aes(x = plot.labels, y = V1, label = labels),hjust = -2,inherit.aes = FALSE)+ coord_cartesian(ylim = ylim1*1.2) + labs(title= paste(i,". Nbr: ",nbrobservation,sep="")) +
            scale_fill_manual(values=c("#F1ED0AE6", "#F36E15E6"), 
                       name="Statistiques cantonales")
}
tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=3,ncol=3,position="bottom")))
ggsave(tt,file = paste(repsortie,"boxplot_regelevage_stats.png",sep=""), width = 17, height = 10)  


panderOptions('knitr.auto.asis', FALSE)
p <- list()
for(i in levels(as.factor(melted.bdat_regelevage$zonage_cplt))){
  melted.test <- melted.bdat_regelevage[melted.bdat_regelevage$zonage_cplt%in% i,]   
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  nbrobservation <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],length))[1,1]
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  #pander(bdatsummary[[1]],caption = paste("Statistiques descriptives des teneurs en carbone organique pour le type de climat ",i,". Nombre de canton analysé : ",nbrobservation,sep=""))
}
```

# Distribution spatiale des teneurs en carbone organique

La distribution spatiale de la médiane et du troisième quartile des teneurs en CO par canton (figure XX) montre une distribution spatiale organisée recoupée essentiellement sur la lithologie. Les fortes teneurs en carbone organique sont présentes dans les zones de socles et de piemonds et les valeurs plus faibles dans les principaux bassins sédimentaires (parisien et aquitain). Les tendances entre les périodes ne sont pas clairement identifiables. Certaines régions se distinguent, notamment le haut de france avec une diminution visible des teneurs en CO. A l'inverse, le Morbihan affiche une augmentation des teneurs en CO localisée durant la période 2005-2009.

```{r ,highlight=TRUE,eval=FALSE,echo=FALSE}
tablecarto <- "dm_vecteurs.canton_9514" #Nom de la table utilisée pour la cartographie (table postgis)
period <- c("9599","0004","0509","1014") #
stats <- c("pdec","pqua","med","dqua","ddec")
for(i in c("med","dqua")){
  if(i=="med"){variablecarto <- paste("corgox",period,sep="")}else{variablecarto <- paste("corgox_",i,period,sep="")}
  #variables à cartographier
  nclasse <- 5 
  style_classe <- "quantile"#Nombre de classes de valeurs pour la cartographie
  couleur <- viridis(nclasse)
  #couleur <- brewer.pal(nclasse,"YlOrRd") #Nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
  l_variable <- "Teneur en carbone organique (g/kg)" #label de la variable
  nomfichier <- paste("corgox_period_",i,sep="") #Nom du fichier
  titleperiod <- c("1995-1999","2000-2004","2005-2009","2010-2014")
  title <- paste(i,"_",titleperiod,sep="")
  
  carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_variable,repsortie,nomfichier,title=title,caption="",dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=2,position="bottom",ggsaveheight=7,ggsavewidth=6.27)
}
```

```{r carto_c_fr, echo = F, results = 'asis'}
# Pour insérer l'image
stats <- c("med","dqua")
fichiers <- paste(repsortie,"corgox_period_",stats,".png",sep="")
cat(paste("![](",fichiers,")",sep=""))
```

# Analyse des facteurs contrôlant la distribution spatiale des teneurs en CO

Présentation des résultats de modélisation de Cubist uniquement ?

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE,error=FALSE}
Rcovarclimato <- c("hpluie_an","jfroids_an","ampli_t_juil_janv","pluie_ecart_janv","pluie_ecart_juil","jpluie_janv","jpluie_juil","ttemp_an","jchauds_an")
typeclimato <- replicate(length(Rcovarclimato), "climat")

Rcovartopo <- "altimean"
typetopo <- replicate(length(Rcovartopo), "topographie")

Rcovarpedo <- c("argi_med","sabt_med","mat11")
typepedo <- replicate(length(Rcovarpedo), "pedologie")

## Construction des variables occupation du sol en fonction de la période en C étudiée
periodra <- c("1970","1979","1988","2000","2010")
ra_occup <- c("p_sfp","p_prairie","p_sth","p_cop","p_c","p_mf")
ra_otex <- c("polyelevage1988","elevage1988","elevagehorsol1988","ugbta1988","grdcultures1988")
Variay <- c("corgox9599","corgox0004","corgox0509","corgox1014")
indexperiod <- list(1:3,1:4,1:4,1:5)

nbr <- 100
prob <- 0.8
model="cubist"
cpt <- 0

for(i in Variay){
  cpt <- cpt + 1
  ra_occupyears <- apply(expand.grid(ra_occup,periodra[indexperiod[[cpt]]]),1, function(x){paste(x[1],x[2],sep="")})

  # Suppression p_protea1970 (inexistant en 1970!)
  #ra_occupyears <- ra_occupyears[!ra_occupyears %in% "p_protea1970"]

  Rcovaroccup <- c(ra_otex,ra_occupyears)
  typeoccup <- replicate(length(Rcovaroccup), "occup")
  type <- c(typetopo,typepedo,typeoccup,typeclimato)
  Rcovar <- c(Rcovartopo,Rcovarpedo,Rcovaroccup,Rcovarclimato)

  # Construction du vecteur des variables du modèle. 
  vNames <- c(i,Rcovar)

  # Sélection du jeu de données
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]

  trControl <- trainControl(method = "cv",p=prob,number=10)
  tuneGrid <- list(gbm=expand.grid(interaction.depth = c(1, 5, 9),n.trees = (1:10)*150,shrinkage = 0.1,n.minobsinnode = 10),cubist=expand.grid(.committees = c(10,50,100),.neighbors = c(1,5,9)))
    
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]
  datax <- d[,vNames[-1]]
  datay <- d[,vNames[1]]
  
  mcubist_fr <- cv_datamining(datax,datay,nbr=nbr,prob,model,select=1:15,tuneGrid,trControl,repsortie)

  saveRDS(mcubist_fr,file=paste(repsortie,"mcubist_fr_",i,"_",nbr,".rds",sep=""))
}
```

```{r,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,error=FALSE,fig.height=9, fig.width=11,fig.align="center"}

# Ci-dessous, construction des graphiques pour calculer l'importance des variables

Rcovarclimato <- c("hpluie_an","jfroids_an","ampli_t_juil_janv","pluie_ecart_janv","pluie_ecart_juil","jpluie_janv","jpluie_juil","ttemp_an","jchauds_an")
typeclimato <- replicate(length(Rcovarclimato), "climat")

Rcovartopo <- "altimean"
typetopo <- replicate(length(Rcovartopo), "topographie")

Rcovarpedo <- c("argi_med","sabt_med","mat11")
typepedo <- replicate(length(Rcovarpedo), "pedologie")

periodra <- c("1970","1979","1988","2000","2010")
ra_occup <- c("p_sfp","p_prairie","p_sth","p_cop","p_c","p_mf")
ra_otex <- c("polyelevage1988","elevage1988","elevagehorsol1988","ugbta1988","grdcultures1988")
Variay <- c("corgox9599","corgox0004","corgox0509","corgox1014")
indexperiod <- list(1:3,1:4,1:4,1:5)
nbr <- 100

pourcent <- list()
rest <- array(NA, dim = c(length(Variay), 3),list(Period_co = Variay, mod = c("r2","MSE","RMSE")))
cpt <- 0
for(i in Variay){
  cpt <- cpt + 1
  ra_occupyears <- apply(expand.grid(ra_occup,periodra[indexperiod[[cpt]]]),1, function(x){paste(x[1],x[2],sep="")})

  Rcovaroccup <- c(ra_otex,ra_occupyears)
  typeoccup <- replicate(length(Rcovaroccup), "occup")
  type <- c(typetopo,typepedo,typeoccup,typeclimato)
  Rcovar <- c(Rcovartopo,Rcovarpedo,Rcovaroccup,Rcovarclimato)

  varimp <- readRDS(paste(repsortie,"mcubist_fr_",i,"_",nbr,".rds",sep=""))
  qualityindex <- varimp$qualityindex
  varimp <- as.data.frame(varimp$varimp)
  varimp <- varimp[grep("Overall",names(varimp))]

  varimp$median <- apply(varimp, 1, function(x){median(x,na.rm=TRUE)})
  varimp$covariable <- rownames(varimp)
  varimp <- varimp[with(varimp, order(-median)),]
  varimp$covariable <- reorder(varimp$covariable, varimp$median)

  # Selection quantile(test$value,0.75)>40
  varimp$Q75 <- apply(varimp[,!names(varimp) %in% c("relatmed","median","covariable")],1, function(x) quantile(x, probs=0.75))
  varimp40 <- varimp[varimp$Q75>40,]
  varimp40$relatmed <- apply(varimp40[names(varimp40) %in% "median"],2,function(x){(x/sum(x))*100})

  test <- melt(varimp)
  test$type <- gsub2(as.character(Rcovar),type,as.character(test$covariable))
  pp <- list()

  pp[[1]] <- ggplot(test[!test$variable %in% c("relatmed","median","Q75"),],    aes(x=covariable,y=value,fill=type)) + geom_boxplot()+
     scale_x_discrete("Variables")+scale_y_continuous("Importance des variables (%)")+
     coord_flip()+
     geom_hline(yintercept = 40) +
     theme_perso()  

  test2 <- melt(varimp40)
  test2$type <- gsub2(as.character(Rcovar),type,as.character(test2$covariable))
  test2$period <- rep(i,nrow(test2))

  pp[[2]] <- ggplot(test2[!test2$variable %in% c("relatmed","median","Q75"),], aes(x=covariable,y=value,fill=type)) + 
     geom_boxplot()+
     scale_x_discrete("Variables")+scale_y_continuous("Importance des variables (%)")+
     coord_flip()+
     theme_perso()  

  tt <- do.call(grid_arrange_shared_legend,c(pp,list(nrow=1,ncol=2,position="bottom")))
ggsave(tt,file = paste(repsortie,"ImpVariable_cubist_",i,".png",sep=""), width = 11, height = 9)  
 
  pourcent[[i]] <- test2[test2$variable %in% "relatmed",]

  rest[cpt,"r2"] <- qualityindex[,"R2"][[1]]
  rest[cpt,"MSE"] <- qualityindex[,"MSE"][[1]]
  rest[cpt,"RMSE"] <- qualityindex[,"RMSE"][[1]]
}

df <- do.call("rbind",pourcent)
df <- df[complete.cases(df),]
df$period <- factor(df$period,levels=c("corgox9599","corgox0004","corgox0509","corgox1014"))

toto <- ggplot(df,aes(x=period,y=value,fill=type,label=paste(covariable,":",round(value),"%",sep="")))+geom_col(width = 0.7) + geom_text(size = 3, position = position_stack(vjust = 0.5)) + theme_perso() + xlab("")+ylab("Pourcentage d'importance")
ggsave(toto,file = paste(repsortie,"ImpVariable_cubist_fr.png",sep=""), width = 11, height = 9)  
```

Les résultats de la validation croisée de la modélisation des teneurs en CO pour les différentes périodes sont présentés dans le tableau ci-dessous. Sur les 100 répétitions, l'application du modèle sur les 20% du jeu d'apprentissage montre une capacité de prédiction des teneurs en CO équivalente entre les périodes et de bonne qualité. La modélisation des teneurs en CO pour la période 2010-2014 montrent la capacité de prédiction la plus mauvaise avec un coefficient de détermination (R2) de 0.78 et un erreur moyenne (Root Mean Square Error) de 2.4 g/kg. La période 2000-2004 affiche les meilleurs avec un R2 de 0.84 et une erreur moyenne de 2.2 g/kg. En moyenne la modélisation des teneurs en CO toute période confondues affiche donc une capacité d'explication de la variance de plus de 80%.

```{r,eval=TRUE,echo=FALSE,results='asis'}
pander(as.data.frame(rest),caption="Moyenne des indicateurs de la validation croisée pour les différents modèles")
```

La figure ci-dessous présente la proportion d'importance des variables explicatives dans les modèles pour chacune des périodes analysées. Les modèles affichent des proportions similaires. La part des variables d'origine climatique est importante avec une part d'environ 50%. L'occupation du sol arrive en seconde position avec une part allant de 20 à 35%. La topographie et la pédologie représentent de 10 à 14% et 16 à 21%.
Au total, les variables d'origine naturelle contribuent à expliquer les teneurs en CO à plus de 50% des variables du modèle. Les variables anthropiques entre 20 à 35%.

Au sein des variables anthropiques, le pourcentage de prairie dans la SAU et le pourcentage de surface fourragère principales représentent les principales variables explicatives.

> **En conclusion** Ces résultats montrent que la répartition des teneurs en CO de la BDAT à l'échelle de la France est principalement expliquée par des variable d'origine naturelle (pédologique, climatique, et topographique). L'effet de l'occupation du sol apparaît secondaire. Ces résultats concordent avec les premières conclusions du travail de la modélisation avec des régressions linéaires multiples effectuées avec des co-variables naturelles ou d'origines anthropiques. 


# Evolution des teneurs en carbone organique


Ici, présenter le fait que l'analyse à l'échelle de la France est complexe et qu'une stratification est nécessaire pour appréhender les évolutions à l'échelle d'un compartiment pédo-climatique ou d'occupation du sol homogène et cohérent.

```{r ,echo=FALSE,eval=TRUE,results='asis',fig.height=10, fig.width=10,fig.align="center"}
p <- list()
bdatsummarystats <- list()
for(i in levels(as.factor(melted.bdat$variable))){
  melted.test <- melted.bdat[melted.bdat$variable %in% i,]
  # Résumé des statistiques 
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  bdatsummarystats[[i]] <- bdatsummary

  pander(bdatsummary,caption="Stastistiques descriptives des teneurs en CO pour les différentes statistiques aggrégées à l'échelle cantonale")

# Changer le nom des variables (pour améliorer la compréhension)
  datasummary <- as.data.frame(bdatsummary$value[,"Median"])
  colnames(datasummary) <- "median"
  datasummary <- t(datasummary)
  colnames(datasummary) <- c("1995-1999","2000-2004","2005-2009","2010-2014")

  res <- outer(1:ncol(datasummary), 1:ncol(datasummary), 
              function(x,y) ((datasummary[,x]-datasummary[,y])/datasummary[,x])*100)

  period_count <- c(1995,2000,2005,2010)

  res_period <- outer(1:length(period_count), 1:length(period_count), 
              function(x,y) ((period_count[x])-period_count[y]))

  res[upper.tri(res, diag = TRUE)] <- NA
  res2 <- res/res_period
  colnames(res2) <- as.character(colnames(datasummary))
  rownames(res2) <- as.character(colnames(datasummary))
  
  datasummary2 <- melt(res2)
  datasummary2 <- datasummary2[complete.cases(datasummary2$value),]

  datasummary2$count <- c("23","24","25","34","35","45")
  colnames(datasummary2) <- c("EndDate","StartDate","Group","Count")

  # Ajout du test statistiques (wilcoxon)
 res.wilcoxon <- pairwise.wilcox.test(melted.test[,"value"], melted.test[,"annees"])$p.value
 res.wilcoxon[upper.tri(res.wilcoxon, diag = FALSE)] <- NA
 colnames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009"))
 rownames(res.wilcoxon) <- as.character(c("2000-2004","2005-2009","2010-2014"))
 res.wilcoxon <- melt(res.wilcoxon,na.rm=TRUE)
    
 # Ajout du test vers bdatmedian2
 datasummary2$pvalue <- res.wilcoxon$value
 datasummary2$value <- datasummary2$Group

  p[[i]] <- ggplot(datasummary2, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + coord_flip() + scale_colour_gradient2(limit = c(min(datasummary2$value),max(datasummary2$value)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5) + labs(title= paste(i))
}
tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=1,ncol=2,position="bottom")))
tt

# Même graphique mais par région d'élevage

cpt <- 0
  for(s in reg_elevage){
    cpt <- cpt + 1
    melted.test <- melted.bdat[(melted.bdat$variable %in% "75% centile") & melted.bdat$zonage_cplt %in% s,]
    
    bdatmedian <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],median))

    colnames(bdatmedian) <- "median"
    bdatmedian <- t(bdatmedian)
    colnames(bdatmedian) <- c("1995-1999","2000-2004","2005-2009","2010-2014")

    res <- outer(1:ncol(bdatmedian), 1:ncol(bdatmedian), 
                function(x,y) ((bdatmedian[,x]-bdatmedian[,y])/bdatmedian[,x])*100)
    period_count <- c(1995,2000,2005,2010)

    res_period <- outer(1:length(period_count), 1:length(period_count), 
                function(x,y) ((period_count[x])-period_count[y]))

    res[upper.tri(res, diag = TRUE)] <- NA
    res2 <- res/res_period
    colnames(res2) <- as.character(colnames(bdatmedian))
    rownames(res2) <- as.character(colnames(bdatmedian))
 
    bdatmedian2 <- melt(res2)
    bdatmedian2 <- bdatmedian2[complete.cases(bdatmedian2$value),]
    bdatmedian2$count <- c("23","24","25","34","35","45")
    colnames(bdatmedian2) <- c("EndDate","StartDate",paste(s),"Count")

    # Ajout du test statistiques (wilcoxon)
    res.wilcoxon <- pairwise.wilcox.test(melted.test[,"value"], melted.test[,"annees"])$p.value
    res.wilcoxon[upper.tri(res.wilcoxon, diag = FALSE)] <- NA
    colnames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009"))
    rownames(res.wilcoxon) <- as.character(c("2000-2004","2005-2009","2010-2014"))
    res.wilcoxon <- melt(res.wilcoxon,na.rm=TRUE)
    
    # Ajout du test vers bdatmedian2
    bdatmedian2[paste("pvalue",s,sep="")] <- res.wilcoxon$value

    if(cpt==1){
     # Construction de la première table
     stats.canton <- bdatmedian2
        }else{
       # Ajout à chaque itération de la variable (i)
       stats.canton <- merge(stats.canton,bdatmedian2, by.x=c("EndDate","StartDate","Count"), by.y=c("EndDate","StartDate","Count"),all.x=FALSE,all.y=FALSE)      
     }   
  }

meltstats <- melt(stats.canton[!colnames(stats.canton) %in% paste("pvalue",reg_elevage,sep="")],id.vars=c("EndDate","StartDate","Count"))
pvaluemeltstats <- melt(stats.canton[!colnames(stats.canton) %in% reg_elevage],id.vars=c("EndDate","StartDate","Count"))
meltstats$pvalue <- pvaluemeltstats$value

evol_elevage <- ggplot(meltstats, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + facet_wrap(~variable) + coord_flip() + scale_colour_gradient2(limit = c(min(meltstats$value),max(meltstats$value)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5)

ggsave(evol_elevage,file = paste(repsortie,"evol_elevage.png",sep=""), width = 17, height = 6)  

## Exemple à reprendre?http://stackoverflow.com/questions/35848654/ggplot2-plot-two-data-sets-into-one-picture
```

# Evolution cantonale des teneurs en carbone organique

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Lecture des tables de travail

##RA
tablename <- paste("dm_traitements.","melted_ra",sep="")
melted.ra <- sqlQuery(loc,paste("select * from ",tablename,sep=""))
melted.radiff <- sqlQuery(loc,paste("select * from ",tablename,"diff",sep=""))
melted.radiff <- melted.radiff[complete.cases(melted.radiff$value) & complete.cases(melted.radiff$zonage_simple) & complete.cases(melted.radiff$zonage_cplt),]
melted.ra <- melted.ra[complete.cases(melted.ra$value) & complete.cases(melted.ra$zonage_simple) & complete.cases(melted.ra$zonage_cplt),]
melted.ra$annees <- factor(melted.ra$annees)

##BDATDiff
melted.bdatdiff <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdatdiff",sep=""))#,as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE))
melted.bdatdiff$diffmedian <- as.numeric(melted.bdatdiff$diffmedian)
melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff_corgox),]

# Jeu de données sur 4 périodes de temps
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))
```

## Analyse du nombre d'évolution significative par canton

La figure XX présente un histogramme du nombre de canton ayant connu une augmentation ou une diminution significative des teneurs en carbone organique. L'histogramme est appliqué sur toutes les périodes et stratifié par zones d'élevage et par type de climat.

La figure présente les mêmes proportion générales observée à l'échelle nationale précédemment. La part de canton aux évolutions des teneurs en CO non significative est toujours très importante. Globalement, le nombre de canton ayant eu une augmentation ou une diminution de la teneur en CO est équilibré à l'échelle des strates géographiques. Quelques zones se distinguent toutefois :

- Les régions B1, C2 et D sont davantage affectées par la diminution des teneurs en CO
- Les région A et C1 sont plus affectées par des augmentations que des diminutions. A noter que cette zone dernière zone est davantage affectée par évolutions significatives que les autres strates.
- La région climatique 5 (climat océanique franc) est également plus exposée aux évolutions significatives et notamment aux diminutions des teneurs en CO.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=10,fig.align="center"}
# Histogramme des valeurs (ajouter les valeurs en %)
bdatdiff <- melted.bdatdiff

p <- bdatdiff %>% 
          group_by(zonage_cplt,diff_corgox) %>% 
          summarise(count=n()) %>% 
          mutate(perc=round((count/sum(count)),2)) %>%

          ggplot(aes(x = factor(zonage_cplt), y = perc, fill = factor(diff_corgox),label=paste(perc*100,"%",sep=""))) +
          scale_fill_brewer(palette = 'Paired',name="Evolution des teneurs en CO")+
          geom_bar(stat="identity", width = 0.7) +
          geom_text(size = 3, position = position_stack(vjust = 0.5))+
          xlab("Zones d'élevage")+ylab("Pourcentage de canton")+
          theme_perso()+
          scale_y_continuous(labels=percent)
p
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.align="center"}

# Voir pour créer un graphique facilement lisible d'un point de vue chronologique...
bdatdiff <- subset(melted.bdatdiff,diff_corgox!="Non significatif")
periodetud <- c("14","24","15","25","13","35")

# Pour voir...
enplus <- c("12","45","23")
periodetud <- c(periodetud,enplus)

bdatdiff <- bdatdiff[bdatdiff$period %in% periodetud, ]
bdatdiff$diff_corgox <- as.factor(bdatdiff$diff_corgox)
bdatdiff$classe_var_prairie1970_2010 <- ordered(bdatdiff$classe_var_prairie1970_2010, levels = c("[-97.8,-21.4]","(-21.4,-11.8]","(-11.8,-4.19]","(-4.19,4.5]","(4.5,73]"))

#fill=classe_var_prairie1970_2010(dans aes)
histo_period <- ggplot(bdatdiff,aes(diff_corgox)) + geom_bar() + facet_wrap(~ period)+
                    scale_fill_brewer(palette = 'Paired',name="Evolution des prairies % (1970-2010)")+
                    xlab("Type d'évolution des teneurs en carbone organique")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11))    
                    #geom_bar(position="dodge")
histo_period
#ggsave(histo_period,file = paste(repsortie,"histo_regelevage.png",sep=""), width = 12, height = 6)  
```
> **En conclusion** de cette section, on constate plusieurs points :
- Les évolutions des teneurs en CO entre les différentes périodes ne suivent pas les mêmes tendances. Les teneurs en CO ont augmenté sur la période [2010-2014] et cette augmentation est particulièrement prononcée entre les périodes [2000-2004]-[2010-2014].
- La diminution des teneurs est surtout observée entre [1990-1994]-[2000-2004] et [1994-1999]-[2005-2009] et [1990-1994]-[2005-2009].
- Les principales périodes où l'évolution des teneurs en CO est marquante seront analysées dans le détails et sont les suivantes :
    * Diminution : (13) [1990-1994]-[2000-2004] et (23) [1994-1999]-[2000-2004]
    * Augmentation : (35) [2000-2004]-[2010-2014] et (45) [2005-2009]-[2010-2014]
- Les principales zones d'élevage affectées par ces changements sont : A, B1, C1, C2 et D. Ce résultat provient surtout de la densité d'analyse dans ces zones et de leur étendue spatiale.

## Facteurs contrôlant l'évolution des teneurs en carbone organique

```{r,eval=FALSE,echo=FALSE}
### Test en cours sur l'intérêt de présenter les principales tendances de changement d'occupation du sol au sein des différentes régions d'élevage

colors <- brewer.pal(3,"Set1")#wes_palette("Rushmore",nperiod,type="continuous")
melted.ra_focus <- melted.ra[melted.ra$annees %in% c("1970","1979","1988","2000","2010") & melted.ra$variable %in% c("p_c","p_mf","p_prairie"),]
levels(melted.ra_focus$variable) <- c("Céréales","COP","Maïs-fourrage","Prairies","Surface fourragère principale","Surface Toujours en Herbe","UGBTA")

  p_ra <- ggplot(melted.ra_focus,aes(x=annees,y=value,col=variable)) + facet_wrap(~zonage_cplt) + stat_summary(fun.y=mean, geom="line",size = 1.5, aes(group=variable,color=variable))  + 
            #geom_smooth(aes(group=variable,color=variable),method=loess)+
            xlab("Années") +
            scale_color_manual(values=colors,name="Occupation du sol")+
            scale_y_continuous("Occupation du sol (% de SAU)")+
            theme_classic()+
            theme(
                axis.text.x = element_text(size = 11, colour = "black"),#,face = "bold"),
                axis.text.y = element_text(size = 11, colour = "black"),#,face = "bold"),face = "bold"),
                axis.line.x = element_line(colour = "black", size = 0.7),
                axis.line.y = element_line(colour = "black", size = 0.7),
                plot.title = element_text(size = 14, face = "bold"), 
                text = element_text(size = 12),
                axis.title = element_text(face="bold"),
                )
```