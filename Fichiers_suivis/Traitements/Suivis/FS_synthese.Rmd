---
title: "Évolution des teneurs en carbone organique dans les régions d'élevage en France entre 1990-2014"
author: "Jean-Baptiste Paroissien"
date: "15/06/2017"
output:
  html_document:
    toc: yes
    toc_float: yes
    fig_caption: yes
    highlight: kate
    number_sections: yes
    theme: spacelab   
---

```{r setup, include=FALSE,warning=FALSE,echo=FALSE,message=FALSE,eval=TRUE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/Data/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
repsortie <- paste(repmaster,"Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers
reppapier <- "/media/sf_GIS_ED/Com/Papier_carboelevage/Fig/" #répertoire de sortie pour la rédaction de l'article
set.seed(157) #Pour la reproductibilité
cl <- makeCluster(4);registerDoParallel(cl) #Configuration pour le calcul en parallèle
```
```{r date, include=FALSE,warning=FALSE,echo=FALSE,message=FALSE,eval=TRUE}
date <- Sys.Date()
sessionInfo()
```

```{r, tidy=FALSE,eval=TRUE,echo=FALSE}
mo_url <- "https://github.com/GisEDSol/Carbo_elevage/tree/master/Documentation/Modes_operatoires/"
fs_url <- "https://github.com/GisEDSol/Carbo_elevage/tree/master/Fichiers_suivis/"
raw_mo_url <- "https://rawgit.com/GisEDSol/Carbo_elevage/master/Documentation/Modes_operatoires/"
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE}
# Jeu de données sur 4 périodes de temps
bdat9514 <- sqlQuery(loc,paste("select * from dm_vecteurs.canton_9514",sep=""))
melted.9514 <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdat_9514"),stringsAsFactors=TRUE,as.is=TRUE)
melted.9514$value <- as.numeric(melted.9514$value)
melted.9514 <- melted.9514[complete.cases(melted.9514$value),]
melted.9514$annees <- factor(melted.9514$annees,levels=c("9599","0004","0509","1014"))
#melted.9514$annees <- factor(melted.9514$annees,levels=c("9094","9599","0004","0509","1014"))

# Sélection des teneurs mesurées avec la méthode OX (médiane)
dcast.bdat <- bdat9514
melted.bdat <- melted.9514 

# Sélection uniquement des médianes et du 3ème quartile
melted.bdat <- melted.bdat[melted.bdat$variable %in% c("med_corgox","dqua_corgox"),]
levels(melted.bdat$variable) <- c("Médiane","75% centile")

# En attendant les corrections de Laetitia, on travaille sur les médianes
melted.bdat <- melted.bdat[melted.bdat$variable %in% "med_corgox",]
```

# Objectifs

Ce document centralise les principaux résultats du travail sur l'évolution des teneurs en CO en lien avec l'élevage. Les principales figures de l'article en cours de rédaction sont construites dans ce fichier, à savoir les figures du matériels et méthodes, les tableaux et figures des résultats.

# Données

## La Base de Données des Analyses de Terre (BDAT)

##Sélection des facteurs explicatifs

```{r,eval=FALSE,echo=FALSE}
tabledata <- read.csv("/media/sf_GIS_ED/Dev/Tab/Donnees_papier.csv")
print(xtable(tabledata),include.rownames=FALSE)

table_ra <- read.csv(paste(repmetadonnees,"Nomenclature_ra.csv",sep=""))
print(xtable(table_ra),include.rownames=FALSE)

```

## Les grandes régions d'élevage

Au final, après plusieurs tests sur les types de climat et sur le zonage "complexe" des régions d'élevage (13 régions), le zonage "simple" des régions d'élevage est utilisé. Ce choix est motivé pour récolter plus d'analyse par strates et faciliter l'interprétation et les commentaires des résultats.

```{r,highlight=TRUE,eval=FALSE,echo=FALSE}
tablecarto <- "dm_vecteurs.canton" 
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" 
variablecarto <- "zonage_simple" #variable à spatialiser
l_legend <- "Principales régions d'élevage"#label de la variable
nclasse <- 13 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
nomfichier <- "reg_elevage_simple"
code_regelevage <- read.csv(paste(repmetadonnees,"Nomenclature_regionelevage.csv",sep=""))

couleur <- as.character(code_regelevage$Code_couleur_simple)
couleur <- couleur[complete.cases(couleur)]
carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_legend,repsortie,nomfichier,title="",caption="",dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=3,position="bottom",ggsaveheight=7,ggsavewidth=10)
```

```{r, echo = F, results = 'asis',warning=FALSE,error=FALSE,message=FALSE}
# Pour insérer l'image
fichiers <- paste(repsortie,"reg_elevage_simple.png",sep="")
cat(paste("![](",fichiers,")",sep=""))
```

```{r ,highlight=TRUE,echo=FALSE,eval=TRUE,results = 'asis',warning=FALSE,message=FALSE}
p <- list()
for(i in levels(as.factor(melted.bdat$zonage_simple))){
  melted.test <- melted.bdat[melted.bdat$zonage_simple %in% i & melted.bdat$variable %in% "med_corgox",]
  p[[i]] <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],length))[1,1]
}
regelevage_nbranalyses <- as.data.frame(melt(p))
colnames(regelevage_nbranalyses) <- c("Nbr","Region_elevage")

pander(regelevage_nbranalyses[,c("Region_elevage","Nbr")],caption="Nombre de canton possédant des analyses par type de région d'élevage")
```

## Règle temporelle


```{r,highlight=TRUE,eval=TRUE,echo=FALSE,results = 'asis',warning=FALSE,message=FALSE}
nomperiodiff <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat_ra.csv",sep=""),sep=",",colClasses = "character")

pander(nomperiodiff,caption="Correspondance entre la période d'analyse de sol de la BDAT et la période du recensement agricole")
# A lancer pour l'article
# print(xtable(nomperiodiff),include.rownames=FALSE)
```

# Résultats

## Analyse des distributions statistiques et spatiales des teneurs en CO pour les différentes périodes

### Statistiques descriptives

```{r summarybdatfrancetable,echo=FALSE,eval=TRUE,results = 'asis',warning=FALSE,message=FALSE}

bdatsummarystats <- list()
#for(i in levels(as.factor(melted.bdat$variable))){
  i <- "med_corgox"
  melted.test <- melted.bdat[melted.bdat$variable %in% i,]
  # Résumé des statistiques 
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  bdatsummarystats[[i]] <- bdatsummary
#}

stats_table <-pander(bdatsummarystats["med_corgox"][[1]],caption = "Statistiques descriptives des teneurs en carbone organique pour les différentes périodes")
#pander(bdatsummarystats["75% centile"][[1]],caption = "Statistiques descriptives des teneurs en carbone organique pour les différentes périodes")
```

Le tableau présente les statistiques des teneurs en Carbone Organique (CO) pour les différentes périodes analyées. La période 2000-2004 montre la valeur médiane la plus faible avec une valeur de `r bdatsummarystats$med_corgox$value["0004","Median"]` g/kg. Les valeurs les plus importantes sont observées pour les périodes 1995-1999 et 2010-2014 avec des médianes de teneurs en carbone organique équivalente, à `r bdatsummarystats$med_corgox$value["9599","Median"]` g/kg. La significacité de ces tendances a été évaluée avec le test de wilcoxon. Ces résultats ainsi que l'évaluation des vitesses d'évolution des teneurs en CO sont présentés dans la figure XX. La baisse des teneurs en CO entre la période 1995-1999 et les périodes 2000-2004 et 2005-2009 sont significatives et sont de 0.8 et 0.3% par an respectivement. Après ces baisses, les teneurs en CO augmentent significativement entre la période 2000-2004 et 2005-2009 et 2010-2014 avec un taux de 0.4 et 0.6% par an respectivement.

```{r boxplot_fr,highlight=TRUE,echo=FALSE,eval=TRUE,fig.height=5, fig.width=6,fig.align="center",warning=FALSE,message=FALSE}
ylim1 <- c(min(melted.bdat$value,na.rm=TRUE),quantile(melted.bdat$value,0.95,na.rm=TRUE))

test1 <- generate_label_df(db=melted.bdat[melted.bdat$variable %in% "med_corgox",],value="value",lev="annees",LETTERS,position=1)
#test2 <- generate_label_df(db=melted.bdat[melted.bdat$variable %in% "75% centile",],value="value",lev="annees",letters,position=1)
p <- list()

p[["1"]] <- ggplot(melted.bdat,aes(x=annees,y=value)) + 
     geom_boxplot(aes(x=annees,y=value)) + #,fill=variable))+
     stat_summary(fun.y=mean, geom="line",size = 1, aes(group=variable),alpha = 0.8) +
     scale_x_discrete("Périodes")+scale_y_continuous("Teneur en carbone organique (g/kg)")+
     theme_perso(position="right")+ geom_text(data = test1,hjust = 0, vjust=-0.7,aes(x = plot.labels, y = V1, label = labels))+ scale_fill_manual(values=c("#F1ED0AE6", "#F36E15E6"), name="Statistiques cantonales") + theme(legend.position="bottom")#+ coord_cartesian(ylim = ylim1) geom_text(data = test2,hjust = -2,vjust=-0.75, aes(x = plot.labels, y = V1, label = labels)) 
```
```{r ,echo=FALSE,eval=TRUE,results='asis',fig.height=8, fig.width=10,fig.align="center"}
#p <- list()
#bdatsummarystats <- list()
#for(i in levels(as.factor(melted.bdat$variable))){
  i <- "med_corgox"
  melted.test <- melted.bdat[melted.bdat$variable %in% i,]
  # Résumé des statistiques 
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  bdatsummarystats[[i]] <- bdatsummary

#  xtable(bdatsummary$value,caption="Statistiques descriptives des teneurs en CO à l'échelle cantonale pour les différentes périodes")

 pander(bdatsummary$value,caption="Stastistiques descriptives des teneurs en CO pour les différentes statistiques aggrégées à l'échelle cantonale")

# Changer le nom des variables (pour améliorer la compréhension)
  datasummary <- as.data.frame(bdatsummary$value[,"Median"])
  colnames(datasummary) <- "median"
  datasummary <- t(datasummary)
  colnames(datasummary) <- c("1995-1999","2000-2004","2005-2009","2010-2014")
  #colnames(datasummary) <- c("1990-1994","1995-1999","2000-2004","2005-2009","2010-2014")

  res <- outer(1:ncol(datasummary), 1:ncol(datasummary), 
              function(x,y) ((datasummary[,x]-datasummary[,y])/datasummary[,x])*100)

  period_count <- c(1995,2000,2005,2010)
  #period_count <- c(1990,1995,2000,2005,2010)

  res_period <- outer(1:length(period_count), 1:length(period_count), 
              function(x,y) ((period_count[x])-period_count[y]))

  res[upper.tri(res, diag = TRUE)] <- NA
  res2 <- res/res_period
  colnames(res2) <- as.character(colnames(datasummary))
  rownames(res2) <- as.character(colnames(datasummary))
  
  datasummary2 <- melt(res2)
  datasummary2 <- datasummary2[complete.cases(datasummary2$value),]

  datasummary2$count <- c("23","24","25","34","35","45")
#  datasummary2$count <- c("12","13","14","15","23","24","25","34","35","45")
  colnames(datasummary2) <- c("EndDate","StartDate","Group","Count")

  # Ajout du test statistiques (wilcoxon)
 res.wilcoxon <- pairwise.wilcox.test(melted.test[,"value"], melted.test[,"annees"])$p.value
 res.wilcoxon[upper.tri(res.wilcoxon, diag = FALSE)] <- NA
 colnames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009"))
 rownames(res.wilcoxon) <- as.character(c("2000-2004","2005-2009","2010-2014"))
# colnames(res.wilcoxon) <- as.character(c("1990-1994","1995-1999","2000-2004","2005-2009"))
# rownames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009","2010-2014"))


 res.wilcoxon <- melt(res.wilcoxon,na.rm=TRUE)
    
 # Ajout du test vers bdatmedian2
 datasummary2$pvalue <- res.wilcoxon$value
 datasummary2$value <- datasummary2$Group
  
p[["2"]] <- ggplot(datasummary2, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + coord_flip() + scale_colour_gradient2(limit = c(min(datasummary2$value),max(datasummary2$value)),breaks=c(round(min(datasummary2$value),1),round(max(datasummary2$value),1)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("Code des périodes comparées") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5)# + labs(title= paste(i))
#}

#tt <- do.call(grid.arrange,p)
#tt
p[["2"]]

ggsave(p[["2"]],file = paste(reppapier,"taux_evolutionCO.png",sep=""), width = 6, height = 6)  
ggsave(p[["2"]],file = paste(repsortie,"taux_evolutionCO.png",sep=""), width = 6, height = 6)  
```

#### Analyse par région d'élevage

```{r,highlight=TRUE,eval=TRUE,message=FALSE,echo=FALSE}
#bdatsummary_regelevage <- apply(melted.bdat["value"],2, function(x) tapply(x, list(melted.bdat[,"zonage_simple"],melted.bdat[,"annees"]),summary))
#bdatsummary_regelevage <- data.frame(bdatsummary_regelevage[[1]])
#bdatsummary_regelevage <- lapply(bdatsummary_regelevage, do.call, what = rbind)
#names(bdatsummary_regelevage) <- period
bdatsummary_regelevage <- apply(melted.bdat["value"],2, function(x) tapply(x, list(melted.bdat[,"zonage_simple"]),summary))$value
```

La figure présente la distribution des teneurs en CO pour toutes les périodes en fonction des principales grandes régions d'élevage. La comparaison avec le test de wilcoxon montre que les teneurs en CO sont différentes entre les régions d'élevage à l'exception des régions C et D. Les plus faibles teneurs se retrouvent dans les régions A et F avec des médianes respectives de `r round(bdatsummary_regelevage$A["Median"],1)` g/kg et `r round(bdatsummary_regelevage$F["Median"],1)` g/kg. Les teneurs en CO les plus élevées se trouvent dans les régions F, C et D avec respectivement des teneurs de `r round(bdatsummary_regelevage$F["Median"],1)` g/kg, `r round(bdatsummary_regelevage$C["Median"],1)` g/kg et `r round(bdatsummary_regelevage$D["Median"],1)` g/kg.
Les taux d'évolution des teneurs en CO entre les périodes étudiées et pour chacune des régions d'élevage sont présentées dans la figure ci-dessous. Les régions A, B, D et E présentent des tendances d'évolution similaire et comparable à l'évolution nationale. Les teneurs baissent puis augmentent à partir de 2000-2004. Les évolutions sont différentes pour les régions F et G où les périodes de baisses et d'augmentations s'alternent entre les périodes. La région C présentent des taux d'évolution très faible montrant une stabilité dans les teneurs en CO.

Ces évolutions observées sont rarement significatives. Seules les régions A et B présentent des tendances significativement différentes. L'augmentation des teneurs en CO dans la région A est significative entre 2005-2009 et 2010-2014. Dans la région B, c'est la diminution entre la période 1995-1999 et 2000-2004 qui est significative. 

```{r boxplot_reg_elevagezoom,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.align="center"}
# Lecture de la table des couleurs
code_regelevage <- read.csv(paste(repmetadonnees,"Nomenclature_regionelevage.csv",sep=""))
period <- c("9599","0004","0509","1014")
#reg_elevage <- c("A","B1","B2","C1","C2","D","E1","E2","F2")
reg_elevage <- c("A","B","C","D","E","F","G")
couleur <- as.character(code_regelevage[code_regelevage$Zonage_simple %in% reg_elevage,"Code_couleur_simple"])

melted.bdat_regelevage <- melted.bdat[complete.cases(melted.bdat$zonage_simple) & (melted.bdat$zonage_simple %in% reg_elevage) & melted.bdat$variable %in% "med_corgox",]

wilcotest <- generate_label_df(db=melted.bdat_regelevage,value="value",lev="zonage_simple",letters,position=1)

p <- ggplot(melted.bdat_regelevage) +
            geom_boxplot(aes(x=zonage_simple,y=value,fill=zonage_simple))+
            scale_fill_manual(values=couleur,name="") + scale_x_discrete("Grandes régions d'élevage")+scale_y_continuous("Teneur en carbone organique (g/kg)")+ theme_perso("") + geom_text(data = wilcotest, vjust=-0.75,aes(x = plot.labels, y = V1, label = labels))
            
p 
ggsave(p,file = paste(reppapier,"boxplotbdat_zonage_simple.png",sep=""), width = 12, height = 6)
ggsave(p,file = paste(repsortie,"boxplotbdat_zonage_simple.png",sep=""), width = 12, height = 6)  
```



```{r,highlight=TRUE,eval=FALSE,echo=FALSE,fig.height=8, fig.width=12,fig.align="center",warning=FALSE,message=FALSE}

reg_elevage <- c("A","B1","B2","C1","C2","D","E1","E2","F2")
p <- list()
cpt <- 0

for(i in reg_elevage){
  cpt <- cpt + 1
  datatest <- melted.bdat[melted.bdat$zonage_cplt %in% i,]
  datatestobs <- datatest[datatest$variable %in% "med_corgox",]
  nbrobservation <- apply(datatestobs["value"],2, function(x) tapply(x, datatestobs["annees"],length))[1,1]

  ylim1 <- c(min(datatest$value,na.rm=TRUE),quantile(datatest$value,0.99,na.rm=TRUE))

  test1 <- generate_label_df(db=datatest[datatest$variable %in% "med_corgox",],value="value",lev="annees",letters,position=0.99)
  test2 <- generate_label_df(db=datatest[datatest$variable %in% "dqua_corgox",],value="value",lev="annees",LETTERS,position=0.98)

if(cpt==4){
  labley <- "Teneur en carbone organique (g/kg)"
}else{labley <- ""}

  if(cpt==8){
  lablex <- "Périodes"
}else{lablex <- ""}

  p[[i]] <- ggplot(datatest,aes(x=annees,y=value)) + 
            geom_boxplot(aes(fill=variable),outlier.shape = NA,outlier.size=NA)+
            stat_summary(fun.y=median, geom="line",size = 1, aes(group=variable)) +
            scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso()+geom_text(data = test1,aes(x = plot.labels, y = V1, label = labels),hjust = 2,inherit.aes = FALSE)+ coord_cartesian(ylim = ylim1*1.2) + labs(title= paste(i,". Nbr: ",nbrobservation,sep="")) + scale_fill_manual(values=c("#F1ED0AE6", "#F36E15E6"),name="Statistiques cantonales") #geom_text(data = test2, aes(x = plot.labels, y = V1, label = labels),hjust = -2,inherit.aes = FALSE)
}

tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=3,ncol=3,position="bottom")))
ggsave(p,file = paste(reppapier,"boxplot_regelevage_stats.png",sep=""), width = 17, height = 10)
ggsave(tt,file = paste(repsortie,"boxplot_regelevage_stats.png",sep=""), width = 17, height = 10)  


panderOptions('knitr.auto.asis', FALSE)
p <- list()
for(i in levels(as.factor(melted.bdat_regelevage$zonage_cplt))){
  melted.test <- melted.bdat_regelevage[melted.bdat_regelevage$zonage_cplt%in% i,]   
  bdatsummary <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],summary))
  nbrobservation <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],length))[1,1]
  bdatsummary <- lapply(bdatsummary, do.call, what = rbind)
  #pander(bdatsummary[[1]],caption = paste("Statistiques descriptives des teneurs en carbone organique pour le type de climat ",i,". Nombre de canton analysé : ",nbrobservation,sep=""))
}
```

```{r,eval=FALSE,echo=FALSE,fig.height=8, fig.width=13,fig.align="center"}
cpt <- 0
  for(s in reg_elevage){
    cpt <- cpt + 1
    melted.test <- melted.bdat[(melted.bdat$variable %in% "75% centile") & melted.bdat$zonage_cplt %in% s,]
    
    bdatmedian <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],median))

    colnames(bdatmedian) <- "median"
    bdatmedian <- t(bdatmedian)
    colnames(bdatmedian) <- c("1995-1999","2000-2004","2005-2009","2010-2014")

    res <- outer(1:ncol(bdatmedian), 1:ncol(bdatmedian), 
                function(x,y) ((bdatmedian[,x]-bdatmedian[,y])/bdatmedian[,x])*100)
    period_count <- c(1995,2000,2005,2010)

    res_period <- outer(1:length(period_count), 1:length(period_count), 
                function(x,y) ((period_count[x])-period_count[y]))

    res[upper.tri(res, diag = TRUE)] <- NA
    res2 <- res/res_period
    colnames(res2) <- as.character(colnames(bdatmedian))
    rownames(res2) <- as.character(colnames(bdatmedian))
 
    bdatmedian2 <- melt(res2)
    bdatmedian2 <- bdatmedian2[complete.cases(bdatmedian2$value),]
    bdatmedian2$count <- c("23","24","25","34","35","45")
    colnames(bdatmedian2) <- c("EndDate","StartDate",paste(s),"Count")

    # Ajout du test statistiques (wilcoxon)
    res.wilcoxon <- pairwise.wilcox.test(melted.test[,"value"], melted.test[,"annees"])$p.value
    res.wilcoxon[upper.tri(res.wilcoxon, diag = FALSE)] <- NA
    colnames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009"))
    rownames(res.wilcoxon) <- as.character(c("2000-2004","2005-2009","2010-2014"))
    res.wilcoxon <- melt(res.wilcoxon,na.rm=TRUE)
    
    # Ajout du test vers bdatmedian2
    bdatmedian2[paste("pvalue",s,sep="")] <- res.wilcoxon$value

    if(cpt==1){
     # Construction de la première table
     stats.canton <- bdatmedian2
        }else{
       # Ajout à chaque itération de la variable (i)
       stats.canton <- merge(stats.canton,bdatmedian2, by.x=c("EndDate","StartDate","Count"), by.y=c("EndDate","StartDate","Count"),all.x=FALSE,all.y=FALSE)      
     }   
  }

meltstats <- melt(stats.canton[!colnames(stats.canton) %in% paste("pvalue",reg_elevage,sep="")],id.vars=c("EndDate","StartDate","Count"))
pvaluemeltstats <- melt(stats.canton[!colnames(stats.canton) %in% reg_elevage],id.vars=c("EndDate","StartDate","Count"))
meltstats$pvalue <- pvaluemeltstats$value

evol_elevage <- ggplot(meltstats, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + facet_wrap(~variable) + coord_flip() + scale_colour_gradient2(limit = c(min(meltstats$value),max(meltstats$value)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5)
evol_elevage

ggsave(evol_elevage,file = paste(repsortie,"evol_elevage.png",sep=""), width = 17, height = 6)  

## Exemple à reprendre?http://stackoverflow.com/questions/35848654/ggplot2-plot-two-data-sets-into-one-picture
```
```{r,highlight=TRUE,eval=FALSE,echo=FALSE,fig.height=8, fig.width=12,fig.align="center",warning=FALSE,message=FALSE}

reg_elevage <- c("A","B","C","D","E","F","G")
p <- list()
cpt <- 0
for(i in reg_elevage){
  cpt <- cpt + 1
  datatest <- melted.bdat[melted.bdat$zonage_simple %in% i,]
  datatestobs <- datatest[datatest$variable %in% "med_corgox",]
  nbrobservation <- apply(datatestobs["value"],2, function(x) tapply(x, datatestobs["annees"],length))[1,1]

  ylim1 <- c(min(datatest$value,na.rm=TRUE),quantile(datatest$value,0.99,na.rm=TRUE))

  test1 <- generate_label_df(db=datatest[datatest$variable %in% "med_corgox",],value="value",lev="annees",letters,position=0.99)
  #test2 <- generate_label_df(db=datatest[datatest$variable %in% "75% centile",],value="value",lev="annees",LETTERS,position=0.98)

if(cpt==4){
  labley <- "Teneur en carbone organique (g/kg)"
}else{labley <- ""}

  if(cpt==8){
  lablex <- "Périodes"
}else{lablex <- ""}

  p[[i]] <- ggplot(datatest,aes(x=annees,y=value)) + 
            geom_boxplot(aes(fill=variable),outlier.shape = NA,outlier.size=NA)+
            stat_summary(fun.y=median, geom="line",size = 1, aes(group=variable)) +
            scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso()+geom_text(data = test1,aes(x = plot.labels, y = V1, label = labels),hjust = 0,inherit.aes = FALSE)+ coord_cartesian(ylim = ylim1*1.2) + labs(title= paste(i,". Nbr: ",nbrobservation,sep="")) #+ geom_text(data = test2, aes(x = plot.labels, y = V1, label = labels),hjust = -2,inherit.aes = FALSE)#scale_fill_manual(values=c("#F1ED0AE6", "#F36E15E6"),name="Statistiques cantonales")
}
tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=3,ncol=3,position="bottom")))

ggsave(tt,file = paste(repsortie,"boxplot_regelevagesimple_stats.png",sep=""), width = 17, height = 10)  
```

```{r,eval=TRUE,echo=FALSE,fig.height=8, fig.width=13,fig.align="center"}
# Calcul de la surface des régions d'élevage (somme des surfaces cantonales comprises dans le calcul, en km2)
surface_elevage <- sqlQuery(loc,paste("select zonage_simple,sum(st_area(geom))/1000000 as area_elevage
from dm_vecteurs.canton_9514
group by zonage_simple
order by zonage_simple"))

cpt <- 0
  for(s in reg_elevage){
    cpt <- cpt + 1
    melted.test <- melted.bdat[(melted.bdat$variable %in% "med_corgox") & melted.bdat$zonage_simple %in% s,]
    
    bdatmedian <- apply(melted.test["value"],2, function(x) tapply(x, melted.test[,"annees"],median))

    colnames(bdatmedian) <- "median"
    bdatmedian <- t(bdatmedian)
    colnames(bdatmedian) <- c("1995-1999","2000-2004","2005-2009","2010-2014")

    res <- outer(1:ncol(bdatmedian), 1:ncol(bdatmedian), 
                function(x,y) ((bdatmedian[,x]-bdatmedian[,y])/bdatmedian[,x])*100)
    period_count <- c(1995,2000,2005,2010)

    res_period <- outer(1:length(period_count), 1:length(period_count), 
                function(x,y) ((period_count[x])-period_count[y]))

    res[upper.tri(res, diag = TRUE)] <- NA
    res2 <- res/res_period
    colnames(res2) <- as.character(colnames(bdatmedian))
    rownames(res2) <- as.character(colnames(bdatmedian))
 
    bdatmedian2 <- melt(res2)
    bdatmedian2 <- bdatmedian2[complete.cases(bdatmedian2$value),]
    bdatmedian2$count <- c("23","24","25","34","35","45")
    colnames(bdatmedian2) <- c("EndDate","StartDate",paste(s),"Count")

    # Ajout du test statistiques (wilcoxon)
    res.wilcoxon <- pairwise.wilcox.test(melted.test[,"value"], melted.test[,"annees"])$p.value
    res.wilcoxon[upper.tri(res.wilcoxon, diag = FALSE)] <- NA
    colnames(res.wilcoxon) <- as.character(c("1995-1999","2000-2004","2005-2009"))
    rownames(res.wilcoxon) <- as.character(c("2000-2004","2005-2009","2010-2014"))
    res.wilcoxon <- melt(res.wilcoxon,na.rm=TRUE)
    
    # Ajout du test vers bdatmedian2
    bdatmedian2[paste("pvalue",s,sep="")] <- res.wilcoxon$value

    if(cpt==1){
     # Construction de la première table
     stats.canton <- bdatmedian2
        }else{
       # Ajout à chaque itération de la variable (i)
       stats.canton <- merge(stats.canton,bdatmedian2, by.x=c("EndDate","StartDate","Count"), by.y=c("EndDate","StartDate","Count"),all.x=FALSE,all.y=FALSE)      
     }   
  }

meltstats <- melt(stats.canton[!colnames(stats.canton) %in% paste("pvalue",reg_elevage,sep="")],id.vars=c("EndDate","StartDate","Count"))
pvaluemeltstats <- melt(stats.canton[!colnames(stats.canton) %in% reg_elevage],id.vars=c("EndDate","StartDate","Count"))
meltstats$pvalue <- pvaluemeltstats$value

# Ajout des surfaces
meltstats <- merge(meltstats,surface_elevage,by.x="variable",by.y="zonage_simple")
meltstats$value_surface <- (meltstats$value/meltstats$area_elevage)*100000

# Valeur absolu
evol_elevage <- ggplot(meltstats, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + facet_wrap(~variable) + coord_flip() + scale_colour_gradient2(limit = c(min(meltstats$value),max(meltstats$value)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("Code des périodes comparées") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5) + theme(legend.position="none")
evol_elevage

# Valeur relative à la surface des régions d'élevage (100000 km2)
evol_elevage_surface <- ggplot(meltstats, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value_surface ),size=3) + facet_wrap(~variable) + coord_flip() + scale_colour_gradient2(limit = c(min(meltstats$value_surface ),max(meltstats$value_surface )),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("Code des périodes comparées") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value_surface ,1),"% **",sep=""),paste(round(value_surface ,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5) + theme(legend.position="none")
evol_elevage_surface

ggsave(evol_elevage,file = paste(reppapier,"evol_elevage_simple_surface.png",sep=""), width = 10, height = 6)
ggsave(evol_elevage,file = paste(repsortie,"evol_elevage_simple_surface.png",sep=""), width = 17, height = 6)  
```

### Distribution spatiale des teneurs en carbone organique

La distribution spatiale de la médiane des teneurs en CO par canton montre une distribution spatiale organisée recoupée essentiellement sur la lithologie. Les fortes teneurs en carbone organique sont présentes dans les zones de socles et de piemonts et les valeurs plus faibles dans les principaux bassins sédimentaires (parisien et aquitain). Les tendances entre les périodes ne sont pas clairement visibles. Certaines régions se distinguent néanmoins, notamment la région Hauts-de-France avec une diminution visible des teneurs en CO entre les périodes 1995-1999 et 2005-2009.

```{r ,highlight=TRUE,eval=FALSE,echo=FALSE}

tablecarto <- "dm_vecteurs.canton_9514" #Nom de la table utilisée pour la cartographie (table postgis)
period <- c("9599","0004","0509","1014") #
#stats <- c("pdec","pqua","med","dqua","ddec")

for(i in c("med","dqua")){
  #variables à cartographier
  variablecarto <- paste(i,"_corgox_",period,sep="")
  nclasse <- 5 
  style_classe <- "quantile"#Nombre de classes de valeurs pour la cartographie
  couleur <- viridis(nclasse)
  #couleur <- brewer.pal(nclasse,"YlOrRd") #Nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
  l_variable <- "Teneur en carbone organique (g/kg)" #label de la variable
  nomfichier <- paste("corgox_period_2_",i,sep="") #Nom du fichier
  titleperiod <- c("1995-1999","2000-2004","2005-2009","2010-2014")
  #title <- paste(i,"_",titleperiod,sep="")

  carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_variable,reppapier,nomfichier,title=titleperiod,caption="",dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=2,position="bottom",ggsaveheight=7,ggsavewidth=6.27)
}

```

```{r carto_c_fr, echo = F, results = 'asis'}
# Pour insérer l'image
stats <- "med"#c("med","dqua")
fichiers <- paste(repsortie,"corgox_period_",stats,".png",sep="")
cat(paste("![](",fichiers,")",sep=""))
```

### Facteurs contrôlant la distribution spatiale des teneurs en CO

Ci-dessous, les figures présentent l'effet des principales types de variables sur les teneurs en CO dans la modélisation. Les figures montrent des relations quasi-linéaire entre des variables comme l'altitude, la surface fouragère principale, la hauteur de pluie l'argile et la teneur en CO.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE,error=FALSE}
# Chargement des variables utilisées
Rcovarclimato <- c("hpluie_an","jfroids_an","ampli_t_juil_janv","pluie_ecart_janv","pluie_ecart_juil","jpluie_janv","jpluie_juil","ttemp_an","jchauds_an")
typeclimato <- replicate(length(Rcovarclimato), "climat")

Rcovartopo <- "altimean"
typetopo <- replicate(length(Rcovartopo), "topographie")

Rcovarpedo <- c("argi_med","sabt_med","mat11")
typepedo <- replicate(length(Rcovarpedo), "pedologie")

Rcovarstrates <- c("zonage_cplt","zonage_simple","typo_clim","code_dept")
typestrates <- replicate(length(Rcovarstrates), "strates")

## Construction des variables occupation du sol en fonction de la période en C étudiée
periodra <- c("1970","1979","1988","2000","2010")
ra_occup <- c("p_sfp","p_prairie","p_sth","p_cop","p_c","p_mf")
ra_otex <- c("polyelevage1988","elevage1988","elevagehorsol1988","ugbta1988","grdcultures1988")
Variay <- c("med_corgox_9599","med_corgox_0004","med_corgox_0509","med_corgox_1014")
effectif <- c("eff_corgox9599","eff_corgox0004","eff_corgox0509","eff_corgox1014")
indexperiod <- list(1:3,1:4,1:4,1:5)

nbr <- 100
prob <- 0.8
model="cubist"
```

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE,error=FALSE}
# Modélisation
cpt <- 0
for(i in Variay){
  cpt <- cpt + 1
  ra_occupyears <- apply(expand.grid(ra_occup,periodra[indexperiod[[cpt]]]),1, function(x){paste(x[1],x[2],sep="")})

  # Suppression p_protea1970 (inexistant en 1970!)
  #ra_occupyears <- ra_occupyears[!ra_occupyears %in% "p_protea1970"]

  Rcovaroccup <- c(ra_otex,ra_occupyears)
  
  # Ajout des effectifs
  Rcovar <- c(Rcovartopo,Rcovarpedo,Rcovaroccup,Rcovarclimato,Rcovarstrates,effectif[cpt])

  # Construction du vecteur des variables du modèle. 
  vNames <- c(i,Rcovar)

  # Sélection du jeu de données
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]

  trControl <- trainControl(method = "cv",p=prob,number=10)
  tuneGrid <- list(gbm=expand.grid(interaction.depth = c(1, 5, 9),n.trees = (1:10)*150,shrinkage = 0.1,n.minobsinnode = 10),cubist=expand.grid(.committees = c(10,50,100),.neighbors = c(1,5,9)))
    
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]
  datax <- d[,vNames[-1]]
  datay <- d[,vNames[1]]
  
  mcubist_fr <- cv_datamining(datax,datay,nbr=nbr,prob,model,select=1:15,tuneGrid,trControl,repsortie,type=type)

  saveRDS(mcubist_fr[c("varimp","meanvarimport","qualityindex","R2","RMSE","MSE")],file=paste(repsortie,"mcubist_fr_",i,"_",nbr,".rds",sep=""))
}
```

```{r,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,error=FALSE,fig.height=9, fig.width=11,fig.align="center"}
pourcent <- list()
rest <- array(NA, dim = c(length(Variay), 3),list(Period_co = Variay, mod = c("r2","MSE","RMSE")))
cpt <- 0
pp <- list()

for(i in Variay){
  cpt <- cpt + 1
  ra_occupyears <- apply(expand.grid(ra_occup,periodra[indexperiod[[cpt]]]),1, function(x){paste(x[1],x[2],sep="")})

  Rcovaroccup <- c(ra_otex,ra_occupyears)
  typeoccup <- replicate(length(Rcovaroccup), "occup")
  Rcovar <- c(Rcovartopo,Rcovarpedo,Rcovaroccup,Rcovarclimato,Rcovarstrates,effectif[cpt])
  type <- c(typetopo,typepedo,typeoccup,typeclimato,typestrates,"strates")

  varimp <- readRDS(paste(repsortie,"mcubist_fr_",i,"_",nbr,".rds",sep=""))
  qualityindex <- varimp$qualityindex
  varimp <- as.data.frame(varimp$varimp)
  varimp <- varimp[grep("Overall",names(varimp))]

  varimp$median <- apply(varimp, 1, function(x){median(x,na.rm=TRUE)})
  varimp$covariable <- rownames(varimp)
  varimp <- varimp[with(varimp, order(-median)),]
  varimp$covariable <- reorder(varimp$covariable, varimp$median)

  # Selection quantile(test$value,0.75)>40
  varimp$Q75 <- apply(varimp[,!names(varimp) %in% c("relatmed","median","covariable")],1, function(x) quantile(x, probs=0.75))
  varimp40 <- varimp[varimp$Q75>35,]
  varimp40$relatmed <- apply(varimp40[names(varimp40) %in% "median"],2,function(x){(x/sum(x))*100})

  test <- melt(varimp)
  test$type <- gsub2(as.character(Rcovar),type,as.character(test$covariable))
  #pp <- list()

  #pp[[2]]
  #pp[[i]] <- ggplot(test[!test$variable %in% c("relatmed","median","Q75"),],    aes(x=covariable,y=value,fill=type)) + geom_boxplot()+
   #  scale_x_discrete("Variables")+scale_y_continuous("Importance des variables (%)")+
    # coord_flip()+geom_hline(yintercept = 40) + theme_perso() + labs(title=i)

  test2 <- melt(varimp40)
  test2$type <- gsub2(as.character(Rcovar),type,as.character(test2$covariable))
  test2$period <- rep(i,nrow(test2))

  pourcent[[i]] <- test2[test2$variable %in% "relatmed",]

  rest[cpt,"r2"] <- qualityindex[,"R2"][[1]]
  rest[cpt,"MSE"] <- qualityindex[,"MSE"][[1]]
  rest[cpt,"RMSE"] <- qualityindex[,"RMSE"][[1]]
}
rest <- round(as.data.frame(rest[,]),2)
rest$Period_co <- rownames(rest)

#tt <- do.call(grid_arrange_shared_legend,c(pp,list(nrow=2,ncol=2,position="bottom")))

df <- do.call("rbind",pourcent)
df <- df[complete.cases(df),]
df$period <- factor(df$period,levels=c("med_corgox_9599","med_corgox_0004","med_corgox_0509","med_corgox_1014"))
```

```{r,eval=FALSE,echo=FALSE}
# Ici, on relance la modélisation avec les variables sélectionnées et on analyse le comportement des variables

for(i in Variay){
  selectdf <- df[df$period %in% i,c("covariable","value","type")]
  Rcovar <- as.character(selectdf$covariable)
  type <- as.character(selectdf$type)
  # Modélisation
  vNames <- c(i,Rcovar)

  # Sélection du jeu de données
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]

  trControl <- trainControl(method = "cv",p=prob,number=10)
  tuneGrid <- list(gbm=expand.grid(interaction.depth = c(1, 5, 9),n.trees = (1:10)*150,shrinkage = 0.1,n.minobsinnode = 10),cubist=expand.grid(.committees = c(10,50,100),.neighbors = c(1,5,9)))
    
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]
  datax <- d[,vNames[-1]]
  datay <- d[,vNames[1]]
  
  mcubist_fr <- cv_datamining(datax,datay,nbr=nbr,prob,model,select=1:20,tuneGrid,trControl,repsortie,type=type)

  saveRDS(mcubist_fr,file=paste(repsortie,"mcubist_fr_",i,"_",nbr,"_bis.rds",sep=""))
}
```

```{r,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,error=FALSE}
restbis <- array(NA, dim = c(length(Variay), 3),list(Period_co = Variay, mod = c("r2","MSE","RMSE")))
pourcentbis <- list()
cpt <- 0
for(i in Variay){
  print(i)
  cpt <- cpt + 1
  mcubist_fr <- readRDS(paste(repsortie,"mcubist_fr_",i,"_",nbr,"_bis.rds",sep=""))
  
  selectdf <- df[df$period %in% i,c("covariable","value","type")]
  Rcovar <- as.character(selectdf$covariable)
  type <- as.character(selectdf$type)
  
  qualityindex <- mcubist_fr$qualityindex
  varimp <- as.data.frame(mcubist_fr$varimp)
  varimp <- varimp[grep("Overall",names(varimp))]

  varimp$median <- apply(varimp, 1, function(x){median(x,na.rm=TRUE)})
  varimp$covariable <- rownames(varimp)
  varimp <- varimp[with(varimp, order(-median)),]
  varimp$covariable <- reorder(varimp$covariable, varimp$median)

  # Selection quantile(test$value,0.75)>35
  varimp$Q75 <- apply(varimp[,!names(varimp) %in% c("relatmed","median","covariable")],1, function(x) quantile(x, probs=0.75))
  varimp40 <- varimp[varimp$Q75>35,]
  varimp40$relatmed <- apply(varimp40[names(varimp40) %in% "median"],2,function(x){(x/sum(x))*100})

  test <- melt(varimp)
  test$type <- gsub2(as.character(Rcovar),type,as.character(test$covariable))

  pp[[i]] <- ggplot(test[!test$variable %in% c("relatmed","median","Q75"),],    aes(x=covariable,y=value,fill=type)) + geom_boxplot()+
     scale_x_discrete("Variables")+scale_y_continuous("Importance des variables (%)")+
     coord_flip()+geom_hline(yintercept = 40) + theme_perso() + labs(title=i)

  test2 <- melt(varimp40)
  test2$type <- gsub2(as.character(Rcovar),type,as.character(test2$covariable))
  test2$period <- rep(i,nrow(test2))

  pourcentbis[[i]] <- test2[test2$variable %in% "relatmed",]

  restbis[cpt,"r2"] <- qualityindex[,"R2"][[1]]
  restbis[cpt,"MSE"] <- qualityindex[,"MSE"][[1]]
  restbis[cpt,"RMSE"] <- qualityindex[,"RMSE"][[1]]

  # Sélection des meilleurs variables par type de variables (climat, topo...)
  Rcovarselect <- ddply(test2, c("covariable","type"), summarise,value = median(value)) 
  Rcovarselect2 <- ddply(Rcovarselect, .(type), summarise,value = max(value))
  Rcovarselect2 <- merge(Rcovarselect2,Rcovarselect,by.x=c("value","type"),by.y=c("value","type"),all=FALSE)
  
  # Condition en cas d'égalité
  if(nrow(Rcovarselect2)>4){
    # Sélectionner les covariables incriminées 
    Rcovarselect2 <- Rcovarselect2[!duplicated(Rcovarselect2[,c("type","value")]),]
    }else{}

  Rcovarselect2 <- as.character(Rcovarselect2$covariable)

  # Construction de la grille de sélection
  vNames <- c(i,Rcovar)
  d <- dcast.bdat[complete.cases(dcast.bdat[vNames]),vNames]
  grille <- as.data.frame(apply(d[,Rcovarselect2],2,function(x){quantile(x,c(seq(0,0.9,0.1),0.98))}))
  rownames(grille) <- NULL
  grille <- expand.grid(grille[,Rcovarselect2])
  autre <- vNames[!(vNames %in% Rcovarselect2)][-1]

  # Nom du modèle
  mcubist <- mcubist_fr$mdata_miningbst[[1]]$mdata_mining

  # Calcul de l'effet de la variable et sortie graphique
  plotvariaeffet <- variaeffect(grille = grille,vNames = autre,data = d,model = mcubist,nameModel = "cubist",neighbors=5)
  tt <- do.call(grid.arrange,c(plotvariaeffet$pgrille,list(nrow=2,bottom="",left="")))
  ggsave(tt,file = paste(repsortie,"variaeffect_",i,".png",sep=""), width = 11, height = 9)  
}

restbis <- round(as.data.frame(restbis[,]),2)
restbis$Period_co <- rownames(restbis)

dfbis <- do.call("rbind",pourcentbis)
dfbis <- dfbis[complete.cases(dfbis),]
dfbis$period <- factor(dfbis$period,levels=c("med_corgox_9599","med_corgox_0004","med_corgox_0509","med_corgox_1014"))
```

Les résultats de la validation croisée de la modélisation des teneurs en CO pour les différentes périodes sont présentés dans le tableau ci-dessous. Sur les 100 répétitions, l'application du modèle sur les 20% du jeu d'apprentissage montre une capacité de prédiction des teneurs en CO équivalente entre les périodes et de bonne qualité. La modélisation des teneurs en CO pour la période 2010-2014 montrent la capacité de prédiction la plus mauvaise avec un coefficient de détermination (R2) de `r restbis[restbis$Period_co %in% "med_corgox_1014","r2"]` et une erreur moyenne (Root Mean Square Error) de `r restbis[restbis$Period_co %in% "med_corgox_1014","RMSE"]` g/kg. La période 2005-2009 affiche les meilleurs résultats de prédiction un R2 de `r restbis[restbis$Period_co %in% "med_corgox_0509","r2"]` et une erreur moyenne de `r restbis[restbis$Period_co %in% "med_corgox_0509","RMSE"]` g/kg. En moyenne la modélisation des teneurs en CO toute période confondues affiche donc une capacité d'explication de la variance de plus de 80%.

```{r,eval=TRUE,echo=FALSE,results='asis'}
# Fusionner rest et rest_bis pour voir les différences de R2
pander(restbis[,1:3],caption="Moyenne des indicateurs de la qualité de la validation croisée pour les différentes teneurs en CO modélisées")

#xtable(restbis[,1:3],caption="Moyenne des indicateurs de la qualité de la validation croisée pour les différentes teneurs en CO modélisées")

#pander(rest[,1:3],caption="Moyenne des indicateurs de la validation croisée pour les différents modèles")
```

Les principales variables explicatives extraites de ces modélisation sont essentiellement d'origine naturelle (voir figure XX). Le taux d'argile, les variables climatiques (notamment l'écart de pluie en janvier) et la topographie occupent une place importante dans la modélsation des teneurs en CO à l'échelle de la France. L'importance de l'occupation du sol est secondaire et est principalement associée au pourcentage de Surface Fourragère Principale (SFP) et au pourcentage de prairie dans la SAU. Ainsi, dans ces modèles, la part des variables d'occupation du sol pour expliquer environ 80% de la variance varie entre 21 et 30%.

```{r,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,error=FALSE,fig.height=9, fig.width=11,fig.align="center"}
from <- c("climat","occup","pedologie","topographie")
to <- c("Naturelle","Anthropique","Naturelle","Naturelle")

dfbis2 <- dfbis
dfbis2$type2 <- gsub2(from,to,as.character(dfbis2$type))
dfbis2$type <- factor(dfbis2$type,levels=c("occup","climat","pedologie","topographie"))
dfbis2 <- dfbis2[with(dfbis2,order(type)),]
levels(dfbis2$period) <- list("9599"="med_corgox_9599", "0004"="med_corgox_0004", "0509"="med_corgox_0509", "1014"="med_corgox_1014")

test <- as.data.frame(dfbis2 %>% 
group_by(period,type2) %>% 
mutate(perc=round(sum(value))))

test2 <- as.data.frame(test %>% 
group_by(period,type) %>% 
mutate(perctype=round(sum(value),1)))

test2$positionperc <- as.numeric(c(rep("80",11),rep("45",30)))
#test3 <- unique(test2[,c("period","type","type2","perc","perctype")])

###################################
pp <- ggplot(test2,aes(x=period,y=value,fill=type,label=paste(covariable,":",round(value),"%",sep="")))+geom_col(width = 0.7) +
geom_text(size = 3, position = position_stack(vjust = 0.5)) +
geom_text(data = test2,aes(x = period, y = positionperc,colour=type2,label = paste(perc,"%",sep="")),size = 5) +
scale_colour_manual(values = c('Naturelle' = 'red', 'Anthropique' = 'black'),name="Origine") +
scale_fill_manual(values=couleur,name="Type") +
theme_perso() + xlab("")+ylab("Pourcentage d'importance")

pp
ggsave(pp,file = paste(repsortie,"ImpVariable_cubist.png",sep=""), width = 11, height = 9)  
ggsave(pp,file = paste(reppapier,"ImpVariable_cubist.png",sep=""), width = 11, height = 9)  
#toto <- ggplot(dfbis2,aes(x=period,y=value,fill=type,label=paste(covariable,":",round(value),"%",sep="")))+geom_col(width = 0.7) + geom_text(size = 3, position = position_stack(vjust = 0.5)) + theme_perso() + xlab("")+ylab("Pourcentage d'importance") + scale_fill_manual(values=couleur,name="Type") + 
```
## Analyse des différences cantonales des teneurs en CO

### Etat des lieux
```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Lecture des tables de travail

##RA
tablename <- paste("dm_traitements.","melted_ra",sep="")
melted.ra <- sqlQuery(loc,paste("select * from ",tablename,sep=""))
melted.radiff <- sqlQuery(loc,paste("select * from ",tablename,"diff",sep=""))
melted.radiff <- melted.radiff[complete.cases(melted.radiff$value) & complete.cases(melted.radiff$zonage_simple) & complete.cases(melted.radiff$zonage_cplt),]
melted.ra <- melted.ra[complete.cases(melted.ra$value) & complete.cases(melted.ra$zonage_simple) & complete.cases(melted.ra$zonage_cplt),]
melted.ra$annees <- factor(melted.ra$annees)

##BDATDiff
melted.bdatdiff <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdatdiff",sep=""))#,as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE))
melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff_med),]
levels(melted.bdatdiff$evol_med) <- list("Augmentation"="A","Diminution"="D","EI"="EI","Non significatif"="I")
reg_elevage <- c("A","B","C","D","E","F","G")

dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))
```

La proportion de type d'évolution des teneurs en CO pour les différentes périodes comparées (figure XX) montre qu'une importante partie des cantons ne subit pas d'évolution significative. L'évolution significative des teneurs touche environ 20 à 36% des cantons et les différences sont importantes entre les périodes comparées. Pour analyser dans le détail ces évolutions, la suite du travail se concentre sur 3 périodes clés :

* 15 : Cette comparaison correspond à l'évolution complète entre les deux dates les plus éloignée
* 13 : Correspond à première la moitié de la période étudiée et correspond 
* 35 : Correspond à la dernière moitiée de la période étudiée et affiche un important pourcentage de canton en augmentation


```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.align="center"}
# Voir pour créer un graphique facilement lisible d'un point de vue chronologique...
bdatdiff <- melted.bdatdiff[melted.bdatdiff$zonage_simple !="H" & melted.bdatdiff$period %in% c("13","15","35"),]
bdatdiff$diff_corgox <- as.factor(bdatdiff$evol_med)
couleur <- c("#4DAF4A","#E41A1C","#377EB8")

p <- list()
p[[1]] <- bdatdiff %>% 
          group_by(period,evol_med) %>% 
          summarise(count=n()) %>% 
          mutate(perc=round((count/sum(count))*100,1)) %>%
          ggplot(aes(x = factor(period), y = perc, fill = factor(evol_med),label=paste(perc,"%",sep=""))) +
          scale_fill_manual(values=couleur,name="Evolution des teneurs en CO")+
          geom_bar(stat="identity", width = 0.7) +
          geom_text(size = 3, position = position_stack(vjust = 0.5))+
          xlab("Périodes comparées")+ylab("Pourcentage de canton (%)")+
          theme_perso() + labs(title="a") + coord_flip()
p[[1]]
```

L'évolution des teneurs en CO à l'échelle cantonale sur toutes les périodes comparées et au niveau des principales régions d'élevage (voir figure) montre que les évolutions sont essentiellement non-significatives et qu'il existe un certain équilibre entre sur le nombre de canton avec une augmentation et une diminution significative des teneurs en CO. Seules les régions A, D et F se distinguent en présentant une proportion déséquilibrée dans le nombre de canton aux augmentation ou diminution significative. Les régions A et F montrent ainsi une part plus importante dans l'augmentation des teneurs en CO tandis que la région D est particulièrement touchée par la baisse des teneurs en CO.
 
```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=10,fig.align="center"}
# Histogramme des valeurs (ajouter les valeurs en %)
# Modif 31/05 c("13","15","35")
#bdatdiff <- melted.bdatdiff[melted.bdatdiff$zonage_simple !="H" & melted.bdatdiff$period %in% c("13","15","35"),]

p[[2]] <- bdatdiff %>% 
          group_by(period,zonage_simple,evol_med) %>% 
          summarise(count=n()) %>% 
          mutate(perc=round((count/sum(count))*100,1)) %>%

          ggplot(aes(x = factor(zonage_simple), y = perc, fill = factor(evol_med),label=paste(perc,"%",sep=""))) + facet_wrap(~period) +
          scale_fill_manual(values=couleur,name="Evolution des teneurs en CO")+
          geom_bar(stat="identity", width = 0.7) +
          geom_text(size = 3, position = position_stack(vjust = 0.5))+
          xlab("Principales régions d'élevage")+ylab("Pourcentage de canton (%)")+
          theme_perso() + labs(title="b")
          #+scale_y_continuous(labels=percent)
p[[2]]

tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=2,ncol=1,bottom="",left="")))
ggsave(tt,file = paste(repsortie,"diff_canton_histo.png",sep=""), width = 11, height = 9)  
ggsave(tt,file = paste(reppapier,"diff_canton_histo.png",sep=""), width = 11, height = 9)  
```

```{r,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.align="center"}

bdatdiff <- melted.bdatdiff[melted.bdatdiff$zonage_simple !="H" & melted.bdatdiff$period %in% c("13","15","35"),]
bdatdiff <- subset(bdatdiff,evol_med!="Non significatif")
code_regelevage <- read.csv(paste(repmetadonnees,"Nomenclature_regionelevage.csv",sep=""))

couleur <- as.character(code_regelevage[code_regelevage$Zonage_simple %in% reg_elevage,"Code_couleur_simple"])
occupsol <- "zonage_simple"
labelx <- "Principales régions d'élevage"
datatest <- bdatdiff[bdatdiff$zonage_simple %in% reg_elevage,]
datatest <- datatest[complete.cases(datatest[occupsol]),] 
wilcotest <- generate_label_df(db=datatest,value="diff_med_pourcent",lev=occupsol,letters,position=1)
lablex <- labelx
labley <- "Différences des teneurs en CO (%)"
p <- ggplot(datatest)+ geom_boxplot(aes_string(y="diff_med_pourcent",x=occupsol,fill="zonage_simple"))+ geom_hline(yintercept = 0,color="red") + scale_fill_manual(values=couleur,name="test") + geom_text(data = wilcotest, vjust=-0.75,aes(x = plot.labels, y = V1, label = labels)) + scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso() + theme(legend.position="none")# + facet_wrap(~period)
p

ggsave(p,file = paste(reppapier,"diff_canton_boxplotelevage.png",sep=""), width = 11, height = 9)  

## Même figure mais pour chaque pérode de temps comparée
reg_elevage <- c("A","B","C","D","E","F","G")
bdatdiff <- subset(melted.bdatdiff,evol_med!="Non significatif")
occupsol <- "zonage_simple"
p <- list()
cpt <- 0
for(i in c("13","15","35")){
  cpt <- cpt + 1
  datatest <- melted.bdatdiff[melted.bdatdiff$zonage_simple !="H" & melted.bdatdiff$period %in% i,]

##
  datatest <- datatest[complete.cases(datatest[occupsol]),] 
  wilcotest <- generate_label_df(db=datatest,value="diff_med_pourcent",lev=occupsol,letters,position=1)

  p[[i]] <- ggplot(datatest)+ geom_boxplot(aes_string(y="diff_med_pourcent",x=occupsol,fill="zonage_simple"))+ geom_hline(yintercept = 0,color="red") + scale_fill_manual(values=couleur,name="test") + geom_text(data = wilcotest, vjust=-0.75,aes(x = plot.labels, y = V1, label = paste(labels,"/",Nbr_analyse,sep=""))) +theme_perso() + theme(legend.position="none") + labs(title=i,x = NULL, y = NULL) + ylim(-50, 155)
}

tt <- do.call(grid.arrange,c(p,list(nrow=1,ncol=3,bottom="Principales régions d'élevage",left="Différences des teneurs en CO (%)")))

ggsave(tt,file = paste(reppapier,"diff_canton_boxplotelevage_periode.png",sep=""), width = 11, height = 9)  

# Valeur présente dans l'article
#bdatdiffsummary <- apply(datatest["diff_med"],2, function(x) tapply(x, datatest[,"zonage_simple"],summary))
#bdatdiffsummary <- lapply(bdatsummary, do.call, what = rbind)
```



```{r ,echo=FALSE,eval=FALSE,results='asis',fig.height=8, fig.width=10,fig.align="center"}
#ggplot(datasummary2, aes(ymin = StartDate, ymax = EndDate, x = Count)) + geom_linerange(aes(colour=value),size=3) + coord_flip() + scale_colour_gradient2(limit = c(min(datasummary2$value),max(datasummary2$value)),low="orange",high=muted("purple"),name="Taux d'évolution annuel (%)") + ylab("Périodes") + xlab("") + theme_perso() + geom_text(aes(fontface=2,y = StartDate, x = Count, label = ifelse(pvalue<=0.05,paste(round(value,1),"% **",sep=""),paste(round(value,1),"%",sep=""))), hjust = 0, vjust = 0.5, size = 3.5)# + labs(title= paste(i))

###############################################
evolbdat <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat.csv",sep=""),sep=",",colClasses = "character")

bdatdiff <- subset(melted.bdatdiff,evol_med!="I")

test <- bdatdiff %>% 
          group_by(period,evol_med) %>% 
          summarise(count=n()) %>% 
          mutate(perc=round((count/sum(count)),2))

testmerge <- merge(evolbdat,test,by.x="Code",by.y="period",all.x=TRUE,all.y=TRUE)
names(testmerge)[names(testmerge)=="Periode1"] <- "StartDate"
names(testmerge)[names(testmerge)=="Periode2"] <- "EndDate"
testmerge$StartDate <- as.factor(testmerge$StartDate)
testmerge$EndDate <- as.factor(testmerge$EndDate)

testmerge$StartDate <- factor(testmerge$StartDate,levels=c("9094","9599","0004","0509"))
testmerge$EndDate <- factor(testmerge$EndDate,levels=c("9599","0004","0509","1014"))
###Approfondir

ggplot(testmerge, aes(x = factor(Code),group=evol_med)) + 
geom_linerange(aes(ymin = as.character(StartDate) , ymax = as.character(EndDate) , colour=count),position=position_dodge(width = 0.5),size=5, alpha=0.9) + coord_flip() + scale_colour_gradient2(limit = c(min(testmerge$count),max(testmerge$count)),low="orange",high=muted("purple"),name="Nbr de canton")

ggplot(testmerge, aes(x = factor(Code),group=evol_med)) + 
geom_linerange(aes(ymin = as.character(StartDate),ymax = as.character(EndDate),colour=evol_med,x=),position=position_dodge(width = 0.5),size=5, alpha=0.9) + coord_flip()  #+ scale_colour_gradient2(limit = c(min(testmerge$count),max(testmerge$count)),low="orange",high=muted("purple"),name="Nbr de canton")
```

### Distribution spatiale des évolutions cantonales

La cartographie de l'évolution des teneurs en CO par canton pour les 3 périodes identifiées (figure XX) montre des tendances localisées à l'échelle régionale ou départementale. La baisse des teneurs en CO est marquée dans les hauts-de-Frances et le Morbihan entre les périodes (1990-1994)-(2000-2004) et (1990-1994)-(2010-2014). L'augmentation des teneurs dans certains canton est beaucoup plus disparate. Elle est particulièrement plus importante pour la période (2000-2004)-(2010-2014) et touche localement une partie de l'Aine, la Marne ainsi que le centre ouest avec le Loire-et-Cher, l'Eure-et-Loire et le Maine-et-Loire.

```{r,eval=FALSE,echo=FALSE}
tablecarto <- "dm_vecteurs.canton" 
periodetud <- c("15","13","35")
evolbdat <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat.csv",sep=""),sep=",",colClasses = "character")
evolbdat <- evolbdat[evolbdat$Code %in% periodetud,]
variablecarto <- paste("evol_med_",evolbdat[,"Code"],sep="")

titre <- paste(evolbdat[,"Periode1"],"-",evolbdat[,"Periode2"],sep="")

l_legend <- "Evolution des teneurs en CO"#label de la variable
nclasse <- 4 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
couleur <- c("#4DAF4A","#E41A1C","NA","#377EB8")#FDE725FF
#couleur <- viridis(nclasse)#("#04B404","#FE2E2E","#045FB4")#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "Median_diff_corgox3"

caption <- ""
carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_legend,repsortie,nomfichier,title=titre,caption=caption,dept=FALSE,reg=FALSE,nrowlayout=1,ncollayout=3,position="bottom",ggsaveheight=5,ggsavewidth=12)

tablecarto <- "dm_vecteurs.canton" 
periodetud <- c("15","13","35")
evolbdat <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat.csv",sep=""),sep=",",colClasses = "character")
evolbdat <- evolbdat[evolbdat$Code %in% periodetud,]
variablecarto <- paste("limt_evol_med_",evolbdat[,"Code"],sep="")

titre <- paste(evolbdat[,"Periode1"],"-",evolbdat[,"Periode2"],sep="")

l_legend <- "Evolution des teneur en limon totaux"#label de la variable
nclasse <- 4 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
couleur <- c("#4DAF4A","#E41A1C","NA","#377EB8")#FDE725FF
#couleur <- viridis(nclasse)#("#04B404","#FE2E2E","#045FB4")#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "Median_diff_limont"

caption <- ""
carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_legend,repsortie,nomfichier,title=titre,caption=caption,dept=FALSE,reg=FALSE,nrowlayout=1,ncollayout=3,position="bottom",ggsaveheight=5,ggsavewidth=12)

```

```{r map_evol_fr, echo = FALSE, eval=TRUE,results = 'asis'}
# Pour insérer l'image
nomfichier <- c("Median_diff_corgox3.png")
fichiers <- paste(repsortie,nomfichier,sep="")
cat(paste("![](",fichiers,")",sep=""))
```

### Facteurs contrôlant l'évolution des teneurs en carbone organique

#### Effet de la teneur en CO initiale

```{r,eval=TRUE,echo=FALSE}
load(paste(repsortie,"diff_initial_frR2.RData",sep=""))
test2 <- melt(rest,id=c("r2","coeff","Type"))
periodetud <- c("15","13","35")
test2 <- test2[test2$L1 %in% periodetud,]
colnames(test2)[4] <- "Periode"
test2$Type <- as.factor(test2$Type)
test2$Periode <- as.factor(test2$Periode)
levels(test2$Type) <- list("Augmentation"="A","Diminution"="D","EI"="EI","Non significatif"="I")
levels(test2$Periode) <- list("9094-1014"="15","9094-0004"="13","0004-1014"="35")
#levels(melted.bdatdiff$evol_med) <- list("Augmentation"="A","Diminution"="D","EI"="EI","Non significatif"="I")

```

L'effet de la teneur en CO initiale sur l'évolution des teneurs en CO des 3 comparaisons identifiées a été étudiées avec une régression linéaire. Celles-ci a été appliquée sur les 3 catégories d'évolution et la figure (XX) résume ces résultats en présentant les coefficient de détermination pour les comparaisons et les différentes catégories.
L'effet de la teneur en CO initiale est seulement significatif pour les analyses ayant une diminution significative des teneurs en CO. Pour cette catégorie, le coefficient varie entre les périodes comparées, allant de `r round(min(test2[test2$Type %in% "D","value"]),2)` à `r round(max(test2[test2$Type %in% "D","value"]),2)`. 

```{r,eval=TRUE,echo=FALSE}
p <- list()

p[[1]] <- ggplot(test2, aes(x=Periode,y=r2,colour=Type)) + geom_boxplot() +
  scale_x_discrete("")+scale_y_continuous("")+theme_perso(position="right") + scale_colour_manual(values=c("#04B404", "#FE2E2E","#045FB4"), name="Type d'évolution") + labs(title="a")  
p[[1]]

pp <- ggplot(test2, aes(x=Periode,y=r2,colour=Type)) + geom_boxplot() +
  scale_x_discrete("Périodes comparées")+scale_y_continuous("Coefficient de détermination non-ajusté (R2)")+theme_perso(position="right") + scale_colour_manual(values=c("#04B404", "#FE2E2E","#045FB4"), name="Type d'évolution")

ggsave(pp,file = paste(reppapier,"CO_initial_simple.png",sep=""), width = 9, height = 9)  

# Sortie vers un tableau
test2$r2 <- round(test2$r2,2)
test2$coeff <- round(test2$coeff,2)
library(xtable)
print(xtable(test2[,c("Periode","Type","r2","coeff")],caption=""),include.rownames=FALSE)

```

```{r,eval=FALSE,echo=FALSE}

load(paste(repsortie,"diff_initial_regR2.RData",sep=""))
test2 <- melt(rest)
periodetud <- c("15","13","35")
test2 <- test2[test2$Period %in% periodetud,]

p[[2]] <- ggplot(test2, aes(x=Period,y=value)) + facet_wrap(~L1) + geom_boxplot() +
  scale_x_discrete("")+scale_y_continuous("")+theme_perso(position="bottom") + scale_colour_manual(values=c("#04B404", "#FE2E2E","#045FB4"), name="Type d'évolution") + labs(title="b")  
p[[2]]


#tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=1,ncol=2,bottom="",left="")))
tt <- do.call(grid.arrange,c(p,list(nrow=1,ncol=2,bottom="Périodes comparées",left="Coefficient de détermination non-ajusté (R2)")))

ggsave(tt,file = paste(repsortie,"CO_initial.png",sep=""), width = 11, height = 9)  
ggsave(tt,file = paste(reppapier,"CO_initial.png",sep=""), width = 11, height = 9)  

```

#### Changement d'occupation du sol

```{r,eval=TRUE,echo=FALSE,results='asis',fig.height=8, fig.width=8,fig.align="center"}
#reg_elevage <- c("A","B1","B2","C1","C2","D","E1","E2","F2")
reg_elevage <- c("A","B","C","D","E","F","G")

colors <- brewer.pal(4,"Set1")#wes_palette("Rushmore",nperiod,type="continuous")
melted.ra_focus <- melted.ra[melted.ra$annees %in% c("1970","1979","1988","2000","2010") & melted.ra$variable %in% c("p_c","p_mf","p_prairie","p_sfp") & melted.ra$zonage_simple %in% reg_elevage,]
levels(melted.ra_focus$variable) <- c("Céréales","COP","Maïs-fourrage","Prairies","Surface fourragère principale","Surface Toujours en Herbe","UGBTA")

p_ra <- ggplot(melted.ra_focus,aes(x=annees,y=value,col=variable)) + facet_wrap(~zonage_simple) + stat_summary(fun.y=mean, geom="line",size = 1.5, aes(group=variable,color=variable))  + 
            #geom_smooth(aes(group=variable,color=variable),method=loess)+
            xlab("Années") +
            scale_color_manual(values=colors,name="Occupation du sol")+
            scale_y_continuous("Occupation du sol (% de SAU)")+
            theme_classic()+
            theme_perso()
p_ra

ggsave(p_ra,file = paste(reppapier,"evolution_ra_elevage.png",sep=""), width = 10, height = 10)  
```

#### L'effet du changement d'occupation du sol 

```{r,eval=TRUE,echo=FALSE,fig.height=9, fig.width=11,fig.align="center",results='asis'}

melted.bdatdiff <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdatdiff",sep=""))
melted.bdatdiff$diff_med <- as.numeric(melted.bdatdiff$diff_med)
melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff_med),]
melted.bdatdiff$diff_med_pourcent <- as.numeric(melted.bdatdiff$diff_med_pourcent)
melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff_med_pourcent),]
bdatdiff <- subset(melted.bdatdiff,evol_med!="I")

p_variable <- c("sfp","mf","prairie","c")
nomdiff <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat.csv",sep=""),sep=",",colClasses = "character")
periodetud <- c("13","35","15")
nomdiff <- nomdiff[nomdiff$Code %in% periodetud,]
nomperiodiff <- read.csv(paste(repmetadonnees,"Nomenclature_evolutionbdat_ra.csv",sep=""),sep=",",colClasses = "character")
colors <- brewer.pal(8,"Set1")

# Test pour par région
# bdatdiff <- bdatdiff[bdatdiff$zonage_simple %in% c("A","B","D"),]

p <- list()
cpt <- 0
for(x in nomdiff$Code){

  Period1 <- nomdiff[(nomdiff$Code %in% x),"Periode1"]
  Period1_RA <- nomperiodiff[nomperiodiff$Periode_BDAT==Period1,"Periode_RA"]
  Period2 <- nomdiff[(nomdiff$Code %in% x),"Periode2"]
  Period2_RA <- nomperiodiff[nomperiodiff$Periode_BDAT==Period2,"Periode_RA"]

  # Construction des variables à analyser
  ra_occupyears <- apply(expand.grid(p_variable,Period1_RA,Period2_RA),1, function(x){paste("diff_var_",x[1],x[2],"_",x[3],sep="")})
  
  for(i in ra_occupyears){
    cpt <- cpt + 1
    datatest <- bdatdiff[complete.cases(bdatdiff[i]) & bdatdiff$period==x,] 

    datatest[,i] <- as.factor(datatest[,i])
    levels(datatest[,i]) <- c("A","D","I")

    wilcotest <- generate_label_df(db=datatest,value="diff_med",lev=i,letters,position=0.6)

    labley <- ""
    lablex <- paste(gsub("^diff_var_*","",i),sep="")

    if(cpt==1 | cpt==5 | cpt==9){
      titre <- paste(Period1,"-",Period2,sep="")
    }else{titre <- ""}
    
    p[[paste(i,x,sep="")]] <- ggplot(datatest,aes_string(y="diff_med",x=i))+geom_boxplot()+
       #geom_point(aes(colour=zonage_simple),position = position_jitter(width = 0.1),alpha = 0.7)+
      coord_flip() + geom_hline(yintercept = 0,color="black") + geom_text(data = wilcotest, vjust=-0.75,aes(x = plot.labels, y = V1, label = labels),color="red",size=6) + scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso()+labs(title=titre)+scale_color_manual(values=colors,name="Région d'élevage")#+theme(axis.text.y = element_text(angle = 45, hjust = 0))
  }
}

tt <- do.call(grid.arrange,c(p,list(nrow=3,ncol=4,bottom="Différences des teneurs en CO (g/kg)",left="Type d'évolution de l'occupation du sol")))

ggsave(tt,file = paste(reppapier,"evolution_ra_CO.png",sep=""), width = 14, height = 10)  


#tt <- do.call(grid_arrange_shared_legend,c(p,list(nrow=3,ncol=4,bottom="Différences des teneurs en CO (g/kg)",left="Type d'évolution de l'occupation du sol")))
```

```{r,eval=TRUE,echo=FALSE,fig.height=9, fig.width=11,fig.align="center",results='asis'}
p <- list()
cpt <- 0
for(x in nomdiff$Code){

  Period1 <- nomdiff[(nomdiff$Code %in% x),"Periode1"]
  Period1_RA <- nomperiodiff[nomperiodiff$Periode_BDAT==Period1,"Periode_RA"]
  Period2 <- nomdiff[(nomdiff$Code %in% x),"Periode2"]
  Period2_RA <- nomperiodiff[nomperiodiff$Periode_BDAT==Period2,"Periode_RA"]

  # Construction des variables à analyser
  ra_occupyears <- apply(expand.grid(p_variable,Period1_RA,Period2_RA),1, function(x){paste("diff_var_",x[1],x[2],"_",x[3],sep="")})
  
  for(i in ra_occupyears){
    cpt <- cpt + 1
    datatest <- bdatdiff[complete.cases(bdatdiff[i]) & bdatdiff$period==x,] 

    datatest[,i] <- as.factor(datatest[,i])
    levels(datatest[,i]) <- c("A","D","I")

    #wilcotest <- generate_label_df(db=datatest,value="diff_med",lev=i,letters,position=0.6)

    labley <- ""
    lablex <- paste(gsub("^diff_var_*","",i),sep="")

    if(cpt==1 | cpt==5 | cpt==9){
      titre <- paste(Period1,"-",Period2,sep="")
    }else{titre <- ""}
    
    p[[paste(i,x,sep="")]] <- ggplot(datatest,aes_string(y="diff_med",x=i))+geom_boxplot() + facet_wrap(~zonage_simple) + coord_flip() + geom_hline(yintercept = 0,color="red") + scale_x_discrete(lablex)+scale_y_continuous(labley)+theme_perso()+labs(title=titre)#+theme(axis.text.y = element_text(angle = 45, hjust = 0))
  }
}

tt <- do.call(grid.arrange,c(p,list(nrow=3,ncol=4,bottom="Différences des teneurs en CO (g/kg)",left="Type d'évolution de l'occupation du sol")))
```
