---
title: "Traitement des données de la BDAT :Evolution des teneurs en carbone organique"
author: "Jean-Baptiste Paroissien"
date: "21/12/2016"
output:
  html_notebook:
    toc: true
    fig_caption: true
    highlight: zenburn
    number_sections: yes
    theme: spacelab
---


```{r setup, include=FALSE,eval=TRUE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
repsortie <- paste(repmaster,"Scripts/master/Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers
```

```{r, tidy=FALSE,eval=TRUE}
Sys.Date()
sessionInfo()
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Chargement des tables de travail
variaoccup <- c("p_sth","p_sfp","p_prairie")
periodoccup <- c("1970","1979","1988","2000","2010")
id_class <- apply(expand.grid(variaoccup,periodoccup),1, function(x){paste("classe_",x[1],x[2],sep="")})
id_variaoccup <- c("classe_var_sth7910","classe_var_cereale7910","classe_var_sfp7910")
id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt",id_class,id_variaoccup) #Nom des identifiants
variafactor <- paste(id,collapse=",")

# Lecture des tables de travail
melted.bdatdiff <- sqlQuery(loc,paste("select diffmedian,diff,period,",variafactor," from dm_traitements.melted_bdatdiff",sep=""),as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE))
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))

melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff),]
```


# Analyse de l'évolution des teneurs en carbone organique 

Pour cette partie, on se base sur les résultats fournis par InfoSol...Plusieurs analyses sont proposées en lien avec les objectifs suivants :

- Identifier la distribution spatiale de l'évolution à l'échelle de la france : Cartographie, boxplot du nombre de canton qui évolue par différents niveaux de stratification
- Analyse de la distribution. Quelle sont les principaux facteurs qui expliquent ces évolutions ?

## Analyse du nombre d'évolution significative par canton

Dans la figure ci-dessous,

Analyser la figure en la confrontant avec des graphiques similaires basés sur les données du RA et de CLC.
Ce serait intéressant de développer un indice de changement d'occupation du sol pour faciliter les analyses.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Histogramme des valeurs 

# Sélection des cantons aux diminutions significatives
bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff),]

# Sélection
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
periodetud <- c("14","24","15","25")
bdatdiff <- bdatdiff[(bdatdiff$period %in% periodetud) & bdatdiff$zonage_simple != "H" & bdatdiff$zonage_simple != "G" & bdatdiff$zonage_simple != "F", ]
bdatdiff$diff <- as.factor(bdatdiff$diff)
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
ggplot(bdatdiff,aes(diff,fill=zonage_simple)) + geom_bar() + facet_wrap(~ period)

# Sélection de la zone d'élevage B
bdatdiff_B <- bdatdiff[bdatdiff$zonage_simple %in% "B",]
ggplot(bdatdiff_B,aes(diff,fill=nom_region)) + geom_bar(position="dodge") + facet_wrap(~ period)
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Histogramme des valeurs 

# Sélection des cantons aux diminutions significatives
bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff) & complete.cases(melted.bdatdiff$classe_var_sth7910),]

# Sélection
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
periodetud <- c("14","24","15","25")
bdatdiff <- bdatdiff[(bdatdiff$period %in% periodetud), ]
bdatdiff$diff <- as.factor(bdatdiff$diff)

ggplot(bdatdiff,aes(diff,fill=classe_var_sth7910)) + geom_bar(position="dodge") + facet_wrap(~ period)

# Sélection de la zone d'élevage B
bdatdiff_B <- bdatdiff[bdatdiff$zonage_simple %in% "B",]
ggplot(bdatdiff_B,aes(diff,fill=nom_region)) + geom_bar(position="dodge") + facet_wrap(~ period)

```





```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
## Revoir

p <- ggplot(melted.bdatharmo) +
            geom_boxplot(aes(x=period,y=value,col=typo_clim))+
            #scale_color_manual(name="Années")+
            scale_x_discrete("Années")+scale_y_continuous("Teneur en carbone (g/kg)")+
            theme(plot.title = element_text(size = 14, face = "bold"), 
                  text = element_text(size = 12),
                  axis.title = element_text(face="bold"),
                  axis.text.x=element_text(size = 11))
p 

```


## Cartographie

oK, REVOIR LES JOINTURES AVEC LES DONNÉES, résultats à prendre avec des pincettes.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE,message=FALSE}
tablecarto <- "dm_vecteurs.canton" 
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" 
variablecarto <- c("diff15","diff14","diff24","diff25") #variable à spatialiser
l_legend <- "Evolution des teneurs en C"#label de la variable
nclasse <- 3 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
couleur <- "Spectral"#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "diff12"

# Lancement
cartoperiod(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend=l_legend,repsortie,nomfichier,dept=FALSE,reg=FALSE)
```






```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Voir les graphiques de "différence" réalisés durant le M1
# Rajouter les types de climat ou autre niveau de stratification pour voir l'influence de ces régions sur les pertes 
# Voir également pour rajouter ces données sur une table au format melt
plot(dcast.bdat$corgox_med9599,dcast.bdat$varcorgox_med0004_9599)

plot(dcast.bdat$corgox_med9599,dcast.bdat$diffcorgox_med0004_9599)

# Calculer les évolutions
varcorgox_med0004_9599 
varcorgox_med0509_9599
varcorgox_med0509_9094
varcorgox_med0004_9094
diffcorgox_med0004_9599
diffcorgox_med0509_9599
diffcorgox_med0509_9094
diffcorgox_med0004_9094

test <- dcast.bdat[,c("corgox_med9094","corgox_med9599","corgox_med0004","corgox_med0509")]
ggpairs(test)

```


