---
title: "Traitement des données de la BDAT : Evolution des teneurs en carbone organique"
author: "Jean-Baptiste Paroissien"
date: "27/01/2017"
output:
  github_document:
    toc: true
    toc_depth: 2
    fig_width: 10
    fig_height: 10
    dev: png
    md_extensions: +autolink_bare_uris+hard_line_breaks+header_attributes+line_blocks+table_captions
---


```{r setup, include=FALSE,eval=TRUE,echo=FALSE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
repsortie <- paste(repmaster,"/Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers
```
```{r,eval=TRUE,echo=FALSE}
## This chunck will read through *this* Rmd file, and attempt to extract all of the 
## labels (not caption text) used for Figure captions. These labels are used
## as anchors, so scanning through the document now will allow us to create cross references
## before the caption actually appears. 

## Get the name of this Rmd file
rmdFn <- knitr::current_input()  # filename of input document

## Read lines and close connection
rmdCon <- file(rmdFn, open = "r")
rmdLines <- readLines(rmdCon)
close(rmdCon)

## Pull out all occurences of at least one back tick, followed 
## by any number of characters, followed by fig$cap (all on one line)
figscap_idx <- grep("`+(.*)fig\\$cap", rmdLines)
rmdLines <- rmdLines[figscap_idx]

## Get rid of everything up until the start of the caption label
## This presumes the caption label is the first argument of fig$cap()
## E.g., fig.cap = fig$cap("my_label", ...)
rmdLinesSansPre <- sub("(.*)fig\\$cap(.*?)[\"']", "", rmdLines)

## Identify everything up until the first quote
match_data <- regexpr("(.*?)[\"']", rmdLinesSansPre)

## Reduce the length by one, because we're not interested in the final quote
attr(match_data, "match.length") <- attr(match_data, "match.length") - 1

## Extract
fig_labels <- regmatches(rmdLinesSansPre, match_data, invert=FALSE)

if (length(fig_labels) > 0) {

    ## Test for duplicates
    if (anyDuplicated(fig_labels) > 0) stop("Duplicate caption labels detected")
    
    ## Create a named list of Figure numbers
    ref <- as.list(1:length(fig_labels))
    names(ref) <- fig_labels
}    
```

```{r, tidy=FALSE,eval=FALSE,echo=FALSE}
Sys.Date()
sessionInfo()
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Lecture des tables de travail

##RA
tablename <- paste("dm_traitements.","melted_ra",sep="")
melted.ra <- sqlQuery(loc,paste("select * from ",tablename,sep=""))
melted.radiff <- sqlQuery(loc,paste("select * from ",tablename,"diff",sep=""))
melted.radiff <- melted.radiff[complete.cases(melted.radiff$value) & complete.cases(melted.radiff$zonage_simple) & complete.cases(melted.radiff$zonage_cplt),]
melted.ra <- melted.ra[complete.cases(melted.ra$value) & complete.cases(melted.ra$zonage_simple) & complete.cases(melted.ra$zonage_cplt),]
melted.ra$annees <- factor(melted.ra$annees)

##BDATDiff
melted.bdatdiff <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdatdiff",sep=""))#,as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE))
melted.bdatdiff$diffmedian <- as.numeric(melted.bdatdiff$diffmedian)
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))
melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff),]

##BDAT
melted.bdat <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdat",sep=""),as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE))
period <- c("9094","9599","0004","0509","1014")
melted.bdat$value <- as.numeric(melted.bdat$value)
melted.bdat <- melted.bdat[complete.cases(melted.bdat$value),]
melted.bdat$annees <- factor(melted.bdat$annees,levels=period)

#temp 15/02
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton_cplt",sep=""))

```

# Objectifs

Ici, on s'intéresse aux résultats sur les évolutions des teneurs en carbone. Les résultats ont été fournis par InfoSol et résultent d'un ré-échantillonnage des analyses de la bdat communales réalisées 100 fois. Plusieurs analyses sont réalisées :

- Identifier la distribution spatiale de l'évolution à l'échelle de la france : Cartographie, boxplot du nombre de canton qui évolue par différents niveaux de stratification
- Analyse de la distribution. Quelle sont les principaux facteurs qui expliquent ces évolutions ?


# Analyse de l'évolution des teneurs en carbone organique à l'échelle nationale

A l'échelle nationale, on souhaite avoir une vision des évolutions générales des teneurs en C, appréhender les zones les plus touchées, savoir si ces évolutions sont significatives ou non.

## Analyse du nombre d'évolution significative par canton

La figure `r fig$ref("histo_evolution",link=TRUE)` présente un histogramme du nombre de canton ayant connu une augmentation ou une diminution significative des teneurs en carbone organique. L'histogramme est appliqué sur toutes les périodes et stratifié par zones d'élevage.
La figure montre un équilibre entre le nombre de canton ayant eu une augmentation et le nombre de canton ayant eu une diminution de la teneur en carbone organique. La proportion des zones d'élevage entre les classes d'augmentation et de diminution est relativement équilibrée mais quelques zones se distinguent :

- Les régions B1, C2 et D sont davantage affectées par la diminution des teneurs en C
- Les région A et C1 sont plus affectées par des augmentations que des diminutions. 

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=10,fig.cap = fig$cap("histo_evolution",""),fig.align="center"}
# Histogramme des valeurs 

# Sélection des cantons aux diminutions significatives
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
bdatdiff <- melted.bdatdiff

histo_evol <- ggplot(bdatdiff,aes(zonage_cplt,fill=diff)) + geom_bar(position="fill") + #scale_y_continuous(labels = percent_format())+
 #geom_bar()+
#                    facet_grid(~period) +
                    scale_fill_brewer(palette = 'Paired',name="Evolution des teneurs en C")+
                    xlab("Zones d'élevage")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11))    
                    #geom_bar(position="dodge")
histo_evol

ggsave(histo_evol,file = paste(repsortie,"histo_evolution1.png",sep=""), width = 10, height = 6)  

```
Dans la figure `r fig$ref("histo_evolution_period",link=TRUE)`, les histogrammes sont analysés pour des écarts entre les périodes étudiées d'au moins 10 ans. La figure montre des différences importantes entre les périodes analysées :

- L'évolution des teneurs est équilibrée entre les périodes [1994-1999]-[2010-2014] et les périodes [1990-1994]-[2010-2014],
- Les différences entre les périodes [1990-1994]-[2000-2004] et [1994-1999]-[2005-2009] montrent une part importante pour la diminution des teneurs en C. Dans une moindre mesure, la différence entre les périodes [1990-1994]-[2005-2009] présente une part de diminution des teneurs en C plus importante que l'augmentation.
- A l'inverse, les teneurs en C ont augmenté majoritairement entre les périodes [2000-2004]-[2010-2014].

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=6, fig.width=12,fig.cap = fig$cap("histo_evolution_period",""),fig.align="center"}
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
periodetud <- c("14","24","15","25","13","35")

# Pour voir...
enplus <- c("12","45","23")
periodetud <- c(periodetud,enplus)

bdatdiff <- bdatdiff[(bdatdiff$period %in% periodetud) & bdatdiff$zonage_simple != "H" & bdatdiff$zonage_simple != "G" & bdatdiff$zonage_simple != "F", ]
bdatdiff$diff <- as.factor(bdatdiff$diff)

histo_regelevage <- ggplot(bdatdiff,aes(diff,fill=zonage_cplt)) + geom_bar() + facet_wrap(~ period)+
                    scale_fill_brewer(palette = 'Paired',name="Zones d'élevage")+
                    xlab("Classe d'évolution des teneurs en carbone organique")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11))    
                    #geom_bar(position="dodge")
histo_regelevage
ggsave(histo_regelevage,file = paste(repsortie,"histo_regelevage.png",sep=""), width = 12, height = 6)  


```
**En conclusion** de cette section, on constate plusieurs points :

- Les évolutions des teneurs en C entre les différentes périodes ne suivent pas les mêmes tendances. Les premières observation vues dans [FS_traitements_bdat.Rmd](`r github_url`Fichiers_suivis/Traitements/Suivis/FS_traitements_bdat.Rmd) se confirment. Les teneurs en C ont augmenté sur la période [2010-2014] et cette augmentation est particulièrement prononcée entre les périodes [2000-2004]-[2010-2014].
- La diminution des teneurs est surtout observée entre [1990-1994]-[2000-2004] et [1994-1999]-[2005-2009] et [1990-1994]-[2005-2009].
- Les principales zones d'élevage affectées par ces changements sont : A, B1, C1, C2 et D. Ce résultat provient surtout de la densité d'analyse dans ces zones et de leur étendue spatiale.

## Analyse sur les périodes identifiées

Dans la suite, on s'intéressera uniquement aux périodes concernées par les changements importants idenfiés dans le paragraphe précédent, à savoir : [2000-2004]-[2010-2014], [1990-1994]-[2000-2004],[1994-1999]-[2005-2009] et [1990-1994]-[2005-2009].

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,fig.height=5, fig.width=14,fig.cap = fig$cap("bar_prairie","Histogramme à commenter"),fig.align="center"}
# Sélection des cantons aux diminutions significatives
bdatdiff_classe <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff) & melted.bdatdiff$diff !="Non significatif",]
periodetud <- c("13","24","35","14")
zone_elevage <- c("A","B1","C1","C2","D")

bdatdiff_classe <- bdatdiff_classe[(bdatdiff_classe$period %in% periodetud) & (bdatdiff_classe$zonage_cplt %in% zone_elevage),]
bdatdiff_classe$diff <- as.factor(bdatdiff_classe$diff)

# Histogramme des valeurs 
histo_regionadmin <- ggplot(bdatdiff_classe,aes(diff,fill=nom_region)) + geom_bar(position="dodge") + facet_wrap(~ period) + 
                    xlab("Classe d'évolution des teneurs en carbone organique")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11),
                    legend.position="bottom")                      
histo_regionadmin
ggsave(histo_regionadmin,file = paste(repsortie,"histo_regionadmin.jpg",sep=""), width = 14, height = 5)  
```
De la figure ci-dessus, les 10 principales régions touchées par des évolutions significatives sont présentées dans le tableau ci-dessous.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,results='asis'}
# Sélection
histo_table <- count(bdatdiff_classe,c("diff","nom_region","period"))
histo <- histo_table[order(-histo_table[,"freq"]),][1:10,]
pander(histo,style = "rmarkdown",caption = "Principales régions touchées par des évolutions significatives")

xtable(histo)

```

La région Centre et les pays de la Loire ont une fréquence importante de canton ayant une augmentation de C.
Le Nord-pas-de-Calais, la Bretagne, la Picardie et la région Poitou-Charentes sont les principales régions touchées par des diminutions en C.

## Cartographie des évolutions

On retrouve ces observations sur les cartes d'évolution des teneurs. Dans le détail, c'est le morbihan qui est surtout affecté par des chutes de teneurs en carbone organique et en région Centre, on observe une augmentation des teneurs concentrée dans le Perche.
Ces résultats très ciblés font penser à un effet de bord (différences liés aux laboratoires?), surtout pour les régions Picardie, Nord-Pas-De-Calais et le département du Morbihan. **La suite des analyses se concentrera sur ces zones.**

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE,message=FALSE}
# Cartographie des résultats des tests statistiques
tablecarto <- "dm_vecteurs.canton" 
variablecarto <- c("diffmedian13","diffmedian24","diffmedian35","diffmedian14") #variable à spatialiser
l_legend <- "Evolution des teneurs en C"#label de la variable
nclasse <- 4 #Nombre de classes de valeurs pour la cartographie
style_classe <- "quantile" #"pretty"#"jenks","fixed"
couleur <- "Spectral"#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "Median_evolu_c"

carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend,repsortie,nomfichier,dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=2,position="bottom",ggsaveheight=10,ggsavewidth=10)

variablecarto <- c("diff13","diff24","diff35","diff14") #variable à spatialiser
l_legend <- "Evolution des teneurs en C"#label de la variable
nclasse <- 4 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
couleur <- "Set1"#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "Median_diff_c"

carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend,repsortie,nomfichier,dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=2,position="bottom",ggsaveheight=10,ggsavewidth=10)
```

```{r map_evol_fr, echo = FALSE, eval=TRUE,results = 'asis'}
# Pour insérer l'image
nomfichier <- c("Median_evolu_c.png","Median_diff_c.png")
fichiers <- paste(repsortie,nomfichier,sep="")
cat(paste("![](",fichiers,")",sep=""))
```

# Modélisation test avec GBM


```{r,eval=FALSE,echo=FALSE}
Rcovarclimato <- c("std_temp_janv","std_temp_juil","std_pluie_janv","std_pluie_juil")
typeclimato <- replicate(length(Rcovarclimato), "climat")
#
Rcovaroccup <- c("var_sth1970_2000","var_sth1979_2000","var_sth1988_2000","var_c1970_2000","var_c1979_2000","var_c1988_2000","var_sfp1970_2000","var_sfp1979_2000","var_sfp1988_2000","var_mf1970_2000","var_mf1979_2000","var_mf1988_2000","var_prairie1970_2000","var_prairie1979_2000","var_prairie1988_2000","var_ugb1988_2010","var_cop1988_2000","var_cop1979_2000","var_sth1970_2010","var_sth1979_2010","var_sth1988_2010","var_c1970_2010","var_c1979_2010","var_c1988_2010","var_sfp1970_2010","var_sfp1979_2010","var_sfp1988_2010","var_mf1970_2010","var_mf1979_2010","var_mf1988_2010","var_prairie1970_2010","var_prairie1979_2010","var_prairie1988_2010","var_ugb1988_2010","var_cop1988_2010","var_cop1979_2010","eff9094","eff9599","eff0004","eff0509","eff1014")

# Calcul de la différence en relatif
dcast.bdat$reladiff14 <- ((dcast.bdat[,"corgox_medequi1014"]-dcast.bdat[,"corgox_medequi9094"])/dcast.bdat[,"corgox_medequi9094"])*100

typeoccup <- replicate(length(Rcovaroccup), "occup")

type <- c(typeclimato,typeoccup)
Rcovar <- c(Rcovarclimato,Rcovaroccup)
type <- c(typeclimato,typeoccup)
Rcovar <- c(Rcovarclimato,Rcovaroccup)

vNames <- c("reladiff14",Rcovar)

set.seed(157) #Pour assurer la reproductibilité
registerDoMC(4)

## On se concenre sur la période 14
#d <- dcast.bdat[(dcast.bdat$code_reg %in% reg_focus) & complete.cases(dcast.bdat[,vNames]),][,c(vNames)]
d <- dcast.bdat[complete.cases(dcast.bdat[,vNames]),][,c(vNames)]

trainrows <- runif(nrow(d)) > 0.2
train <- d[trainrows,] #Données pour l'apprentissage
test <- d[!trainrows,] #Données pour test

set.seed(157) #Pour assurer la reproductibilité
registerDoMC(4)
#formula <- as.formula(paste(vNames[1],"~",paste(vNames[-1],collapse="+"),sep=""))
trControl <- trainControl(method = "cv",p=0.8,number=50)
tuneGrid <- expand.grid(interaction.depth = c(1, 5, 9),n.trees = (1:10)*150,shrinkage = c(0.1,0.5),n.minobsinnode = c(10,20))

##
datax <- d[, vNames[-1]]
datay <- d[, vNames[1]]

# Utilisation de caret, car plus rapide qu'une simple fonction gbm
mgbm_diff <- train(x = datax , y = datay,method="gbm",tuneGrid = tuneGrid,trControl = trControl,verbose = F,keep.data = T)
##

save(mgbm_diff,file=paste(repsortie,"mgbm_diff.RData",sep=""))
load(paste(repsortie,"mgbm_diff.RData",sep=""))
# Maintenant, on lancer le code x fois avec les paramètres de modélisation optimisé
# Calcul de la moyenne de l'importance + du résultat de prédiction (30% du jeu de données indépendant)
trControl <- trainControl(method = "cv",p=0.8,number=10)
tuneGrid <- expand.grid(interaction.depth = mgbm_diff$bestTune$interaction.depth,n.trees = mgbm_diff$bestTune$n.trees,shrinkage = 0.1,n.minobsinnode = 10)

nbr <- 100
prob <- 0.8
rest <- array(NA, dim = c(nbr, 3),list(loop = 1:nbr, mod = c("r2","MSE","RMSE")))
importVar <- array(NA, dim = c(length(vNames)-1,nbr+1))
pvar <- list()

cpt <- 0
for (i in 1:nbr){
  cpt <- cpt + 1
  print(i)
  set.seed(157+i)
  gc()  
  # randomizes the mask 
  masko <- createDataPartition(d[,1],p = prob, list = FALSE)
  
  donneeL <- d[masko,]
  donneeV <- d[-masko,]
  learningx <- datax[masko,]
  learningy <- datay[masko]
  indepx <- datax[-masko,]
  indepy <- datay[-masko]

  mgbm_NPD <- train(x = learningx , y = learningy,"gbm",tuneGrid = tuneGrid,trControl = trControl,verbose = F,keep.data = T)
 
  pvar[[i]] <- varImp(mgbm_NPD)
  
  vaript <- summary(mgbm_NPD,plotit=FALSE)
  vaript <- vaript[order(vaript$var),]
  importVar[,1] <- as.character(vaript$var)
  importVar[,cpt] <- as.numeric(vaript$rel.inf)

  f.predict <- predict(mgbm_NPD$finalModel, learningx , n.trees = mgbm_NPD$bestTune$n.trees)
  
  ### External validation on independent data ###   
  indep.pred <- predict(mgbm_NPD$finalModel, indepx , n.trees=mgbm_NPD$bestTune$n.trees)

  rest[i,"r2"] <- round(cor(indep.pred,indepy,use="na.or.complete")^2,4)
  rest[i,"MSE"] <- mean((indep.pred-indepy)^2,na.rm=TRUE)
  rest[i,"RMSE"] <- mean((indep.pred-indepy)^2,na.rm=TRUE)^0.5
}

summary(rest)

save(rest,file=paste(repsortie,"rest_NPC.RData",sep=""))
save(importVar,file=paste(repsortie,"importVar_NPC.RData",sep=""))

datapred <- as.data.frame(cbind(indep.pred,indepy))

p_corel_NPC <- ggplot(datapred, aes(indep.pred,indepy)) +
            geom_point(alpha = 0.8, size = 2) +
            scale_x_continuous("Evolution des teneurs en carbone prédites (%)")+scale_y_continuous("Evolution des teneurs en carbone observée (%)")+
            theme(plot.title = element_text(size = 14, face = "bold"), 
            text = element_text(size = 12),
            axis.title = element_text(face="bold"),
            axis.text.x=element_text(size = 11))+ labs(title=i)+
            annotate("text", x=-20, y=20, label=lm_eqn(lm(datapred[,"indep.pred"]~datapred[,"indepy"], datapred)), parse=TRUE)+
            geom_smooth(method = "lm", se = FALSE,color="black")    

ggsave(p_corel_NPC,file = paste(repsortie,"p_corel_NPC.jpg",sep=""), width = 8, height = 8)  

varimp <- as.data.frame(importVar[,-1])

n <- 0
for(i in 1:nbr){
    n <- n + 1
    varimp[,n] <- as.numeric(varimp[,n])
}

MeanimportVar <- apply(varimp, 1, function(x){median(x,na.rm=TRUE)}) 

#MeanimportVar <- rowMeans(varimp,na.rm=TRUE)           
MeanimportVar <- cbind.data.frame(importVar[,1],MeanimportVar)
colnames(MeanimportVar) <- c("variable","importance")

MeanimportVar <- MeanimportVar[with(MeanimportVar, order(-importance)),]
varimport <- MeanimportVar[1:15,]
varimport$variable <- reorder(varimport$variable, varimport$importance)

varimport$type <- varimport$variable
varimport$type <- gsub2(as.character(Rcovar),type,as.character(varimport$variable))#Ajout du type de facteurs

pimp <- ggplot(varimport, aes(x = variable, y = importance,fill=type)) + 
  geom_bar(stat = "identity") + coord_flip()

ggsave(pimp,file = paste(repsortie,"pimp_NPC.jpg",sep=""), width = 8, height = 8)  


```


