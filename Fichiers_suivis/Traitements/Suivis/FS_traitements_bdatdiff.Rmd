---
title: "Traitement des données de la BDAT :Evolution des teneurs en carbone organique"
author: "Jean-Baptiste Paroissien"
date: "27/01/2017"
output:
  github_document:
    toc: true
    toc_depth: 2
    fig_width: 10
    fig_height: 10
    dev: png
    md_extensions: +autolink_bare_uris+hard_line_breaks+header_attributes+line_blocks+table_captions
---


```{r setup, include=FALSE,eval=TRUE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
repsortie <- paste(repmaster,"Scripts/master/Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers
```
```{r,eval=TRUE,echo=FALSE}
## This chunck will read through *this* Rmd file, and attempt to extract all of the 
## labels (not caption text) used for Figure captions. These labels are used
## as anchors, so scanning through the document now will allow us to create cross references
## before the caption actually appears. 

## Get the name of this Rmd file
rmdFn <- knitr::current_input()  # filename of input document

## Read lines and close connection
rmdCon <- file(rmdFn, open = "r")
rmdLines <- readLines(rmdCon)
close(rmdCon)

## Pull out all occurences of at least one back tick, followed 
## by any number of characters, followed by fig$cap (all on one line)
figscap_idx <- grep("`+(.*)fig\\$cap", rmdLines)
rmdLines <- rmdLines[figscap_idx]

## Get rid of everything up until the start of the caption label
## This presumes the caption label is the first argument of fig$cap()
## E.g., fig.cap = fig$cap("my_label", ...)
rmdLinesSansPre <- sub("(.*)fig\\$cap(.*?)[\"']", "", rmdLines)

## Identify everything up until the first quote
match_data <- regexpr("(.*?)[\"']", rmdLinesSansPre)

## Reduce the length by one, because we're not interested in the final quote
attr(match_data, "match.length") <- attr(match_data, "match.length") - 1

## Extract
fig_labels <- regmatches(rmdLinesSansPre, match_data, invert=FALSE)

if (length(fig_labels) > 0) {

    ## Test for duplicates
    if (anyDuplicated(fig_labels) > 0) stop("Duplicate caption labels detected")
    
    ## Create a named list of Figure numbers
    ref <- as.list(1:length(fig_labels))
    names(ref) <- fig_labels
}    
```

```{r, tidy=FALSE,eval=TRUE}
Sys.Date()
sessionInfo()
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Lecture des tables de travail
melted.bdatdiff <- sqlQuery(loc,paste("select * from dm_traitements.melted_bdatdiff",sep=""),as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE,TRUE))
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))

melted.bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff),]
```

# Objectifs

Ici, on s'intéresse aux résultats sur les évolutions des teneurs en carbone. Les résultats ont été fournis par InfoSol et résultent d'un ré-échantillonnage des analyses de la bdat communales réalisées 100 fois. Plusieurs analyses sont réalisées :

- Identifier la distribution spatiale de l'évolution à l'échelle de la france : Cartographie, boxplot du nombre de canton qui évolue par différents niveaux de stratification
- Analyse de la distribution. Quelle sont les principaux facteurs qui expliquent ces évolutions ?


# Analyse de l'évolution des teneurs en carbone organique à l'échelle nationale

A l'échelle nationale, on souhaite avoir une vision des évolutions générales des teneurs en C, appréhender les zones les plus touchées, savoir si ces évolutions sont significatives ou non.


## Cartographie des évolutions

Description des cartes :

- Répartition des zones touchées par des augmentations ou diminutions significatives. Prendre en compte aussi les différences observées entre les périodes de temps analysées
- Faire un focus sur les zones aux changements significatifs??

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE,message=FALSE}

tablecarto <- "dm_vecteurs.canton" 
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" 
variablecarto <- c("diff15","diff14","diff24","diff25") #variable à spatialiser
l_legend <- "Evolution des teneurs en C"#label de la variable
nclasse <- 3 #Nombre de classes de valeurs pour la cartographie
style_classe <- "fixed" #"pretty"#"jenks","fixed"
couleur <- "Spectral"#nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
nomfichier <- "Evolu_c"

carto(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend,repsortie,nomfichier,dept=FALSE,reg=FALSE,nrowlayout=2,ncollayout=2,position="bottom",ggsaveheight=10,ggsavewidth=10)  
```

```{r map_carbo_fr, echo = F, results = 'asis'}
# Pour insérer l'image
fichiers <- paste(repsortie,nomfichier,sep="")
cat(paste("![](",fichiers,")",sep=""))
```

## Analyse du nombre d'évolution significative par canton

Dans la figure ci-dessous,

Analyser la figure en la confrontant avec des graphiques similaires basés sur les données du RA et de CLC.
Ce serait intéressant de développer un indice de changement d'occupation du sol pour faciliter les analyses.

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE,fig.height=6, fig.width=6,fig.cap = fig$cap("histo_evolution",""),fig.align="center"}
# Histogramme des valeurs 

# Sélection des cantons aux diminutions significatives
bdatdiff <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff),]

# Sélection
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
periodetud <- c("14","24","15","25")
bdatdiff <- bdatdiff[(bdatdiff$period %in% periodetud) & bdatdiff$zonage_simple != "H" & bdatdiff$zonage_simple != "G" & bdatdiff$zonage_simple != "F", ]
bdatdiff$diff <- as.factor(bdatdiff$diff)

histo_regelevage <- ggplot(bdatdiff,aes(diff,fill=zonage_cplt)) + geom_bar() + facet_wrap(~ period)+
                    scale_fill_brewer(palette = 'Paired',name="Zones d'élevage")+
                    xlab("Classe d'évolution des teneurs en carbone organique")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11))    
                    #geom_bar(position="dodge")
histo_regelevage
```
Présenter dans le détail les histogrammes `r fig$ref("histo_evolution",link=TRUE)`. Possibilité de comparer le nbr de canton en augmentation et en diminution par période analysées et ensuite développer une analyse par classe de diminution ou d'augmentation. Par exemple, il y a quasiment autant de canton ayant des teneurs en C en augmentation et en diminution entre les périodes 1994-1999 et 2010-2014.


```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Histogramme des valeurs 
# Revoir, pas très bien visible

# Sélection des cantons aux diminutions significatives
bdatdiff_classe <- melted.bdatdiff[complete.cases(melted.bdatdiff$diff) & melted.bdatdiff$diff !="Non significatif",]

# Sélection
periodetud <- c("14","24","15","25")
bdatdiff_classe <- bdatdiff_classe[(bdatdiff_classe$period %in% periodetud), ]
bdatdiff_classe$diff <- as.factor(bdatdiff_classe$diff)
#
ggplot(bdatdiff_classe,aes(diff,fill=nom_region)) + geom_bar(position="dodge") + facet_wrap(~ period) + 
                    xlab("Classe d'évolution des teneurs en carbone organique")+ylab("Nombre de canton")+
                    theme(plot.title = element_text(size = 14, face = "bold"), 
                    text = element_text(size = 12),
                    axis.title = element_text(face="bold"),
                    axis.text.x=element_text(size = 11))                      
```



Dans la figures ci-dessous, on peut observer : 
A faire

```{r,highlight=TRUE,eval=TRUE,fig.height=5, fig.width=8,fig.cap = fig$cap("bar_prairie","Histogramme à commenter"),fig.align="center"}
# Reproduire ce type de graphe par stratification
bar_prairie <- ggplot(bdatdiff_classe,aes(diff,fill=diff_var_prairie1970_2010)) + geom_bar() + facet_wrap(~ period)
bar_prairie

# Faire une sélection sur les principales années 


periodetud <- c("14","24","15","25")
bdatdiff_classe <- melted.bdatdiff[(melted.bdatdiff$period %in% periodetud),]
bdatdiff_classe$diff <- as.factor(bdatdiff_classe$diff)
bdatdiff_classe$diffmedian <- as.numeric(bdatdiff_classe$diffmedian)

bdatponct, aes(x=occupation, y=c, color=occupation, group=occupation)


ggplot(bdatdiff_classe,aes(x=diff_var_prairie1970_2010,y=diffmedian)) +
            geom_boxplot()+
            geom_point(position=position_jitter(width=0.3), alpha=0.1) +
            facet_wrap(~period)
# Voir cette figure et rajouter color=diff,




            #scale_color_manual(values=colors,name="Années")+
            #geom_smooth(aes(x=as.integer(annees),y=value,color=nom_region,fill=nom_region),method=loess)+
            scale_x_discrete("Périodes")+scale_y_continuous("Teneur en carbone (g/kg)")+
            theme(plot.title = element_text(size = 14, face = "bold"), 
                  text = element_text(size = 12),
                  axis.title = element_text(face="bold"),
                  axis.text.x=element_text(size = 11))+
            coord_cartesian(ylim = ylim1*1.05)

```

Dans cette figure, on s'intéresse particulièrement aux différences entre les périodes 1994-1999 et 2004-2009 et on regarde de plus près la stratification par grande région agricole.

```{r,highlight=TRUE,eval=TRUE,fig.height=5, fig.width=8,fig.cap = fig$cap("histo_double","Histogramme à commenter"),fig.align="center"}
# On s'intéresse à la période 24
# Pour 
p1 <- ggplot(bdatdiff_classe[bdatdiff_classe$period %in% "24" & bdatdiff_classe$zonage_cplt %in% c("A","B1","B2","C1","C2","D","E1","E2"),],aes(diff,fill=diff_var_prairie1970_2010)) + geom_bar() + facet_wrap(~ zonage_cplt)

p2 <- ggplot(bdatdiff_classe[bdatdiff_classe$period %in% "24" & bdatdiff_classe$zonage_cplt %in% c("A","B1","B2","C1","C2","D","E1","E2"),],aes(diff,fill=diff_var_sfp1970_2010)) + geom_bar() + facet_wrap(~ zonage_cplt)

# Ici, regarder les prairies et la sfp, il y a une relation entre ces deux variables. Certes, les prairies ont chuté en Bretagne, mais les modes de production ont évolués et ont laissé place à la stabulation. Les sfp ont augmentée...
p.ass <- grid.arrange(p1,p2,ncol=2)
```

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE}
ggplot(bdatdiff_classe[bdatdiff_classe$period %in% "24" & bdatdiff_classe$zonage_cplt %in% c("A","B1","B2","C1","C2","D","E1","E2"),],aes(diff,fill=classe2_var_c1970_2010)) + geom_bar() + facet_wrap(~ zonage_cplt)

ggplot(bdatdiff_classe[bdatdiff_classe$period %in% "24" & bdatdiff_classe$zonage_cplt %in% c("A","B1","B2","C1","C2","D","E1","E2"),],aes(diff,fill=classe2_var_sfp1970_2010)) + geom_bar() + facet_wrap(~ zonage_cplt)


# Sélection de la zone d'élevage B
bdatdiff_B <- bdatdiff[bdatdiff$zonage_simple %in% "B",]
ggplot(bdatdiff_B,aes(diff,fill=nom_region)) + geom_bar(position="dodge") + facet_wrap(~ period)


```

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE}
# Voir les graphiques de "différence" réalisés durant le M1
# Rajouter les types de climat ou autre niveau de stratification pour voir l'influence de ces régions sur les pertes 
# Voir également pour rajouter ces données sur une table au format melt
plot(dcast.bdat$corgox_med9599,dcast.bdat$varcorgox_med0004_9599)

plot(dcast.bdat$corgox_med9599,dcast.bdat$diffcorgox_med0004_9599)

# Calculer les évolutions
varcorgox_med0004_9599 
varcorgox_med0509_9599
varcorgox_med0509_9094
varcorgox_med0004_9094
diffcorgox_med0004_9599
diffcorgox_med0509_9599
diffcorgox_med0509_9094
diffcorgox_med0004_9094

test <- dcast.bdat[,c("corgox_med9094","corgox_med9599","corgox_med0004","corgox_med0509")]
ggpairs(test)

```

# Analyse sur les régions d'élevage B, C et D

## Histogrammes
```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Histogramme des valeurs 
periodetud <- c("14","24","15","25")
# Sélection des cantons aux diminutions significatives et des zones B,C et D
bdatdiff <- subset(melted.bdatdiff,diff!="Non significatif")
bdatdiffBCD <- bdatdiff[(bdatdiff$period %in% periodetud) & bdatdiff$zonage_simple %in% c("B","C","D"), ]

# Sélection
bdatdiff$diff <- as.factor(bdatdiff$diff)
ggplot(bdatdiffBCD,aes(diff,fill=zonage_simple)) + geom_bar(position="dodge") + facet_wrap(~period)

```

## Graphiques de correlation
Rajouter les droites de régressions 
Rajouter les variation climatiques

Figure ci-dessous à commenter pour aller plus loin.

```{r,highlight=TRUE,eval=FALSE,echo=FALSE,warning=FALSE}
# GET EQUATION AND R-SQUARED AS STRING
# SOURCE: http://goo.gl/K4yh


x <- "hpluie_an"
y <- "corgox_medequi9094"

lm_eqn <- function(df,x,y){
    m <- lm(x ~ y, df);
    eq <- substitute(italic(x) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(coef(m)[1], digits = 2), 
              b = format(coef(m)[2], digits = 2), 
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));                 
}

# Stratifier les plots par les régions et autres facteurs (voir pour la classification climatique)
ggplot(dcast.bdat, aes(hpluie_an, corgox_medequi9094,shape=factor(classe_p_prairie2000))) +
  geom_point(aes(colour = factor(classe_p_prairie2000)), size = 3) +
  geom_point(colour="grey10", size = 1.5) + geom_smooth(method='lm',formula=y~x) #+ facet_wrap(~ zonage_cplt) + 


geom_text(data=eq,aes(x = 25, y = 300,label=V1), parse = TRUE, inherit.aes=FALSE)



ggplot(dcast.bdat, aes(hpluie_an, corgox_medequi9094)) +
  geom_point(aes(colour = factor(classe_p_prairie2000)), size = 3) +
  geom_smooth(method='lm',formula=y~x) #+ facet_wrap(~ zonage_cplt) + 


geom_smooth(method = "lm", se = FALSE)







# Voir un peu plus G1 (bof, peut d'intérêt. Eventuellement, voir pour une figure synthétique avec une matrice présentant les coef de correlation)
#ggplot(dcast.bdat[dcast.bdat$zonage_cplt %in% "G1",], aes(hpluie_an, corgox_medequi9094,shape=factor(classe_p_prairie2000))) +
 # geom_point(aes(colour = factor(classe_p_prairie2000)), size = 4) +
  #geom_point(colour="grey10", size = 1.5)
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Plot of the change in the cantonal medians of soil OC versus the cantonal medians of soil OC content averaged over the two extreme periods (1990–1994 and 2000–2004). Triangles are significant changes. Circles are non-significant changes. Line is the regression (r 2 = 0.15) between the change in the cantonal medians of soil OC and the cantonal medians of soil OC averaged over the two extreme periods.

# Ici, on reprend la figure 7 de Saby2008

dcast.bdat$meancorgox9599_0409 <- rowMeans(cbind(dcast.bdat$corgox_medequi9599,dcast.bdat$corgox_medequi0409),na.rm=TRUE)
ggplot(dcast.bdat, aes(meancorgox9599_0409,diffmedian24,shape=factor(diff24))) +
  geom_point(aes(colour = factor(diff24)), size = 4) +
  geom_point(colour="grey10", size = 1.5) + facet_wrap(~ zonage_cplt)

```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
#Median of baseline soil OC content (first period) versus change in median of soil OC values over the whole survey. Triangles are significant changes. Circles are non-significant changes. Line is the regression (r 2 = 0.24) between median of baseline SOC (1990–1994) and significant changes

# Ici, on reprend la figure 5 de Saby2008
# Revoir ces figures, problème avec les données
dcast.bdat$meancorgox9599_0509 <- rowMeans(cbind(dcast.bdat$corgox_medequi9599,dcast.bdat$corgox_medequi0509),na.rm=TRUE)

ggplot(dcast.bdat, aes(meancorgox9599_0409,diffmedian24,shape=factor(diff24))) +
  geom_point(aes(colour = factor(diff24)), size = 4) +
  geom_point(colour="grey10", size = 1.5)# + facet_wrap(~ zonage_cplt)


ggplot(dcast.bdat, aes(altimean,meancorgox9599_0509)) +
  geom_point(aes(colour = factor(diff24)), size = 4) +
  geom_point(colour="grey10", size = 1.5)# + facet_wrap(~ zonage_cplt)



```



```{r,eval=FALSE}
# Voir le développement de ce type de graphique
dcast.bdatBCD <- dcast.bdat[dcast.bdat$zonage_simple %in% c("B","C","D"),]

ggplot(dcast.bdatBCD, aes(var_ugb8810, diffmedian15,shape=factor(diff15))) +
  geom_point(aes(colour = factor(diff15)), size = 2) +
  geom_point(colour="grey10", size = 1.5)


ggplot(dcast.bdatBCD, aes(var_sth1970_2010, diffmedian15,shape=factor(diff15))) +
  geom_point(aes(colour = factor(diff15)), size = 2) +
  geom_point(colour="grey10", size = 1.5)


ggplot(melted.bdatdiff, aes(var_cereale1970_2010, diffmedian15,shape=factor(diff15))) +
  geom_point(aes(colour = factor(diff15)), size = 2) +
  geom_point(colour="grey10", size = 1.5)
```













