---
title: "Traitement des données de la BDAT"
author: "Jean-Baptiste Paroissien"
date: "21/12/2016"
output:
  html_notebook:
    toc: true
    fig_caption: true
    highlight: zenburn
    number_sections: yes
    theme: spacelab
---


```{r setup, include=TRUE,warning=FALSE,echo=FALSE,message=FALSE,eval=TRUE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/media/sf_GIS_ED/Dev/")
# Chargement des librairies
library(RODBC);library(gdata);library(fields);library(stringr);library(ggplot2);library(rgdal);library(maptools);library(RColorBrewer);library(classInt);library(devtools);
library(Hmisc);library(gridExtra);library(mapproj);library(wesanderson);library(FactoMineR);library(knitr);library(wesanderson);library(pander);library(GGally);library(factoextra)

# Définition des principaux répertoires de travail
masterrep <- "/media/sf_GIS_ED/Dev/"#Chemin initial vers le répertoire de travail (à changer si changement d'arborescence)

repfonctions <- paste(masterrep,"Scripts/master/Fonctions/R/",sep="")
repagreste <- paste(masterrep,"Data/Vegetation_Occup/Agreste/Disar/",sep="")
repsortie <- paste(masterrep,"Scripts/master/Fichiers_suivis/Traitements/Fichiers/",sep="") #répertoire de sortie pour des différents fichiers
# Mise en place de la connexion ODBC
loc <- odbcConnect("solelevage",case="postgresql", believeNRows=FALSE)

# Chargement de la fonction cartoperiod
source(paste(repfonctions,"cartoperiod.R",sep=""))

# Fonction très pratique pour remplacer une suite de charact?res par une autre
gsub2 <- function(pattern, replacement, x, ...) {
  for(i in 1:length(pattern))
    x <- gsub(pattern[i], replacement[i], x, ...)
  x
}
```

```{r, tidy=FALSE,eval=TRUE}
Sys.Date()
sessionInfo()
```

# Objectifs

Ce fichier de suivi a pour but de centraliser l'ensemble des analyses temporelles d'une variable pédologique de la BDAT. Ce travail est organisé de la façon suivante :

- Analyse des histogrammes de fréquence et tests statistiques pour chacune des périodes de temps analysées,
- Représentation cartographique par canton,
- Analyse des facteurs explicatifs. 

# Préparation des données et chargement de la table de travail

Les données de la BDAT sont ré-organisées pour faciliter les traitements statistiques et la production de graphique. La fonction `melt` est utilisée pour transformer les données d'un format "large" à un format "long".
En complément, les évolutions des teneurs pour les différentes périodes analysées sont calculées.

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" # Configuration de la connexion vers le PostGIS
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- c("corgox_med") # Variable à analyser 
period <- c("9094","9599","0004","0509")
mapcanton <- readOGR(dsn = dsn, "dm_vecteurs.canton")
id <- c("code_canton","code_reg","nom_region","typo_clim") #Nom de l'identifiant


cpt <- 0
for(p in period){
  cpt <- cpt + 1
  for(a in  period){
    if(a==p){next}else{}
    print(paste(p,"-",a,sep=""))
    }
}

# Calcul de l'évolution des teneurs en carbone pour différentes périodes données (en pourcentage)

evolb <- c("9599","9599","9094","9094")
evola <- c("0004","0509","0509","0004") 

cpt <- 0
for(a in evola){
  cpt <- cpt + 1
  
  b <- evolb[cpt]
  
  var_variable <- paste("var",varia,a,"_",b,sep="")

  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = ((",table_dm,".",varia,a," - ",table_dm,".",varia,b,")/",table_dm,".",varia,b,")*100",sep=""))
    
  # Ajout d'un commentaire sur la nouvelle colonne crée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Evolution du carbone organique entre ",a," et ",b," (en pourcentage).\';",sep="")))
}
	
# Calcul de l'évolution des teneurs en carbone (différence)
evolb <- c("9599","9599","9094","9094")
evola <- c("0004","0509","0509","0004") 

cpt <- 0
for(a in evola){
  cpt <- cpt + 1
  
  b <- evolb[cpt]
  
  var_variable <- paste("diff",varia,a,"_",b,sep="")

  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = (",table_dm,".",varia,a," - ",table_dm,".",varia,b,")",sep=""))
    
  # Ajout d'un commentaire sur la nouvelle colonne crée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Différence du carbone organique entre ",a," et ",b,".\';",sep="")))
}

# Boucle pour séparer l'année du nom de la variable étudiée
cpt <- 0
for(i in varia){
  print(i)
  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  
  stats.canton <- mapcanton[,c(id,variaperiod)]
  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton@data,id.vars=id)
  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.[0-9]+',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("annees",i) #revoir la sélection de ces colonnes
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"annees"), by.y=c(id,"annees"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdat <- melt(data=melt.canton,id.vars=c(id,"annees"))
melted.bdat$annees <- as.character(melted.bdat$annees)
melted.bdat$typo_clim <- as.factor(melted.bdat$typo_clim)

# Enregistrement dans le schema dm_traitements
tablename <- paste("dm_traitements.","melted_bdat",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdat,tablename=tablename)
```

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Chargement des paramètres
period <- c("9094","9599","0004","0509")
variable <- "corgox_med"
xlabel <- "Carbone organique (g/kg)"
ylabel <- "Fréquence"
nperiod <- length(period)
colors <- wes_palette("Zissou",nperiod,type="continuous")

melted.bdat <- sqlQuery(loc,paste("select value,variable,annees,code_reg,nom_region,typo_clim from dm_traitements.melted_bdat",sep=""),as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE))
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))

melted.bdat <- melted.bdat[complete.cases(melted.bdat$typo_clim),]
melted.bdat$annees <- factor(melted.bdat$annees,levels=period)
```


## Chargement des données et des principaux paramètres d'étude

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE}
# Chargement des paramètres
period <- c("9094","9599","0004","0509")
variable <- "corgox_med"
xlabel <- "Carbone organique (g/kg)"
ylabel <- "Fréquence"
nperiod <- length(period)
colors <- wes_palette("Zissou",nperiod,type="continuous")

melted.bdat <- sqlQuery(loc,paste("select value,variable,annees,code_reg,nom_region,typo_clim from dm_traitements.melted_bdat",sep=""),as.is=c(FALSE,TRUE,TRUE,TRUE,TRUE,TRUE))
dcast.bdat <- sqlQuery(loc,paste("select * from dm_vecteurs.canton",sep=""))

melted.bdat <- melted.bdat[complete.cases(melted.bdat$typo_clim),]
melted.bdat$annees <- factor(melted.bdat$annees,levels=period)
```

# Etape 1 : Analyse des teneurs par période

Cette première étape permet d'analyser les différences entre chacune des périodes. Les rendus de cette première étape sont les suivants :

- statistiques descriptives et courbes de fréquences cumulées ;
- boxplot accompagnés de tests de « significacité » des différences entre les périodes (probablement test Wilkcoxon).

## Fréquences cumulées

### France entière et par type de climat

La figure ci-dessous présente les courbes de fréquences cumulées pour la france entière. La figure montre un décalage des courbes des périodes 2000-2004 et 2005-2009 vers des valeurs plus faibles. Ces deux périodes se distinguent clairement des périodes de 1990-1994 et 1995-1999 qui sont plus rapprochées. Ces observations mettent en évidence une diminution des teneurs en carbone entre les périodes 1990-1999 et les périodes de 2000-2009. D'après la figure, ce sont les teneurs médianes les plus concernées par cette baisse de teneur.

[comment]: <> (Voir également http://elcep.legtux.org/?cat=2 pour une autre représentation graphique)

```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE,message=FALSE}
cdf <- ggplot(melted.bdat, aes(x=value))+
       stat_ecdf(aes(colour=annees))+
       scale_color_manual(values=colors, 
                          name="Années")+
       scale_x_continuous(xlabel)+scale_y_continuous(ylabel)+
       theme(plot.title = element_text(size = 14, face = "bold"), 
             text = element_text(size = 12),
             axis.title = element_text(face="bold"),
             axis.text.x=element_text(size = 11))
cdf
```

Faire un commentaire par type de climat
```{r,highlight=TRUE,eval=TRUE,echo=FALSE,warning=FALSE,message=FALSE}
cdf <- ggplot(melted.bdat, aes(x=value))+
       facet_wrap(~typo_clim)+
       stat_ecdf(aes(colour=annees))+
       scale_color_manual(values=colors, 
                          name="Années")+
       scale_x_continuous(xlabel)+scale_y_continuous(ylabel)+
       theme(plot.title = element_text(size = 14, face = "bold"), 
             text = element_text(size = 12),
             axis.title = element_text(face="bold"),
             axis.text.x=element_text(size = 11))
cdf
```

## Statistiques descriptives

### Tableaux

Les statistiques par années sont présentées dans le tableau ci-dessous.

```{r,highlight=TRUE,eval=TRUE, eval=TRUE, message=FALSE, warning=FALSE, highlight=TRUE}
# Résumé des statistiques 

bdatsummary <- apply(melted.bdat["value"],2, function(x) tapply(x, melted.bdat[,"annees"],summary))
bdatsummary <- lapply(bdatsummary, do.call, what = rbind)

pander(bdatsummary[[1]])

```

On pourra voir pour faire un tableau par années + par région???Celà permettra d'identifier les régions les plus affectées par les évolutions des teneurs en C.

### Tests statistiques

```{r,highlight=TRUE,eval=FALSE}
tt <- pairwise.wilcox.test(melted.bdat[,"value"], melted.bdat[,"annees"])
pander(c(tt[1],tt[2],tt[3]))
=======

### Tests statistiques

```{r,highlight=TRUE,eval=FALSE}
pander(pairwise.wilcox.test(melted.bdat[,"value"], melted.bdat[,"annees"]))
>>>>>>> 3dba389cfdbe7ab14a8d09146cfbd8cb38c6d43c
```
### Boxplot

Pour les boxplot, présenter les différents niveaux de stratification possibles et revoir l'ordre de présentation des années (revert x??)
Egalement, faire une cartographie des données climato

#### France 
```{r,highlight=TRUE,eval=TRUE}
p <- ggplot(melted.bdat, aes(x=annees,y=value,col=annees)) + 
  geom_violin(trim=FALSE)+
  geom_boxplot(width=0.1, fill="white")+
  scale_color_manual(values=colors,name="Années")+
  scale_x_discrete("Années")+scale_y_continuous("Teneur en carbone (g/kg)")+
  theme(plot.title = element_text(size = 14, face = "bold"), 
        text = element_text(size = 12),
        axis.title = element_text(face="bold"),
        axis.text.x=element_text(size = 11))
p  
ggsave(p,file = paste(repsortie,"boxplotbdat.png",sep=""), width = 10, height = 10)  
```


#### Stratification par type de climat

```{r,highlight=TRUE,eval=TRUE}
p <- ggplot(melted.bdat) +
            geom_boxplot(aes(x=annees,y=value,col=typo_clim))+
            #scale_color_manual(name="Années")+
            scale_x_discrete("Années")+scale_y_continuous("Teneur en carbone (g/kg)")+
            theme(plot.title = element_text(size = 14, face = "bold"), 
                  text = element_text(size = 12),
                  axis.title = element_text(face="bold"),
                  axis.text.x=element_text(size = 11))
p  
ggsave(p,file = paste(repsortie,"boxplotbdat_typoclim.png",sep=""), width = 15, height = 10)  
```

```{r,highlight=TRUE,eval=TRUE}
ylim1 <- boxplot.stats(melted.bdat$value)$stats[c(1, 5)]

p <- ggplot(melted.bdat) +
            geom_boxplot(aes(x=annees,y=value,col=annees),outlier.shape = NA,outlier.size=NA)+
            facet_wrap(~typo_clim,scales="free")+
            scale_color_manual(values=colors,name="Années")+
            #geom_smooth(aes(x=as.integer(annees),y=value,color=nom_region,fill=nom_region),method=loess)+
            scale_x_discrete("Années")+scale_y_continuous("Teneur en carbone (g/kg)")+
            theme(plot.title = element_text(size = 14, face = "bold"), 
                  text = element_text(size = 12),
                  axis.title = element_text(face="bold"),
                  axis.text.x=element_text(size = 11))+
            coord_cartesian(ylim = ylim1*1.05)
p  
ggsave(p,file = paste(repsortie,"boxplotbdat_typoclim2.png",sep=""), width = 10, height = 10)  
```

### Graphique de correlation

```{r,highlight=TRUE,eval=FALSE}
# Voir les graphiques de "différence" réalisés durant le M1
# Rajouter les types de climat ou autre niveau de stratification pour voir l'influence de ces régions sur les pertes 
# Voir également pour rajouter ces données sur une table au format melt
plot(dcast.bdat$corgox_med9599,dcast.bdat$varcorgox_med0004_9599)

plot(dcast.bdat$corgox_med9599,dcast.bdat$diffcorgox_med0004_9599)

# Calculer les évolutions
varcorgox_med0004_9599 
varcorgox_med0509_9599
varcorgox_med0509_9094
varcorgox_med0004_9094
diffcorgox_med0004_9599
diffcorgox_med0509_9599
diffcorgox_med0509_9094
diffcorgox_med0004_9094

test <- dcast.bdat[,c("corgox_med9094","corgox_med9599","corgox_med0004","corgox_med0509")]
ggpairs(test)
```

## Cartographie

Dans cette partie, des cartes peuvent être produites selon plusieurs arguments (reste à définir) :

- stratification spatiale (région ou autre entités spatiales),
- stratification temporelle (groupe de plusieurs années).

```{r,highlight=TRUE,eval=FALSE}
# Paramètres #################
tablecarto <- "dm_vecteurs.canton" #Nom de la table utilisée pour la cartographie (table postgis)
dsn <- "PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'" #Paramètres de connexion vers la base de données
period <- c("9094","9599","0004","0509") #
variable <- "corgox_med"
variablecarto <- paste(variable,period,sep="")#variables à cartographier
nclasse <- 5 
style_classe <- "quantile"#Nombre de classes de valeurs pour la cartographie
couleur <- "Spectral" #Nom de la palette couleur (selon RColorBrewer)display.brewer.all() pour connaître les différentes palettes
l_variable <- "Teneur en carbone organique (g/kg)" #label de la variable
nomfichier <- "corgoxmed_period" #Nom du fichier

cartoperiod(dsn,tablecarto,variablecarto,nclasse,style_classe,couleur,l_legend,repsortie,nomfichier,dept=FALSE,reg=FALSE)
```

# Analyse des facteurs explicatifs

Environ `r round(res.pca$eig[1,2]+res.pca$eig[2,2])` pourcent de l'information est contenu dans les deux premiers axes.

```{r,highlight=TRUE,eval=FALSE}
# Sélection des variables de travail
variables <- c("corgox_med9094","ugbgrani_sau2010","ttemp_an","jfroids_an","jchauds_an","hpluie_an","ugbta1988","p_prairie1970","p_prairie1979","p_prairie1988","p_sth1970","p_sth1979","p_sth1988","p_sfp1970","p_sfp1979","p_sfp1988","p_mf1970","p_mf1979","p_mf1988","p_c1970","p_c1979","p_c1988")

dcast.bdat_variables <- dcast.bdat[,variables]

res.pca <- PCA(dcast.bdat_variables, graph = FALSE)
eigenvalues <- res.pca$eig
head(eigenvalues[, 1:2])
fviz_screeplot(res.pca, ncp=10)

fviz_pca_var(res.pca, col.var="contrib") +
scale_color_gradient2(low="white", mid="blue", 
                  high="red", midpoint=50) + theme_minimal()
```



# Modélisation avec GBM

```{r,highlight=TRUE,eval=FALSE}
vNames <- c("c",Rcovar,"occup")

### GBM Model parameters ###

# interaction.depth : The maximum depth of variable interactions. 1 implies an additive model, 2 implies a model with up to 2-way interactions, etc
# .n.trees : The total number of trees to fit. This is equivalent to the number of iterations and  the number of basis functions in the additive expansion.
# shrinkage : a shrinkage parameter applied to each tree in the expansion. Also known as the learning rate or step-size reduction.


### Cubist Model parameters ###

#.committees : an integer: how many committee models (e.g.. boosting iterations) should be used

#.neighbors : an integer from 0 to 9: how many instances to use to correct the rule-based prediction? if neighbors is greater than zero, these predictions are adjusted by training set instances nearby using the approach of Qunilan (1993)

# Test des différents combinaison de paramètres
model <- c("gbm","cubist")
idField <- "id"
titre <- "test"

tuneGrid <- list(gbm=expand.grid(.interaction.depth = c(1,5,9,13),.n.trees = c(150,500,1000,1500),.shrinkage = 0.05),cubist=expand.grid(.committees = c(10,50,100),.neighbors = c(1,5,9)))
trControl <- list(gbm=trainControl(method = "cv",p=0.8),cubist=trControl <- trainControl(method = "cv",p=0.8))

crossValidateMachineLearning(titre = titre,fold = fold,model = model,data = "bdatigcs_ponct",transfParam ="log",vNames = vNames,coords = coords,tuneGrid=tuneGrid,trControl=trControl,distance = 0,probs = 0.8,nbl = 1,idField = idField)
```

