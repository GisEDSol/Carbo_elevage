---
title: "Création des données élaborées de la BDAT"
author: "Jean-Baptiste Paroissien"
output:
  html_document:
    toc: yes
    toc_float: yes
    fig_caption: yes
    highlight: zenburn
    number_sections: yes
    theme: spacelab  
---

```{r setup, include=FALSE,eval=FALSE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/Data/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
```

# Objectifs

Ce fichier permet de créer les tables de données de la BDAT utilisables pour le traitement statistique. Deux principaux points sont réalisés :

- Les teneurs en carbone organique et les calculs d'évolution de ces teneurs sont jointes dans la table de travail `dm_vecteurs.canton` pour faciliter la cartographie et l'analyse spatiale des données,
- Plusieurs autres tables sont générées pour les différents travaux demandant un format de table "long".

# Intégration des données de la BDAT vers la table `dm_vecteurs.canton`

## Intégration de la médiane des teneurs en carbone organique par canton (teneurs + effectifs)

### Les teneurs en carbone organique
```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"
#Anciennement corgox_medequi

for(i in period){
  var_variable <- paste("corg_medequiv",i,sep="")
  tableBDAT <- paste("bdat_canton_corgequiv",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.med from(
                      select med,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
  # Ajout d'un commentaire sur la nouvelle colonne créée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Médiane des teneurs en carbone organique après ré-échantillonnage pour la période (toutes méthodes confondues)",i,".\';",sep="")))
}
```

### Les effectifs

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"

for(i in period){
  var_variable <- paste("eff_coox",i,sep="")
  tableBDAT <- paste("bdat_canton_corgequiv",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.eff from(
                      select eff,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
  # Ajout d'un commentaire sur la nouvelle colonne créée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Nombre d\''effectif par canton (toutes méthodes confondues)",i,".\';",sep="")))
}
```

### Les résultats des tests statistiques des différences de teneur en carbone organique

```{r,highlight=TRUE,eval=FALSE}
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("12","13","14","15","23","24","25","34","35","45")
schema <- "bdat"

for(i in period){
  for(v in c("diff","diffmedian")){
  
  var_variable <- paste(v,i,sep="")
  
  tableBDAT <- paste("bdat_canton_corgequiv_comp_",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  if(v=="diff"){
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," text;
                      update ",table_dm,"
                      SET ",var_variable," = s1.diff from(
                      select diff,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
      # Ajout d'un commentaire sur la nouvelle colonne créée
      print(sqlQuery(loc,paste("
      COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Résultat du test de significacité de la différence de la médiane des teneurs en carbone organique au niveau du canton.\';",sep="")))
    
  }else{
    sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.",var_variable," from(
                      select ",var_variable,",canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
      # Ajout d'un commentaire sur la nouvelle colonne créée
      print(sqlQuery(loc,paste("
      COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Pourcentage d évolution de la médiane des teneurs en carbone organique par canton ((medA-medB)/medB))*100 avec B une période antérieure à A.\';",sep="")))
    }
  }
}

```
## Intégration des analyses par type de détermination (teneurs + effectifs)

Même démarche que précédemment. Ci-dessous, les analyses des teneurs en C par type de mesures sont intégrées dans la table `dm_vecteurs.canon`. Les analyses réalisées avec la méthode oxydation humide sont nommée `corgox` et les analyses mesurées avec la méthode combustion sèche `corgco`

### Intégrations des teneurs
```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"

methodo <- c("corgox","corgco")
m_sign <- c("Oxydation humide","Oxydation sèche")
cpt <- 0
for(m in methodo){
  cpt <- cpt + 1
  for(i in period){
    var_variable <- paste(m,i,sep="")
    tableBDAT <- paste("bdat_canton_",m,"_",i,sep="")

    sqlQuery(loc,paste("alter table ",table_dm,"
                        drop column if exists ",var_variable,sep=""))
  
    sqlQuery(loc,paste("alter table ",table_dm,"
                        add column ",var_variable," numeric;
                        update ",table_dm,"
                        SET ",var_variable," = s1.med from(
                        select med,canton
                        from ",schema,".",tableBDAT,") as s1
                        where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
    # Ajout d'un commentaire sur la nouvelle colonne créée
    print(sqlQuery(loc,paste("
    COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Médiane des teneurs en carbone organique après ré-échantillonnage pour la période",i," et pour la méthode ",m_sign[cpt],".\';",sep="")))
  }
}
```
### Intégrations des effefifs par type de méthode

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"

methodo <- c("corgox","corgco")
m_sign <- c("Oxydation humide","Oxydation sèche")
cpt <- 0
for(m in methodo){
  cpt <- cpt + 1
  for(i in period){
    var_variable <- paste("eff_",m,i,sep="")
    tableBDAT <- paste("bdat_canton_",m,"_",i,sep="")

    sqlQuery(loc,paste("alter table ",table_dm,"
                        drop column if exists ",var_variable,sep=""))
  
    sqlQuery(loc,paste("alter table ",table_dm,"
                        add column ",var_variable," numeric;
                        update ",table_dm,"
                        SET ",var_variable," = s1.eff from(
                        select eff,canton
                        from ",schema,".",tableBDAT,") as s1
                        where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
    # Ajout d'un commentaire sur la nouvelle colonne créée
    print(sqlQuery(loc,paste("
    COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Nombre d\''effectif par canton pour la période",i," et pour la méthode ",m_sign[cpt],".\';",sep="")))
  }
}
```

### Les résultats des tests statistiques des différences de teneur en carbone organique par type de méthode

```{r,highlight=TRUE,eval=FALSE}
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("12","13","14","15","23","24","25","34","35","45")
schema <- "bdat"

bdat.bdat_canton_corgox_comp_45
bdat_canton_corgco_comp_23

methodo <- c("corgox","corgco")
m_sign <- c("Oxydation humide","Oxydation sèche")
cpt <- 0
for(m in methodo){
  cpt <- cpt + 1
  for(i in period){
    for(v in c("diff","diffmedian")){
    
    var_variable <- paste(v,"_",m,i,sep="")
  
    tableBDAT <- paste("bdat_canton_",m,"_comp_",i,sep="")
    
    sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
    if(v=="diff"){
      sqlQuery(loc,paste("alter table ",table_dm,"
                        add column ",var_variable," text;
                        update ",table_dm,"
                        SET ",var_variable," = s1.diff from(
                        select diff,canton
                        from ",schema,".",tableBDAT,") as s1
                        where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
      # Ajout d'un commentaire sur la nouvelle colonne créée
      print(sqlQuery(loc,paste("
        COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Résultat du test de significacité de la différence de la médiane des teneurs en carbone organique au niveau du canton pour la méthode ",m_sign[cpt],"\';",sep="")))
    
    }else{
      sqlQuery(loc,paste("alter table ",table_dm,"
                        add column ",var_variable," numeric;
                        update ",table_dm,"
                        SET ",var_variable," = s1.diffmedian",i," from(
                        select diffmedian",i,",canton
                        from ",schema,".",tableBDAT,") as s1
                        where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
        # Ajout d'un commentaire sur la nouvelle colonne créée
        print(sqlQuery(loc,paste("
        COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Différence entre la période A et la période B (g/kg) pour la méthode de mesure ",m_sign[cpt],".\';",sep="")))
      }
    }
  }
}

```
## Intégration des données texturales

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- "9009"
schema <- "bdat"
vpedo <- c("argi_med","sabt_med")

signification <- c("taux d\''argile","taux de sable")

cpt <- 0
for(i in vpedo){
  cpt <- cpt + 1
  tableBDAT <- paste("bdat_canton_",period,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",i,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",i," numeric;
                      update ",table_dm,"
                      SET ",i," = s1.",i," from(
                      select ",i,",code_canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.code_canton::text",sep=""))

  # Ajout d'un commentaire sur la nouvelle colonne créée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",i," IS \'Médiane du ",signification[cpt]," (g/kg) calculée sur 1990-2009.\';",sep="")))
}
```

# Création des tables de travail au format "long" 

## Intégration des teneurs en carbone organique

Les données de la BDAT sont ré-organisées pour faciliter les traitements statistiques et la production de graphiques. La fonction `melt` est utilisée pour transformer les données d'un format "large" à un format "long". Deux tables sont créées : 

- `dm_traitements.melted.bdat` : table des valeurs des médianes teneurs en carbone organique
- `dm_traitements.melted_bdatdiff` : table des valeurs de différences des teneurs en carbone organique entre plusieurs périodes.

**Important :** La création de ces tables nécessite le lancement de plusieurs scripts au préalable : `FS_bdd_brute.Rmd`,`FS_bdd_elab_climat.Rmd`,`FS_bdd_elab_ra.Rmd` et `FS_bdd_elab_clc.Rmd`.

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- c("corgox","corgco","corg_medequiv","eff_coox","eff_corgox","eff_corgco") # Variable à analyser test
variaoccup <- c("p_sth","p_sfp","p_prairie","p_cop","p_c")
#id_class <- apply(expand.grid(varia,period), 1, paste, collapse="")
periodoccup <- c("1970","1979","1988","2000","2010")
id_class <- apply(expand.grid(variaoccup,periodoccup),1, function(x){paste("classe_",x[1],x[2],sep="")})
id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean","mat11",id_class) #Nom des identifiants

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))

# Boucle pour séparer l'année du nom de la variable étudiée

cpt <- 0
for(i in varia){
  if(i=="corgco"|i=="eff_corgco"){
    period <- c("9599","0004","0509","1014")
  }else{period <- c("9094","9599","0004","0509","1014")}

  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  
  stats.canton <- mapcanton[,c(id,variaperiod)]

  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton,id.vars=id)
  
  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.[0-9]+',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("annees",i)
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"annees"), by.y=c(id,"annees"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdat <- melt(data=melt.canton,id.vars=c(id,"annees"))
melted.bdat$annees <- as.character(melted.bdat$annees)
melted.bdat$typo_clim <- as.factor(melted.bdat$typo_clim)

# Enregistrement dans le schema dm_traitements  
tablename <- paste("dm_traitements.","melted_bdat",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdat,tablename=tablename)

# Ajout de quelques commentaires
print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".value IS \'Médiane des teneurs en carbone organique et les effectifs après ré-échantillonnage sur l\''ensemble des périodes et les différentes méthodes de mesure.\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".annees IS \'Périodes d\''analyse des teneurs en carbone organique.\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".variable IS \'Type de méthode de mesure des teneurs en carbone organique et les effectifs (corgox:oxydation humide; corgco:combustion sèche; corg_medequiv:corgox+corgco; eff_corgox:effectif pour la méthode corgox; eff_corgco:effectif pour la méthode corgco; eff_coox:effectif pour les méthodes méthodes corgox+corgco.\';",sep="")))

```

## Intégration des résultats de l'évolution des teneurs en carbone organique dans une table au format long

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- c("diffmedian","diff","diff_corgox","diff") # Préfixe de la variable à intégrer (varia+period)
variaoccup <- c("sth","sfp","prairie","c","mf","cop")
periodra <- c("1970","1979","1988","2000","2010")
# Classes d'occupation du sol
id_class <- apply(expand.grid(variaoccup,periodra),1,function(x){paste("classe_p_",x[1],x[2],sep="")})

## Variables associées aux changements d'occupation du sol

p_variable <- c("sth","c","sfp","mf","prairie","cop")
periodref_ra <- c("2010","2000")
period_ra <- c("1970","1979","1988","2000")
id_varclass <- apply(expand.grid(p_variable,period_ra,periodref_ra),1, function(x){paste("classe_var_",x[1],x[2],"_",x[3],sep="")})
id_varclass <- id_varclass[1:(length(id_varclass)-length(variaoccup))] # Ici, on supprime les dernières combinaisons représentant une différence 2000-2000
#
id_diff <- apply(expand.grid(p_variable,period_ra,periodref_ra),1, function(x){paste("diff_var_",x[1],x[2],"_",x[3],sep="")})
id_diff <- id_diff[1:(length(id_diff)-length(variaoccup))]# Ici, on supprime les dernières combinaisons représentant une différence 2000-2000

id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean","mat11",id_class,id_diff,id_varclass)

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))
#mapcanton <- sqlQuery(loc,paste("select ",paste(id,collapse=","),",",paste(variaperiod,collapse=",")," from ",table_dm,sep=""))

# Boucle pour séparer les périodes analysées du nom de la variable étudiée

methodo <- c("","corgox")#,"corgco") 
cpt <- 0
for(m in methodo){
  cpt <- cpt + 1
  if(m=="corgco"){
    period <- c("23","24","34","35","45")
}else{
  period <- c("12","13","14","15","23","24","25","34","35","45")
}

  if(m==""){
    varia <- c("diffmedian","diff")
    }else{
      varia <- c(paste("diffmedian_",m,sep=""),paste("diff_",m,sep=""))
  }
  print(varia)

  for(i in varia){
    variaperiod <- paste(i,period,sep="")  
    stats.canton <- mapcanton[,c(id,variaperiod)]

    # Modification de la structure de la table
    stats.canton <- melt(data=stats.canton,id.vars=id)

    # Extraction de l'année et renommage des colonnes
    stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.',stats.canton[,"variable"]))))
    colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("period",i) #revoir la sélection de ces colonnes
    
    if(cpt==1){
      # Construction de la première table
      melt.canton <- stats.canton
    }else{
      # Ajout à chaque itération de la variable (i)
      melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"period"), by.y=c(id,"period"),all.x=TRUE,all.y=TRUE)
      
    }
  }
}

# Création finale de la table
melted.bdatdiff <- melt.canton
melted.bdatdiff$typo_clim <- as.factor(melted.bdatdiff$typo_clim)

# Enregistrement dans le schéma dm_traitements
tablename <- paste("dm_traitements.","melted_bdatdiff",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdatdiff,tablename=tablename)

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".period IS \'Périodes comparées des teneurs en carbone organique.\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".diffmedian IS \'Différences des teneurs en carbone organique entre deux périodes. Toutes méthodes de mesure confondues (corgox+corgco).\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".diffmedian_corgox IS \'Différences des teneurs en carbone organique entre deux périodes. Méthode de mesure oxydation humide (corgox).\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".diff IS \'Résultat du test statistique de différence des teneurs en carbone organique entre deux périodes (test de Wilcoxon). Toutes méthodes de mesure confondues (corgox+corgco).\';",sep="")))

print(sqlQuery(loc,paste("
COMMENT ON COLUMN ",tablename,".diff_corgox IS \'Résultat du test statistique de différence des teneurs en carbone organique entre deux périodes (test de Wilcoxon). Méthode de mesure oxydation humide (corgox).\';",sep="")))
```

# Création d'une table de travail de données complète

Ici, la table `dm_vecteurs.canton` est dupliquée et filtrée pour un travail basé uniquement sur un nombre de canton ayant des analyses sur l'ensemble de période étudiée. Deux tables tables sont crées. Elles serviront de base pour la création de tables au format long.

- **canton_9014** pour toutes les périodes
- **canton_9514** pour l'exclusion de la première période

## Format large

```{r,highlight=TRUE,eval=FALSE}

sqlQuery(loc,"DROP TABLE IF EXISTS dm_vecteurs.canton_9014")
sqlQuery(loc,"CREATE TABLE dm_vecteurs.canton_9014 as
SELECT *
FROM dm_vecteurs.canton
where corgox9094 is not null and corgox9599 is not null and corgox0004 is not null
and corgox0509 is not null and corgox1014 is not null
")

sqlQuery(loc,"DROP TABLE IF EXISTS dm_vecteurs.canton_9514")
sqlQuery(loc,"CREATE TABLE dm_vecteurs.canton_9514 as
SELECT *
FROM dm_vecteurs.canton
where corgox9599 is not null and corgox0004 is not null
and corgox0509 is not null and corgox1014 is not null
")

```

## Format long

Pour le canton_9014

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton_9014" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- "corgox" # Variable à analyser 
period <- c("9094","9599","0004","0509","1014")
variaoccup <- c("p_sth","p_sfp","p_prairie","p_cop","p_c")
#id_class <- apply(expand.grid(varia,period), 1, paste, collapse="")
periodoccup <- c("1970","1979","1988","2000","2010")
id_class <- apply(expand.grid(variaoccup,periodoccup),1, function(x){paste("classe_",x[1],x[2],sep="")})
id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean","mat11",id_class) #Nom des identifiants

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))

# Boucle pour séparer l'année du nom de la variable étudiée
cpt <- 0
for(i in varia){
  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  
  stats.canton <- mapcanton[,c(id,variaperiod)]

  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton,id.vars=id)
  
  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.[0-9]+',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("annees",i)
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"annees"), by.y=c(id,"annees"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdat <- melt(data=melt.canton,id.vars=c(id,"annees"))
melted.bdat$annees <- as.character(melted.bdat$annees)
melted.bdat$typo_clim <- as.factor(melted.bdat$typo_clim)

# Enregistrement dans le schema dm_traitements  
tablename <- paste("dm_traitements.","melted_bdat_9014",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdat,tablename=tablename)
```

Pour canton_9504
 
```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton_9514" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- "corgox" # Variable à analyser 
period <- c("9599","0004","0509","1014")
variaoccup <- c("p_sth","p_sfp","p_prairie","p_cop","p_c")
#id_class <- apply(expand.grid(varia,period), 1, paste, collapse="")
periodoccup <- c("1970","1979","1988","2000","2010")
id_class <- apply(expand.grid(variaoccup,periodoccup),1, function(x){paste("classe_",x[1],x[2],sep="")})
id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean","mat11",id_class) #Nom des identifiants

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))

# Boucle pour séparer l'année du nom de la variable étudiée
cpt <- 0
for(i in varia){
  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  
  stats.canton <- mapcanton[,c(id,variaperiod)]

  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton,id.vars=id)
  
  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.[0-9]+',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("annees",i)
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"annees"), by.y=c(id,"annees"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdat <- melt(data=melt.canton,id.vars=c(id,"annees"))
melted.bdat$annees <- as.character(melted.bdat$annees)
melted.bdat$typo_clim <- as.factor(melted.bdat$typo_clim)

# Enregistrement dans le schema dm_traitements  
tablename <- paste("dm_traitements.","melted_bdat_9514",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdat,tablename=tablename)

```


