---
title: "Traitement des données de la BDAT"
author: "Jean-Baptiste Paroissien"
output:
  github_document:
    toc: true
    toc_depth: 2
    fig_width: 10
    fig_height: 10
    dev: png
    md_extensions: +autolink_bare_uris+hard_line_breaks+header_attributes+line_blocks+table_captions
---

```{r setup, include=FALSE,eval=TRUE}
# Importation des paramètres de travail
source("/media/sf_GIS_ED/Dev/Scripts/master/Fonctions/R/importparametres.R")
repmaster <- "/media/sf_GIS_ED/Dev/Scripts/master/"
importparametres(repmaster=repmaster,repdata="/media/sf_GIS_ED/Dev/Data/",dsn="PG:dbname='sol_elevage' host='localhost' port='5432' user='jb'")
```

```{r, tidy=FALSE,eval=TRUE}
Sys.Date()
sessionInfo()
```

# Objectifs

Ce fichier permet de créer les tables de données de la BDAT utilisables pour le traitement statistique. Deux principaux points sont réalisés :

- Les teneurs en carbone organique et les calculs d'évolution de ces teneurs sont jointes dans la table de travail `dm_vecteurs.canton` pour faciliter la cartographie et l'analyse spatiale des données,
- Plusieurs autres tables sont générées pour les différents travaux demandant un format de table "long".

# Intégration des données de la BDAT vers la table `dm_vecteurs.canton`

## Intégration de la médiane des teneurs en carbone organique par canton
```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"

for(i in period){
  var_variable <- paste("corgox_medequi",i,sep="")
  tableBDAT <- paste("bdat_canton_corgequiv",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.med from(
                      select med,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
  # Ajout d'un commentaire sur la nouvelle colonne crée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Médiane des teneurs en carbone organique après ré-échantillonnage pour la période ",i,".\';",sep="")))
}
```

## Intégration des effectifs par période

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("9094","9599","0004","0509","1014")
schema <- "bdat"

for(i in period){
  var_variable <- paste("eff",i,sep="")
  tableBDAT <- paste("bdat_canton_corgequiv",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.eff from(
                      select eff,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
  
  # Ajout d'un commentaire sur la nouvelle colonne crée
  print(sqlQuery(loc,paste("
  COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Nombre d\''effectif par canton",i,".\';",sep="")))
}
```




## Intégration des résultats des tests statistiques des différences de teneur en carbone organique

```{r,highlight=TRUE,eval=FALSE}
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
period <- c("12","13","14","15","23","24","25","34","35","45")
schema <- "bdat"

for(i in period){
  for(v in c("diff","diffmedian")){
  
  var_variable <- paste(v,i,sep="")
  
  tableBDAT <- paste("bdat_canton_corgequiv_comp_",i,sep="")
  
  sqlQuery(loc,paste("alter table ",table_dm,"
                      drop column if exists ",var_variable,sep=""))
  
  if(v=="diff"){
  sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," text;
                      update ",table_dm,"
                      SET ",var_variable," = s1.diff from(
                      select diff,canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
      # Ajout d'un commentaire sur la nouvelle colonne crée
      print(sqlQuery(loc,paste("
      COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Résultat du test de significacité de la différence de la médiane des teneurs en carbone organique au niveau du canton.\';",sep="")))
    
  }else{
    sqlQuery(loc,paste("alter table ",table_dm,"
                      add column ",var_variable," numeric;
                      update ",table_dm,"
                      SET ",var_variable," = s1.",var_variable," from(
                      select ",var_variable,",canton
                      from ",schema,".",tableBDAT,") as s1
                      where ",table_dm,".code_canton=s1.canton::text",sep=""))
    
      # Ajout d'un commentaire sur la nouvelle colonne crée
      print(sqlQuery(loc,paste("
      COMMENT ON COLUMN ",table_dm,".",var_variable," IS \'Pourcentage d évolution de la médiane des teneurs en carbone organique par canton ((medA-medB)/medB))*100 avec B une période antérieure à A.\';",sep="")))
    }
  }
}
```

# Création des tables de travail au format "long" 

Les données de la BDAT sont ré-organisées pour faciliter les traitements statistiques et la production de graphiques. La fonction `melt` est utilisée pour transformer les données d'un format "large" à un format "long". Deux tables sont créées : 

- `dm_traitements.melted.bdat` : table des valeurs des médianes teneurs en carbone organique
- `dm_traitements.melted.bdat` : table des valeurs de différences des teneurs en carbone organique entre plusieurs périodes.

**Important :** La création de ces tables nécessite le lancement de plusieurs scripts au préalable : `FS_bdd_brute.Rmd`,`FS_bdd_elab_climat.Rmd`,`FS_bdd_elab_ra.Rmd` et `FS_bdd_elab_clc.Rmd`.

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- "corgox_medequi" # Variable à analyser 
period <- c("9094","9599","0004","0509","1014")
variaoccup <- c("p_sth","p_sfp","p_prairie","p_cop","p_c")
#id_class <- apply(expand.grid(varia,period), 1, paste, collapse="")
periodoccup <- c("1970","1979","1988","2000","2010")
id_class <- apply(expand.grid(variaoccup,periodoccup),1, function(x){paste("classe_",x[1],x[2],sep="")})
id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean",id_class) #Nom des identifiants

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))

# Boucle pour séparer l'année du nom de la variable étudiée
cpt <- 0
for(i in varia){
  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  
  stats.canton <- mapcanton[,c(id,variaperiod)]

  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton,id.vars=id)
  
  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.[0-9]+',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("annees",i)
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"annees"), by.y=c(id,"annees"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdat <- melt(data=melt.canton,id.vars=c(id,"annees"))
melted.bdat$annees <- as.character(melted.bdat$annees)
melted.bdat$typo_clim <- as.factor(melted.bdat$typo_clim)

# Enregistrement dans le schema dm_traitements  
tablename <- paste("dm_traitements.","melted_bdat",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdat,tablename=tablename)

```

## Evolution des teneurs en carbone organique

### Intégration des résultats dans une table au format long

```{r,highlight=TRUE,eval=FALSE}
# Paramètres
table_dm <- "dm_vecteurs.canton" # Nom de la table pour rassembler les calculs (vers le schéma dm_vecteurs)
varia <- c("diffmedian","diff") # Préfixe de la variable à intégrer (varia+period)
period <- c("12","13","14","15","23","24","25","34","35","45")
variaoccup <- c("sth","sfp","prairie","c","mf","cop")
periodra <- c("1970","1979","1988","2000","2010")
# Classes d'occupation du sol
id_class <- apply(expand.grid(variaoccup,periodra),1,function(x){paste("classe_p_",x[1],x[2],sep="")})

## Variables associées aux changements d'occupation du sol

p_variable <- c("sth","c","sfp","mf","prairie","cop")
periodref_ra <- c("2010","2000")
period_ra <- c("1970","1979","1988","2000")
id_varclass <- apply(expand.grid(p_variable,period_ra,periodref_ra),1, function(x){paste("classe_var_",x[1],x[2],"_",x[3],sep="")})
id_varclass <- id_varclass[1:(length(id_varclass)-length(variaoccup))] # Ici, on supprime les dernières combinaisons représentant une différence 2000-2000
#
id_diff <- apply(expand.grid(p_variable,period_ra,periodref_ra),1, function(x){paste("diff_var_",x[1],x[2],"_",x[3],sep="")})
id_diff <- id_diff[1:(length(id_diff)-length(variaoccup))]# Ici, on supprime les dernières combinaisons représentant une différence 2000-2000

id <- c("code_canton","code_reg","nom_region","typo_clim","zonage_simple","zonage_cplt","classe_altimean",id_class,id_diff,id_varclass)

# Lecture de la table dm_vecteurs.canton
mapcanton <- sqlQuery(loc,paste("select * from ",table_dm,sep=""))
#mapcanton <- sqlQuery(loc,paste("select ",paste(id,collapse=","),",",paste(variaperiod,collapse=",")," from ",table_dm,sep=""))

# Boucle pour séparer les périodes analysées du nom de la variable étudiée
cpt <- 0
for(i in varia){
  print(i)
  cpt <- cpt + 1
  variaperiod <- paste(i,period,sep="")  
  stats.canton <- mapcanton[,c(id,variaperiod)]

  # Modification de la structure de la table
  stats.canton <- melt(data=stats.canton,id.vars=id)

  # Extraction de l'année et renommage des colonnes
  stats.canton[,"variable"] <- as.character(unlist(regmatches(stats.canton[,"variable"],gregexpr('[0-9]+.',stats.canton[,"variable"]))))
  colnames(stats.canton)[(length(id)+1):(length(id)+2)] <- c("period",i) #revoir la sélection de ces colonnes
    
  if(cpt==1){
    # Construction de la première table
    melt.canton <- stats.canton
  }else{
    # Ajout à chaque itération de la variable (i)
    melt.canton <- merge(melt.canton,stats.canton, by.x=c(id,"period"), by.y=c(id,"period"),all.x=TRUE,all.y=TRUE)
  }
}

# Création finale de la table
melted.bdatdiff <- melt.canton
melted.bdatdiff$typo_clim <- as.factor(melted.bdatdiff$typo_clim)

# Enregistrement dans le schéma dm_traitements
tablename <- paste("dm_traitements.","melted_bdatdiff",sep="")
sqlQuery(loc,paste("drop table if exists ",tablename,sep=""))
sqlSave(loc,melted.bdatdiff,tablename=tablename)

```